---
title: "clinics"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{clinics}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

```{r setup}
suppressPackageStartupMessages(library(MultiOmics4ImmunAID))
path <- set_environment()
```

# Clinic
```{r clinic}
# Extract items
date <- "20220512"
clin_path <- file.path(path, "clinical", "20220501")
files_raw <- list.files(clin_path)
files_export <- files_raw[grepl("export", files_raw)]
files <- str_split(files_export, "_")
(blocks <- unique(sapply(files, function(i) i[2])))
```

## Clinical
```{r clinical}
clinic <- read_batches()
sapply(clinic, dim)
clinic_tot <- Reduce(rbind, clinic)
clinic_tot <- clean_data(clinic_tot, FALSE)
clinic_code <- read_batches(, "codes")

# plot_bar_mcat(clinic_tot$C_2643_3798, cex = 7, wrap = 50, colors = rev(c(rep("gray", 2), "red", rep("gray", 3), "red", rep("gray", 9))))
# Descriptive plots
diagnose_category(clinic_tot[, "C_2649_3888"], top = 100) %>%
    select(-c(N, rank, variables)) %>%
    dplyr::rename(N = freq)
ggpiestats(clinic_tot, "C_2649_3888", ggtheme = theme_classic(base_size = 22), theme_config = theme_perso())
plot_bar(clinic_tot[, "C_2643_3798"], ggtheme = theme_classic(), theme_config = theme_perso())

# Common subject ID between batches
vars <- lapply(clinic, function(i) as.numeric(as.data.frame(i[, 2])[, 1]))
# vars <- lapply(clinic_code, function(i) as.data.frame(i[, 1])[, 1])
names(vars) <- seq(3)
plot_venn(vars)
(inter <- get_intersection(vars))
# Duplicates are identical ? TRUE
identical(as.data.frame(t(clinic[[1]][23, ])), as.data.frame(t(clinic[[2]][37, ])))
# QC from MS is in clinical ? Nope.
which(str_detect(rownames(clinic), "7174"))

# Create batch variable
n <- sapply(vars, length)
batches <- mapply(function(x, y) rep(x, y), seq(3), n)
t_batch <- cbind(unlist(vars), unlist(batches))
t_batch <- t_batch[-which(duplicated(t_batch[, 1])), ]

# Common subject ID with ELISA
vars_clin <- sort(as.numeric(unlist(vars)))
vars_ms <- list(MS = get_patient_id(ms))
vars_prot <- c(list(ELISA = get_patient_id(elisa)), vars_ms)
vars_rna <- list(RNA = get_patient_id(rna))
vars_clin_rna <- c(list(Clinic = vars_clin), vars_rna)
vars_tot <- c(vars_clin_rna, vars_prot)
vars_tot2 <- c(vars, vars_rna, vars_prot)
plot_venn(vars_prot)
plot_venn(vars_clin_rna)
plot_venn(c(vars_prot, vars_rna))
plot_venn(vars_tot) # N = 30
plot_venn(c(vars_ms, vars_clin_rna)) # N = 78 !
# all included in clinic data
plot_venn(vars_tot2)
plot_venn(c(vars, vars_rna, vars_ms))
# all from clinic batch 1
get_intersection(vars_tot)

# Missing data
# Convert some modalities into NA
var_na <- c("Unknown", "Not applicable", "Unreported (not tested or unknown)", "Not performed")
for (i in var_na) {
    clinic_tot[clinic_tot == i] <- NA
}
# find_na(clinic_tot)
# set_missing
clinic_tot_proc <- best_na_percent(clinic_tot, 50)
# clinic_tot_proc <- clinic_tot

plot_missing(
    clinic_tot_proc,
    geom_label_args = list(
        label.size = NA,
        label.padding = unit(0, "lines"),
        size = 3
    ),
    group = list("25%" = 0.25, "50%" = 0.50, "75%" = 0.75, "100%" = 1)
)

(gg_miss_var(clinic_tot, show_pct = TRUE) + theme_classic() + theme_perso()) # %>% ggplotly()
vis_miss(clinic_tot_proc)

clinic_code_proc <- clean_data(clinic_code[[1]])
# vis_miss(clinic_code_proc)
# vis_miss(best_na_percent(clinic_tot_proc, 0))
# Imputation
# res <- summary(aggr(clinic_tot, sortVar = TRUE))$combinations

# Numeric
var_num <- get_name_num(clinic_tot_proc)
clinic_tot_proc <- update_columns(clinic_tot_proc, all_of(var_num), as.numeric)

diagnose_numeric(clinic_tot_proc)

# plot_violin(clinic_tot_proc, colors = rep("blue", 250))
# plot_violin2(clinic_tot_proc, colors = rep("black", 250))
# plot_violin3(clinic_tot_proc, colors = rep("black", 250))

# Date
var_dates <- c("C_2643_3800", "C_2643_3801", "C_2643_3802", "C_2648_3886", "C_2648_3887", "C_2728_4054_1", "C_2729_4054_1", "C_2745_4178_1", "C_2745_4178_2")

clinic_tot_proc <- update_columns(clinic_tot_proc, var_dates, complete_date)
clinic_tot_proc <- update_columns(clinic_tot_proc, var_dates, dmy)
for (i in var_dates) {
    qplot(as.data.frame(clinic_tot_proc[, i])[, 1])
}

clin_proc_year <- update_columns(clinic_tot_proc, var_dates, function(i) year(round_date(i, "year")))
plot_histogram(clin_proc_year)

for (i in var_dates) {
    y <- as.data.frame(as.character(as.data.frame(clin_proc_year[, i])[, 1]))
    diagnose_category(y, top = 100) %>% arrange(freq)
}

# Age in decades
decade <- as.data.frame(as.character(as.data.frame(clin_proc_year[, "C_2643_3800"] - clin_proc_year[, "C_2643_3800"] %% 10)[, 1]))
diagnose_category(decade, top = 100) %>%
    arrange(levels) %>%
    select(-variables)
qplot(decade[, 1])
qplot(as.character(2020 - as.numeric(decade[, 1])))

# Categorical variables
clin_categorial <- select(clinic_tot_proc, -all_of(c(var_dates)))
# clin_categorial <- select(clinic_tot, all_of(c(var_categorial)))
clin_categorial <- update_columns(clin_categorial, "C_2643_3798", as.character)
l_level_cols <- parse_levels(clin_categorial, clinic_code, FALSE)
cols_sim <- col_sim(clin_categorial, clinic_code, FALSE)
# sapply(apply(l_level_cols[-unique(unlist(i_rows)), ], 1, function(x) which(!is.na(x))), length) %>% sort()

regexes <- c("france", "AP-HP", "Mother", "control", "aspirin", "negative\t", "asian", "non african", "partial\t", "response", "flare", "male", "mild", "localized", "months")
i_rows <- lapply(regexes, function(i) detect_difficulty(l_level_cols, i))
j_rows <- seq(nrow(l_level_cols))[-unlist(i_rows)]
tot_rows <- c(i_rows, as.list(j_rows))
l_levels <- lapply(tot_rows, function(i) reformat(l_level_cols[i, ]))
lapply(tot_rows, function(i) unlist(get_level_name(cols_sim, clinic_code[[3]])[i]))
# get_table_occ(clin_categorial, clinic_code, seq(nrow(l_level_cols))[-j_rows], FALSE)

var_categorial <- unlist(cols_sim)
clinic_tot_proc <- update_columns(clinic_tot_proc, var_categorial, as.factor)

to_replace <- list(
    `0` = c("Non African", "No", "None", "Primary failure", "Out of flare", "Male", "Single", "Chronic : > 6 weeks", "Unique", "First episode", "Non symmetrical", "Random", "Negative"),
    `1` = c("African", "Yes", "Partial", "Mild", "Diffuse", "Partial response", "On flare", "Female", "Multiple", "Acute : < 6 weeks", "Recurrent (with remission period)", "Symmetrical", "Patterned", "Positive"),
    `2` = c("Total", "Moderate to severe", "Loss of efficacy", "Localized", "Continuous (without remission)"),
    `3` = c("Complete response")
)

# for (i in seq_along(to_replace)) {
#     for (j in seq_along(to_replace[[i]])) {
#         clinic_tot[clinic_tot == to_replace[[i]][j]] <- paste(i - 1)
#     }
# }
# [[15]]

# group_name
# The top bottom by frequency
diagnose_category(
    clinic_code_proc[, "group_name", drop = FALSE],
    top = 100
) %>% arrange(freq)
# Select the clinic data with 0 NA
var_na <- colnames(clinic_tot_proc)
# Look at the metadata in codes
(stats <- clinic_code_proc %>%
    filter(clinic_code_proc$column_code %in% var_na) %>%
    select(!(starts_with("repeat"))))

get_var_names(var_na, stats)

diagnose_category(as.data.frame(stats$group_name))
# Which is the frequence of this category
clinic_code_proc[, "group_name", drop = FALSE] %>%
    diagnose_category(top = 100) %>%
    filter(str_detect(levels, paste0(unique(stats$group_name), collapse = "|")))
# What are the most frequent modalities for each variable
plot_bar(clinic_tot_proc)
# Create country variable
clinic_tot_proc %>%
    update_columns("C_2643_3797", as.character) %>%
    mutate(
        country = case_when(
            str_detect(C_2643_3797, "Paris|Bordeaux|Nantes|Lyon|Lille|Strasbourg") ~ "France",
            str_detect(C_2643_3797, "Madrid|Barcelona") ~ "Spain",
            str_detect(C_2643_3797, "Leuven") ~ "Belgium",
            str_detect(C_2643_3797, "Rotterdam") ~ "Netherlands",
            str_detect(C_2643_3797, "Athens") ~ "Greece",
            str_detect(C_2643_3797, "Roma") ~ "Italy",
            str_detect(C_2643_3797, "Geneva") ~ "Switzerland",
            str_detect(C_2643_3797, "Ankara") ~ "Turkey",
            str_detect(C_2643_3797, "MÃ¼nster|Berlin") ~ "Germany",
            str_detect(C_2643_3797, "Leeds") ~ "United Kingdom (UK)",
            str_detect(C_2643_3797, "Lubljana") ~ "Slovenia",
            TRUE ~ C_2643_3797
        )
    ) %>%
    select(country) %>%
    plot_bar(ggtheme = theme_classic(), theme_config = theme_perso())

# By French centers
clinic_tot_proc %>%
    filter(str_detect(C_2643_3797, "Paris|Bordeaux|Nantes|Lyon|Lille|Strasbourg")) %>%
    select(C_2643_3797) %>%
    plot_bar()

# clinic_tot_proc %>%
#     filter(str_detect(C_2643_3797, "Paris|Bordeaux|Nantes|Lyon|Lille|Strasbourg")) %>% select(C_2643_3797) %>% group_by(C_2643_3797) %>% summarise(n = n()) %>% arrange(desc(n))

# By French cities
clinic_tot_proc %>%
    mutate(
        town = case_when(
            str_detect(C_2643_3797, "Paris") ~ "Paris",
            str_detect(C_2643_3797, "Bordeaux") ~ "Bordeaux",
            str_detect(C_2643_3797, "Nantes") ~ "Nantes",
            str_detect(C_2643_3797, "Lyon") ~ "Lyon",
            str_detect(C_2643_3797, "Lille") ~ "Lille",
            str_detect(C_2643_3797, "Strasbourg") ~ "Strasbourg",
            TRUE ~ "Others"
        )
    ) %>%
    select(town) %>%
    plot_bar()

# %>% diagnose_category()

# Correlation
# (p <- select(clinic_tot_proc, all_of(var_num)) %>% plot_corr0(p_adjust = "BH"))
# save_tiff(p)

plot_corr(clinic_tot_proc, stats)
ggcorrmat(clinic_tot_proc)

# Format conversion
var_dates <- colnames(clinic_tot)[which(find_dates(clinic_tot))]
clinic_tot <- update_columns(clinic_tot, var_dates, complete_date)
clinic_tot <- update_columns(clinic_tot, var_dates, dmy)
var_num <- get_name_num(clinic_tot)
clinic_tot <- update_columns(clinic_tot, all_of(var_num), as.numeric)
var_categorial <- colnames(clinic_tot)[which(!(colnames(clinic_tot) %in% c(var_dates, var_num)))]
clinic_tot <- update_columns(clinic_tot, var_categorial, as.factor)

# Stats / outliers
var_num <- get_name_num(clinic_tot_proc)
# slice(clinic, which(clinic$bmi_automatic > 100)) %>%
#   select ("weight_kg", "height_cm", "bmi_automatic", "age_at_inclusion_tim")

col_outliers <- explore_outliers(clinic_tot_proc)
var_socio <- c("C_2643_3803", "C_2643_3804", "C_2649_3889", "C_2649_3890")
i <- col_outliers[1] # "C_2643_3804"
j <- col_outliers[2] # "C_2649_3889"
clin_melt <- melt(clinic_tot_proc) %>% select(variable, value)
outliers <- (clin_melt %>% filter(variable == var_socio[4]) %>% boxplot())$out

# Fix height and bmi errors
clinic_tot_proc <- clinic_tot
tab <- clinic_tot_proc %>%
    filter(C_2649_3890 > 100) %>%
    select(all_of(var_socio))
to_fix <- clinic_tot_proc$C_2649_3890 %in% tab$C_2649_3890
clinic_tot_proc$C_2649_3889[to_fix] <- c(173, 151)
clinic_tot_proc$C_2649_3890[to_fix] <- clinic_tot_proc$C_2643_3804[to_fix] / ((clinic_tot_proc$C_2649_3889[to_fix] / 100)^2)

pull(clinic_tot_proc, i) %>% get_outliers()
# get_outliers(clinic_tot_proc, j, probs = c(.025, .975), method = "percentiles")
# get_outliers(clinic_tot_proc, j, , method = "hampel", c = 3)

clinic_tot_proc <- finalise_data(clinic_tot_proc, clean_name = FALSE, row_name = 2)
codes_proc <- colnames(clinic_tot_proc)

colnames(clinic_tot_proc) <- get_var_names(codes_proc, clinic_code[[1]]) %>%
    str_sub(1, 20)
clinic <- clean_names(clinic_tot_proc)
attributes(clinic)$codes <- tibble(codes = codes_proc, name = colnames(clinic))
# use_data(clinic, overwrite = TRUE)
```

## Clinic transformation
```{r transf}
# Transformations
clinic_num <- select(clinic, sort(get_name_num(clinic)))

var_ord <- ordinal_variables(clinic_num)
var_not_ord <- colnames(select(clinic_num, -all_of(var_ord)))
plot_histo(log1p(select(clinic_num, all_of(var_not_ord))), colors = rep("blue", 250))

var_max <- c("creatinine_mmol_l", "alat_uln_upper_limi", "leucocytes_mm3", "neutrophils_mm3", "ggt_ui_l", "cardiac_manifestatio", "vascular_involvement", "other_neurological_m")
(out <- sapply(var_max, function(i) which.max(as.data.frame(clinic_num[, i])[[1]])))

p <- ggdraw()
for (i in seq(var_max)) {
    p <- p + {
        clinic[-out[i], ] %>%
            pull(var_max[i]) %>%
            plot_violin0()
    }
}
p

get_not_normal0(log1p(select(clinic, all_of(var_not_ord))))

# levels from ordinal data
sapply(var_ord, function(i) unique(sort(as.data.frame(clinic_num[, i])[, 1])))
diagnose_category(as.data.frame(sapply(var_ord, function(i) as.factor(as.data.frame(clinic_num[, i])[, 1]))))

# Outliers removing
# plot_violin(select(clinic, alat_uln_upper_limi) %>% filter(alat_uln_upper_limi < 140))
clinic$alat_uln_upper_limi[which(clinic$alat_uln_upper_limi == 269)] <- NA

# Transformations
clinic_transf <- clinic

# X2
# clinic_transf <- update_columns(clinic, "height_cm", function(i) i^2)
# Log transformation
var_log <- c(
    # "abdominal_pain",
    "alat_ui_l",
    "alk_phosphatases_ui",
    "asat_ui_l",
    # "arthralgia_myalgia",
    "bmi_automatic",
    # "bone_pain",
    # "cardiac_manifestatio",
    # "charlson_score_auto",
    # "chest_pain",
    "creatinine_mmol_l",
    "crp_c_reactive_prot",
    # "diarrhea",
    "eosinophils_mm3",
    # "eye_manifestations",
    "fever_38_c_104_f",
    "ggt_ui_l",
    "ggt_uln_ui_l", # bof
    # "headaches",
    # "nausea_vomiting",
    "number_of_consecutiv",
    # "other_neurological_m",
    # "overall_symptoms",
    # "painful_nodes",
    # "skin_rash_other_sa",
    # "sore_throat_other",
    # "swelling_of_the_join",
    "total_bilirubin_mmo"
    # "vascular_involvement",
    # "weight_loss_uninten"
)
# clinic_transf <- update_columns(clinic_transf, var_log, log1p) # %>%
# arrange(immun_aid_identifier)
colnames(clinic_transf) <- codes_proc

# Rename
code_extracted <- extract_codes(codes_proc, clinic_code[[3]])
temp <- str_replace(code_extracted$item_name, " \\(.+\\)|^\\d{1,2}\\. ", "")
names(temp) <- codes_proc
temp <- sort(temp)
codes_temp <- names(temp)
temp <- janitor::make_clean_names(temp)
names(temp) <- codes_temp
temp <- temp[codes_proc]

vars <- c("_patient_included", "_of_disease_activity", "cytological_signs_of_", "_on_secondary_genetic_findings", "_treatment_in_the_last_2_weeks", "_other_said_dermatological_manifestations", "_other_ear_nose_throat_symptoms", "gfr_")
temp <- str_replace(temp, paste(vars, collapse = "|"), "")

keys <- c("date_2", "date", "by", "max")
values <- c("\\1_immunology", "\\1_biology", "consent_signed_by", "max_fever")
for (i in seq_along(keys)) {
    temp <- str_replace(temp, paste0("^(", keys[i], ")$"), values[i])
}

keys <- c("chf", "cva", "copd", "crp", "hb", "uln")
values <- c("Congestive Heart Failure", "Cerebrovascular Accident or Transient Ischemic Attack", "Chronic Obstructive Pulmonary Disease", "C-reactive protein", "Hemoglobine", "Upper Limit of Normal")
for (i in seq_along(keys)) {
    temp <- str_replace(temp, keys[i], janitor::make_clean_names(values[i]))
}

for (i in c(temp[sapply(temp, function(i) str_length(i) < 5)])) {
    if (!i %in% c("type", "urea")) {
        temp <- str_replace(temp, i, toupper(i))
    }
}

temp <- str_replace(temp, "^(neutrophils)_2$", "\\1_percent")
temp <- str_replace(temp, "value_due_to_the_disease", "")

names(temp) <- codes_temp

# code_extracted %>% filter(str_detect(item_name, regex(paste0("^", temp[sapply(temp, function(i) str_length(i) < 5)][-6], collapse = "|"), ignore_case = TRUE))) %>% select(c(group_name, item_name))

# Codes
code_info <- clinic_code[[3]] %>%
    filter(str_detect(column_code, paste0("^", codes_temp, "$", collapse = "|"))) %>%
    select(column_code, group_name)
code_info$group_name <- str_replace(code_info$group_name, " \\(.+\\)", "") %>%
    snakecase::to_any_case(unique_sep = NULL, parsing_option = 3) %>%
    as.factor()
colnames(clinic_transf) <- temp
temp2 <- cbind(code_info, item_name = as.character(temp))

# Dates
# date_vars <- clinic_transf %>% select(which(sapply(colnames(.), function(i) is.Date(as.data.frame(.[, i])[, 1]))))
# cou2 <- (temp2 %>% filter(str_detect(item_name, paste0("^", colnames(date_vars), "$", collapse = "|"))) %>% select(column_code))$column_code
# clinic_code[[3]] %>% filter(str_detect(column_code, paste0("^", cou2, "$", collapse = "|")))

date_biol <- (
    clinic_code[[3]] %>%
        filter(str_detect(group_name, "General biology")) %>%
        filter(str_detect(item_name, "Date"))
)$column_code
biol <- (
    temp2 %>% filter(str_detect(group_name, "biology")) %>%
        filter(!str_detect(item_name, "date"))
)$item_name
clinic_tot2 <- update_columns(clinic_tot, date_biol, dmy)
date_diff <- sapply(seq(4), function(i) clinic$date_of_inclusion - as.data.frame(clinic_tot2 %>% select(all_of(date_biol)))[, i])
# which(abs(date_diff) > 7)
# Closest date is not the first date only for  around 10 elements. And most of the data at these date are NA. So keep the first date that do not influence too much and to know for sure at which date the data are from.
date_corr <- sapply(seq(4), function(i) ifelse(abs(date_diff[, i]) > 7, NA, date_diff[, i]))
colnames(date_corr) <- paste("inclusion - general biology", seq(4))
which_min <- sapply(seq(nrow(date_corr)), function(i) which.min(abs(date_corr[i, ])))
which_min <- sapply(which_min, function(i) ifelse(length(i) == 0, 1, i))
# which(which_min > 1)
# which_min[which_min > 1]
# image(seq(213), 1, as.matrix(which_min), yaxt = "n", labels = FALSE); axis(1, las = 2, at = seq(213), labels = FALSE); axis(1, las = 2, at = seq(0, 213, 5), lwd.ticks = 3)
# as_tibble(date_diff) %>% slice(intersect(which(abs(date_diff) > 7), which(which_min > 1)))
# (clinic_tot %>% select(all_of(bloup2)) %>% slice(setdiff(which(which_min > 1), which(abs(date_diff) > 7))))[, (1+(8*k)):(8+(8*k))]

filter_week <- abs(date_diff) > 7
filter_week1 <- which(filter_week[, 1])

# for (i in biol) {
#     clinic_transf[filter_week1, i] <- NA
# }

#  clinic_transf %>% select(all_of(biol)) %>% slice(intersect(which(abs(date_diff) > 7), which(which_min > 1)))
# clinic_transf %>% select(date_biology) %>% slice(intersect(which(abs(date_diff) > 7), which(which_min > 1)))

t_batch <- arrange(as.data.frame(t_batch), V1)[, 2]

# Save
clinic_transf <- arrange(clinic_transf, immun_aid_identifier) %>%
    mutate(batch = t_batch)
clinic_transf <- finalise_data(clinic_transf, row_name = "immun_aid_identifier", clean_name = FALSE)
attributes(clinic_transf)$codes <- temp2
use_data(clinic_transf, overwrite = TRUE)
```

## Filter by disease
```{r}
clinic <- clinic_transf
# Filter by disease
diseases <- levels(clinic$disease)
# d2 <- diseases[9]
d1 <- diseases[1]
d0 <- diseases[14]
clinic_dis0 <- clinic_dis <- clinic %>%
    filter(
        str_detect(
            disease,
            replace_parenthesis(paste(c(d0, d1), collapse = "|"))
        )
    )
# levels(clinic_dis$disease)[d2 == levels(clinic$disease)] <- "2"
levels(clinic_dis$disease)[d1 == levels(clinic$disease)] <- "1"
levels(clinic_dis$disease)[d0 == levels(clinic$disease)] <- "0"
clinic_dis$disease <- clinic_dis$disease %>%
    factor(., levels = unique(.))

# clinic_dis <- clinic
# clinic_dis$disease <- as.numeric(clinic_dis$disease)

# All confounding variables in numeric
levels(clinic_dis$gender) <- c(0, 1)
clinic_dis$gender <- as.numeric(as.character(clinic_dis$gender))

# Batch * centers effects
clinic_dis %>%
    group_by(clinical_center) %>%
    dplyr::mutate(count_name_occurr = n()) %>%
    ggplot(aes(
        x = reorder(clinical_center, -count_name_occurr),
        fill = as.character(batch)
    )) +
    geom_bar(position = "stack") +
    labs(fill = "Batch") +
    stat_count(
        geom = "text",
        colour = "white",
        size = 3.5,
        aes(label = ..count..),
        position = position_stack(vjust = 0.5)
    )

# Filter by numeric variables
clinic_num <- get_name_num(clinic_dis) %>%
    select(clinic_dis, .)

# Remove columns with high levels of NA
plot_missing(
    clinic_num,
    geom_label_args = list(
        label.size = NA,
        label.padding = unit(0, "lines"),
        size = 3
    ),
    group = list("25%" = 0.25, "50%" = 0.50, "75%" = 0.75, "100%" = 1)
)
#
# gg_miss_var(clinic_dis, show_pct = TRUE) + theme_classic() + theme_perso()
# vis_miss(clinic_dis)

clinic_proc <- finalise_data0(clinic_num, clinic_dis)

# Remove individuals with high levels of NA
x <- clinic_proc
res <- sapply(rownames(x), function(i) round((length(which(is.na(x[i, ]))) / ncol(x)) * 100, 1))
names(res) <- clinic_proc$immun_aid_identifier
plotHistogram(df = res[res > 0])
name_inds <- names(res[res > 50])
clinic_proc %>%
    filter(str_detect(immun_aid_identifier, paste0("^", name_inds, "$", collapse = "|"))) %>%
    select(immun_aid_identifier, disease) -> temp
name_lvls <- levels(clinic$disease)[unique(temp$disease) %>% sort()]
table(temp$disease) %>% setNames(name_lvls)
table(temp$disease) %>% setNames(name_lvls) / table(clinic$disease)[name_lvls] * 100
names(res) <- clinic_dis0$disease
res[res > 50]

clinic_proc0 <- clinic_proc[-which(res > 50), ]
clinic_proc0$disease <- as.factor(clinic_proc0$disease)

# Descriptive statistics
stats <- clinic_proc0 %>%
    pivot_longer(!disease) %>%
    group_by(name, disease) %>%
    dplyr::summarise(
        mean = mean(value, na.rm = TRUE),
        sd = sd(value, na.rm = TRUE),
        n = length(which(!is.na(value)))
    ) %>%
    pivot_wider(names_from = disease, values_from = c(mean, sd, n)) %>%
    mutate(ratio = (n_0 / n_1))

sds <- apply((clinic_proc0 %>% select(-disease)), 2, function(x) sd(x, na.rm = TRUE))
stats$samplesize <- calculate_samplesize(stats$mean_0, stats$mean_1, sds, stats$ratio)
stats$effectsize <- abs(calculate_effectsize(stats$mean_0, stats$mean_1, sds))

# Remove the variables with only NA in control
stats0 <- stats %>% filter(!is.na(mean_0))
# stats0 %>% arrange(samplesize)

not_in_control <- (stats %>% filter(is.na(mean_0)))$name

# Mean difference tests
tests <- clinic_proc0 %>%
    select(-all_of(not_in_control)) %>%
    pivot_longer(!disease) %>%
    group_by(name) %>%
    wilcox_test(value ~ disease) %>%
    adjust_pvalue(method = "BH") %>%
    add_significance()

# Total statistics
left_join(stats0, tests[, c(1, 8:10)]) %>% arrange(samplesize)

vars0 <- c("batch", "gender")
vars <- c("age_at_inclusion_time", "BMI", vars0)
vars2 <- c("immun_aid_identifier", "weight", "height")
row_names <- select(clinic_proc, immun_aid_identifier)
clinic_proc_full <- clinic_proc

# clinic_proc_disc0 <- clinic_proc_disc
# clinic_proc_disc0[is.na(clinic_proc_disc0)] <- 0
# clinic_proc_disc0[clinic_proc_disc0 == 30] <- NA
# vis_miss(clinic_proc_disc0)

# Get variable names
var_scores <- data.frame(item_name = colnames(clinic_proc)) %>%
    inner_join(attributes(clinic)$codes) %>%
    filter(group_name == "aidai_score_on_30_days") %>%
    pull(item_name)

vars3 <- data.frame(item_name = colnames(clinic_proc)) %>%
    inner_join(attributes(clinic)$codes) %>%
    pull(column_code)
vars3 <- lapply(
    vars3,
    function(i) filter(clinic_code[[3]], column_code == i)
) %>%
    Reduce(rbind, .) %>%
    pull(item_name)

name_vars <- colnames(clinic_proc) %>%
    tools::toTitleCase() %>%
    gsub("_", " ", .)

# Remove outliers
clinic_proc0 <- select(clinic_proc, -vars0)
clinic_proc_cont <- select(clinic_proc0, -c(var_scores, "charlson_score", "weight_loss"))
clinic_proc_cont <- sapply(colnames(select(clinic_proc_cont, -c("creatinine", "ALAT", "disease"))), function(i) pull(clinic_proc, i) %>% get_outliers(method = "mad", c = 24))
clinic_proc_disc <- select(clinic_proc0, c(var_scores, "charlson_score", "weight_loss"))
x <- 1e-2
sapply(colnames(clinic_proc_disc), function(i) pull(clinic_proc, i) %>% get_outliers(c(0 + x, 1 - x), method = "iqr")) -> clinic_proc_disc

keys <- c("creatinine", "ALAT")
value <- c(5600, 423)
clinic_proc0 <- as.data.frame(clinic_proc0)
for (i in seq_along(keys)) {
    clinic_proc0[, keys[i]][clinic_proc0[, keys[i]] == value[i]] <- NA
}

clinic_proc <- Reduce(cbind, list(clinic_proc0 %>% select(keys), clinic_proc_cont, clinic_proc_disc)) %>% finalise_data0(., row_names)

p0 <- list.map(
    as.list(colnames(clinic_proc)),
    f(i, j) ~ {
        plot_violin0(
            clinic_proc %>% pull(i),
            title = name_vars[j],
            colour = "red",
            wrap_title = 10
        )
    }
)
# align_plots(plotlist = p, align = "vh") %>%
p <- plot_grid(
    plotlist = p0,
    nrow = 5,
    ncol = 10
)
p

# Transformation
norm_vars <- list()
norm_vars[[1]] <- normality(clinic_proc) %>%
    filter(p_value > 0.05) %>%
    select(vars)
skew <- ((clinic_proc) %>% select(-c(unlist(norm_vars))) %>%
    sapply(function(i) skewness(i)))
temp <- data.frame(var = skew) %>%
    filter(var < 0) %>%
    row.names() %>%
    select(clinic_proc, .)
norm_vars[[2]] <- temp^2 %>%
    normality() %>%
    filter(p_value > 0.05) %>%
    select(vars)
norm_vars[[3]] <- temp^3 %>%
    normality() %>%
    filter(p_value > 0.01) %>%
    select(vars)
norm_vars[[4]] <- (log(clinic_proc + 1)) %>%
    select(-c(unlist(norm_vars))) %>%
    normality() %>%
    filter(p_value > 0.01) %>%
    select(vars)
norm_vars[[5]] <- (1 / (clinic_proc + 1)) %>%
    select(-c(unlist(norm_vars))) %>%
    normality() %>%
    filter(p_value > 0.01) %>%
    select(vars)
norm_vars[[6]] <- ((clinic_proc)^(1 / 2)) %>%
    select(-c(unlist(norm_vars))) %>%
    normality() %>%
    filter(p_value > 0.01) %>%
    select(vars)

transf <- c(function(i) i^2, function(i) i^3, function(i) log(i + 1), function(i) 1 / (i + 1), function(i) i^(1 / 2))
for (i in seq(transf)) {
    clinic_proc <- update_columns(clinic_proc, all_of(unlist(norm_vars[[i + 1]])), transf[[i]])
}
# clinic_proc <- update_columns(clinic_proc, colnames(clinic_proc), log1p)

blocks_cl <- cbind(clinic_proc, select(clinic_proc_full, c("batch", "gender"))) %>% as.data.frame()
rownames(blocks_cl) <- clinic_proc$immun_aid_identifier

# Remove redundant information
ggscatterstats(clinic_proc, neutrophils, neutrophils_5, type = "nonparametric")
ggscatterstats(clinic_proc, patient_global_assessment, physician_global_assessment, type = "nonparametric")
plot_corr0(clinic_proc)
clinic_proc <- clinic_proc %>% select(
    -c(
        vars2,
        ends_with("_upper_limit_of_normal"),
        starts_with("max_")
    )
)

# Remove confounding
cl <- clinic_proc_full
cl$gender <- as.factor(cl$gender)
cl$batch <- as.factor(cl$batch)
blocks_clinic_tot <- remove_cofunding(list(CLINIC = blocks_cl), vars)

blocks_clinic_tot[[1]] <- select(blocks_clinic_tot[[1]], -all_of(c(vars))) #   <-  list(CLINIC = select(blocks_cl, -all_of(vars)))
blocks_clinic_tot[[1]] <- clean_data(blocks_clinic_tot[[1]])
attributes(blocks_clinic_tot)$codes <- Reduce(rbind, lapply(colnames(blocks_clinic_tot[[1]]), function(i) filter(temp2, str_detect(item_name, paste0("^", i, "$")))))
# Reduce(rbind, lapply(temp0$column_code, function(i) filter(clinic_code[[3]], str_detect(column_code, paste0("^", i, "$"))))) %>% select(-c(starts_with("repeat"), ends_with("_id"))) %>% as.data.frame()
clinic_tot <- blocks_clinic_tot
use_data(clinic_tot, overwrite = TRUE)
```

## Qualitative variables
```{r}
clinic_qual <- which(sapply(seq_along(clinic_dis), function(i) is.factor(as.data.frame(clinic_dis)[, i]))) %>%
    select(clinic_dis, .)
clinic_qual_proc <- finalise_data0(clinic_qual, clinic_dis)
row_names <- rownames(clinic_qual_proc)
colnames(clinic_qual_proc) <- str_replace(colnames(clinic_qual_proc), "(do_you_still_have_the_results).*", "\\1") %>%
    str_replace("(cerebrovascular_accident_or_).*", "\\1ischemic")

# Remove individuals with high levels of NA
# x <- clinic_proc
# res <- sapply(rownames(x), function(i) round((length(which(is.na(x[i, ]))) / ncol(x)) * 100, 1))
# clinic_proc <- clinic_proc[-which(res > 70), ]
clinic_qual_proc <- clinic_qual_proc[-37, ]
use_data(clinic_qual_proc, overwrite = TRUE)

func <- function(x) names(ordinal_variables(clinic_qual_proc, x))
for (i in 2:60) {
    print(setdiff(func(i + 1), func(i)))
}
# sapply(clinic_qual_proc, unique) %>% sapply(length) %>% sort()

to_parse <- sapply(
    seq_along(clinic_qual_proc),
    function(i) any(grepl(";", as.data.frame(clinic_qual_proc[, i])[, 1]))
) %>% which()
l_levels <- sapply(
    to_parse,
    function(i) {
        as.data.frame(clinic_qual_proc[, i])[, 1] %>%
            str_split(";") %>%
            unlist() %>%
            str_trim() %>%
            unique() %>%
            as.character()
    }
)

if (!is.null(l_levels[[2]])) {
    n <- seq_along(l_levels)
} else {
    n <- 1
}
t_levels <- lapply(
    n,
    function(i) {
        sapply(
            na.omit(l_levels[[i]]),
            function(j) {
                as.data.frame(clinic_qual_proc[, to_parse])[, i] %>%
                    str_detect(j) %>%
                    as.numeric()
            }
        ) %>%
            as_tibble() %>%
            clean_names() %>%
            remove_constant(na.rm = TRUE, quiet = FALSE)
    }
)

colnames(t_levels[[4]]) <- str_to_title(colnames(t_levels[[4]])) %>% str_replace_all("_", " ")
colnames(t_levels[[4]])[11] <- "Mucosal membranes"
plot_bar_mcat(t_levels[[4]], cex = 12, ratio = 3, title = "Part affected")

str_to_title(colnames(t_levels[[3]])) %>%
    str_replace_all("_", " ") %>%
    set_colnames(t_levels[[3]], .) %>%
    plot_bar_mcat(cex = 12, ratio = 3, title = "Lesions on")

n_levels <- str_replace(colnames(clinic_qual_proc)[to_parse], "(at_least_3).*", "\\1") %>%
    str_replace(".*(parts_affected)", "\\1") %>%
    mapply(function(i, j) paste(i, j, sep = "_"), ., lapply(t_levels, colnames)) %>%
    unlist()

t_levels <- Reduce(cbind, t_levels) %>%
    set_colnames(n_levels)

clinic_qual_proc <- clinic_qual_proc %>%
    select(-to_parse) %>%
    cbind(t_levels)

# setdiff(names(ordinal_variables(clinic_qual_proc, 3)), names(ordinal_variables(clinic_qual_proc, 2)))

clinic_ord <- set_qualitative(clinic_qual_proc, 2)
mutate_all(clinic_ord, as.numeric) %>%
    as.matrix() %>%
    heatmap(
        na.rm = FALSE,
        scale = "none",
        Rowv = NA,
        Colv = NA,
        margins = c(13, 0),
        col = colorRampPalette(c("blue", "white", "#cd5b45"))(100)
    )

to_remove1 <- (
    diagnose_category(clinic_ord) %>%
        filter(!is.na(levels)) %>%
        filter(freq < 5)
)$variables %>%
    unique()
clinic_ord0 <- set_qualitative(clinic_qual_proc, 3)
to_remove2 <- (
    diagnose_category(select(clinic_ord0, -c(to_remove1))) %>%
        filter(is.na(levels)) %>%
        filter(freq < 5)
)$variables

clinic_ord <- select(clinic_ord, -c(to_remove1))

# plot_histo(as.data.frame(clinic_proc %>% select(-disease)), colors = rep("blue", 200))

# Proportion of ordinal data modalities
perc <- mutate_all(clinic_ord, as.numeric) %>%
    pivot_longer(all_of(colnames(clinic_ord))) %>%
    group_by(name, value) %>%
    dplyr::summarise(`%` = n()) %>%
    pivot_wider(names_from = name, values_from = c(`%`))
temp <- t(perc)[-1, ] %>%
    cbind(., round(. / nrow(clinic_qual_proc), 2)) %>%
    as.data.frame() %>%
    set_colnames(rep(c(paste("Cat.", seq(2)), "NA"), 2))
temp[is.na(temp)] <- 0
temp[seq(6)] <- lapply(temp[seq(6)], function(x) {
    cell_spec(
        x,
        color = "white",
        background = spec_color2(x, end = 0.9, option = "D")
    )
})

temp %>%
    kbl(escape = FALSE, align = "c") %>%
    kable_minimal() %>%
    add_header_above(c(" " = 1, "N" = 3, "%" = 3)) %>%
    save_kable("table.temp.png")

# clinic_dis[, "disease"] %>% group_by(disease) %>% summarise(`%` = n())

# Remove all ordinal data with low occurrences
perc0 <- perc %>% filter(!is.na(value))
n <- 4
var_occ <- names(which(apply(perc0[, -1], 2, function(x) any(x <= n))))
perc0 %>% select(-var_occ)

# clinic_num0 <- clinic_proc %>%
#   select(
#     -all_of(
#       c(names(ordinal_variables(clinic_proc, 3)), "immun_aid_identifier")
#       )
#   )

# plot_histo(clinic_num0, colors = rep("blue", 200))

# Remove all ordinal data with low occurrences
clinic_proc0 <- clinic_proc[, sort(colnames(clinic_proc))] %>%
    select(-all_of(c(var_occ)))
# clinic_proc0$disease <- factor(clinic_proc0$disease, labels = rev(c(diseases[9], diseases[1])))

codes_qual <- Reduce(rbind, lapply(colnames(clinic_proc), function(i) filter(temp2, str_detect(item_name, paste0("^", i, "$")))))
codes_qual %>%
    group_by(group_name) %>%
    dplyr::summarise(n = n()) %>%
    arrange(n)

# Reduce(rbind, lapply(temp, function(i) filter(clinic_code[[3]], str_detect(column_code, paste0("^", i, "$"))))) %>% select(-c( starts_with("repeat") )) %>% arrange(group_id)

clinic_proc <- mutate_all(clinic_qual_proc, factor)
clinic_proc$treatment_7[clinic_proc$treatment_7 == "Other"] <- NA
lvl <- c("No", "Yes", "Yes")
keys <- c("response_to_paracetamol", "response_to_nsai_ds", "active_manifestation_2")
val <- list(lvl, lvl, c("Continuous or reccurent", "First episode", "Continuous or reccurent"))
for (i in seq(keys)) {
    clinic_proc[, keys[i]] <- recode_factor(as.numeric(clinic_proc[, keys[i]]), !!!val[[i]])
}

i <- "response_to_biologic_treatments"
clinic_proc[, i] <- recode_factor(clinic_proc[, i], No = "Partial", .default = levels(clinic_proc[, i]))


for (i in c("fathers_ethnicity", "mothers_ethnicity")) {
    clinic_proc[, i] <- recode_factor(as.numeric(clinic_proc[, i]), !!!c(rep("Not European", 3), "European"))
}

temp <- select(clinic_qual, starts_with("treatment_group"))
l_levels0 <- unlist(temp) %>%
    unique() %>%
    as.character()
temp <- unite(temp, col = "treatments_type", na.rm = TRUE, treatment_group:treatment_group_28, sep = " ; ")
l_levels1 <- na.omit(l_levels0)[-7]
temp <- sapply(
    l_levels1,
    function(j) {
        as.data.frame(temp)[, 1] %>%
            str_detect(replace_parenthesis(j)) %>%
            as.numeric()
    }
) %>% set_colnames(str_replace(l_levels1, "\\(.+\\)", ""))
temp <- temp %>%
    as_tibble() %>%
    set_colnames(paste0("treatment_", colnames(temp))) %>%
    clean_names()

for (i in c("response", "response_3")) {
    clinic_proc[, i] <- recode_factor(
        clinic_proc[, i],
        `Loss of efficacy` = "Failure or loss of efficacy",
        `Primary failure` = "Failure or loss of efficacy",
        .default = levels(clinic_proc[, i])
    )
}

clinic_proc$response_2 <- recode_factor(as.numeric(clinic_proc$response_2), !!!c("Complete response", rep("Partial response or failure", 2)))


clinic_proc$treatment_group_3 <- recode_factor(as.numeric(clinic_proc$treatment_group_3), !!!c("Biologic", "Others", "DMARDs", rep("Others", 3)))
clinic_proc$treatment_group_2 <- recode_factor(as.numeric(clinic_proc$treatment_group_2), !!!c("Biologic", "Corticosteroid", "DMARDs", rep("Others", 3)))

clinic_proc$country_of_residence <- recode_factor(as.numeric(clinic_proc$country_of_residence), !!!c("Others", "France", rep("Others", 3)))
i <- "manifestation_s_2"
clinic_proc[, i] <- recode_factor(as.numeric(clinic_proc[, i]), !!!c(levels(clinic_proc[, i])[seq(2)], rep("Others", 3)))
clinic_proc$country_of_birth <- recode_factor(as.numeric(clinic_proc$country_of_birth), !!!c(rep("Others", 3), "France", rep("Others", 4)))
# clinic_proc <- clinic_proc %>%
#     update_columns("clinical_center", as.character) %>%
#     mutate(
#         country = case_when(
#             str_detect(clinical_center, "Paris|Bordeaux|Nantes|Lyon|Lille|Strasbourg") ~ "France",
#             TRUE ~ "Others"
#         )
#     )

clinic_qual <- select(clinic_proc, -c(to_remove1, to_remove2, "clinical_center", "liver_disease")) %>%
    cbind(data.frame(temp, immun_aid_identifier = row_names)[-37, ])
clinic_qual <- finalise_data(clinic_qual, row_name = "immun_aid_identifier", clean_name = FALSE) %>%
    select(-c("immun_aid_identifier"))
attributes(clinic_qual)$codes <- codes_qual
# use_data(clinic_qual, overwrite = TRUE)
```

## Descriptive stats for all disease
```{r}
data(clinic)
vars <- c("ferritin_mg_l", "crp_c_reactive_prot", "leucocytes_mm3", "fever_38_c_104_f", "physician_global_ass")
i <- vars[2]
res <- clinic %>%
    select(all_of(c("disease", vars))) %>%
    filter(!str_detect(disease, "Negative control")) %>%
    pivot_longer(!disease) %>%
    group_by(name, disease) %>%
    dplyr::summarise(
        mean = mean(value, na.rm = TRUE),
        median = median(value, na.rm = TRUE),
        sd = sd(value, na.rm = TRUE),
        quantiles = paste(quantile(value, c(0.25, 0.75), na.rm = TRUE), collapse = "-"),
        range = paste(range(value, na.rm = TRUE), collapse = "-"),
        n = length(which(!is.na(value))),
        na = length(which(is.na(value)))
    )

res %>% filter(name == i)


tiff(
    paste0(i, ".tiff"),
    units = "px",
    width = 3000,
    height = 2000,
    res = 300
)
(ggbetweenstats(
    (clinic %>% select(all_of(c("disease", i)))),
    x = disease,
    y = crp_c_reactive_prot,
    p.adjust.method = "BH",
    type = "nonparametric",
    centrality.point.args = list(size = 0),
    centrality.label.args = list(
        size = 3,
        fill = NA,
        label.size = NA,
        segment.linetype = 0
    ),
    pairwise.comparisons = FALSE
)) %>%
    theme_perso0(colors = c(brewer.pal(n = 9, name = "Set1"), brewer.pal(n = 8, name = "Set2"))) +
    guides(fill = "none", color = "none") +
    theme(axis.text.x = element_text(angle = 35, vjust = 1, hjust = 1))
dev.off()
```

## Test with expected output

```{r}
clinic0 <- read_tsv(file.path(path, "CleanBiologicalValues.tsv"))
clinic0 <- arrange(clinic0, ID) %>%
    clean_names()
colnames(clinic0) <- str_sub(colnames(clinic0), 1, 20)
data(clinic)
clinic <- arrange(clinic, immun_aid_identifier)
# identical(clinic0$id, clinic$immun_aid_identifier)
to_exclude <- c(
    "description",
    "precise",
    "coombs_test_positive",
    "conj_bili_mmol_l",
    "in",
    "antibody_structure",
    "isotype",
    "light_chain",
    "serum_peak_g_l",
    "ldh_u_l",
    "triglycerides_mmol_l",
    "crp_2nd_visit",
    "saa_2nd_visit"
)
#  "neutrophils_mm3"    "schizocytes_percen" "erythrocyte_sedime"
to_select <- c(
    "immun_aid_identifier",
    "disease",
    "age_at_inclusion_tim",
    "gender",
    "type",
    "hb_g_d_l",
    "mean_red_cell_volume",
    "leucocytes_mm3",
    "lymphocytes_mm3",
    "neutrophils_percent",
    "eosinophils_mm3",
    "platelets_mm3",
    "cytological_signs_of",
    "evidence_of_active",
    "crp_c_reactive_prot",
    "max_crp_value_due_to",
    # "saa_serum_amyloid_a",
    # "fibrinogen_level_g",
    "total_bilirubin_mmo",
    "sodium_mmol_l",
    "potassium_mmol_l",
    # "protidemia_g_l",
    # "albuminemia_g_l",
    "creatinine_mmol_l",
    "gfr_glomerular_fil",
    "urea_mmol_l",
    "alat_ui_l",
    "alat_uln_upper_limi",
    "asat_ui_l",
    "asat_uln_ui_l",
    "ggt_ui_l",
    "ggt_uln_ui_l",
    # "alk_phosphatases_uln",
    # "ferritin_mg_l",
    # "glycosylated_ferriti",
    # "monoclonal_gammapath",
    "alk_phosphatases_ui"
)
clinic0 <- select(clinic0, -c(batch, days_from_inclusion, date_of_biological_a)) %>%
    select(-all_of(to_exclude))
# ,saa_serum_amyloid_a
clinic1 <- select(clinic, all_of(c(to_select)))
colnames(clinic0) <- str_sub(colnames(clinic0), 1, 18)
colnames(clinic1)[c(1, 3:4)] <- c("id", "age", "sex")
colnames(clinic1) <- str_sub(colnames(clinic1), 1, 18)
get_intersection0(list(A = colnames(clinic1), B = colnames(clinic0)))
clinic0[clinic0 == "Not performed"] <- NA
# save_tsv(clinic0, filename = "clinic0.temp")
# save_tsv(clinic1, filename = "clinic1.temp")
# i_rows <- which(!mapply(identical, as.numeric(clinic0$urea_mmol_l), as.numeric(clinic1$urea_mmol_l)))
```

## Extraction for Geneve lab
```{r}
clinic <- read_batches()
clinic_tot <- Reduce(rbind, clinic)
codes <- clinic_code[[3]] %>% select(!(starts_with("repeat")))
l_codes <- c()

l_codes <- c(l_codes, (codes %>% filter(str_detect(item_name, "identifier|Disease|Date of inclusion")) %>%
    filter(str_detect(group_name, "Patient information")))$column_code)
# l_codes <- c(l_codes, (codes %>% filter(str_detect(item_name, "Gender")))$column_code)

# Visite 1
## 1.7 Disease activity
vis1 <- codes %>% slice(-detect_difficulty(., "second"))
l_codes <- c(l_codes, (vis1 %>% filter(str_detect(item_name, "fatigue|global")))$column_code)
l_codes <- c(l_codes, (vis1 %>% slice(detect_difficulty(., "aidai")))$column_code)

## 2. Clinical manifestations
l_codes <- c(l_codes, (codes %>% slice(detect_difficulty(., "triggering")))$column_code)
l_codes <- c(l_codes, (vis1 %>% filter(str_detect(group_name, "Fever")))$column_code)
l_codes <- c(l_codes, (codes %>% slice(detect_difficulty(., "response to therapie")))$column_code)
l_codes <- c(l_codes, (vis1 %>% slice(detect_difficulty(., "weight loss")))$column_code)
l_codes <- c(l_codes, (codes %>% slice(detect_difficulty(., "other signs")))$column_code)

## 4.1 General biology
l_codes <- c(l_codes, (codes %>%
    filter(str_detect(item_name, "Date")) %>%
    filter(str_detect(group_name, "General biology")))$column_code)
l_codes <- c(l_codes, (vis1 %>%
    slice(detect_difficulty(., "CRP|SAA")) %>%
    filter(str_detect(group_name, "General biology")))$column_code)
l_codes <- c(l_codes, (codes %>% slice(detect_difficulty(., "\tferritin")))$column_code)
l_codes <- c(l_codes, (codes %>% slice(detect_difficulty(., "Erythrocyte")))$column_code)

## 5. Systemic therapies
sys <- codes %>% filter(str_detect(group_code, "SystemicTherapies"))
vars <- c(
    "Treatment group",
    "Date of beginning",
    "Response",
    "over",
    "Treatment category",
    "Treatment$",
    "Every",
    "[Dd]ose",
    "Period"
)
l_codes <- c(l_codes, (sys %>% filter(str_detect(item_name, paste(vars, collapse = "|"))))$column_code)

sys %>%
    filter(str_detect(item_name, "Treatment$")) %>%
    filter(str_detect(group_name, "Biologic$")) %>%
    count("item_code")
sys %>%
    filter(str_detect(item_name, "Every|Period")) %>%
    count("group_name")
unique((sys %>% slice(detect_difficulty(., "dose")))$item_name)
sys %>%
    slice(detect_difficulty(., "dose")) %>%
    count("group_name")
sys %>%
    slice(detect_difficulty(., "\tadministrated")) %>%
    count("group_name")
sys %>%
    filter(str_detect(group_name, "Corticosteroid")) %>%
    slice(detect_difficulty(., "dose")) %>%
    count("item_name")

# Visite 2 & follow up
vis2 <- codes %>% slice(detect_difficulty(., "second|followup"))
l_codes <- c(l_codes, (vis2 %>%
    slice(detect_difficulty(., "date of the visit|evolution|CRP|SAA")) %>%
    filter(!str_detect(item_name, "Persistant")))$column_code)

# Extraction codes
clinic_extraction <- clinic_tot %>% select(all_of(l_codes))
clinic_geneve <- clean_data(clinic_extraction, FALSE, FALSE)
codes_extraction <- extract_codes(colnames(clinic_geneve), clinic_code[[3]])
code_names0 <- sapply(
    seq(nrow(codes_extraction)),
    function(i) {
        paste0(
            codes_extraction[i, "item_name"],
            {
                res <- codes_extraction[i, "repeat_inds"]
                ifelse(is.na(res), "", paste0(" - ", res))
            }
        )
    }
)

code_names <- sapply(
    seq(nrow(codes_extraction)),
    function(i) {
        paste0(
            codes_extraction[i, "group_name"],
            " - ",
            code_names0[i]
        )
    }
)

i_rows <- which(code_names %>% str_detect("Biologic - Treatment"))
# code_names <- str_replace(code_names, "Biological values", "Second visit general biology")
pat <- str_replace(as.data.frame(codes_extraction[i_rows, "item_code"])[, 1], "IMA_SYSTHERAPY_TREATMENT_BIO(_TREAT_)?", "")
code_names[i_rows] <- str_trim(paste(pat, code_names[i_rows]))
i_rows <- which(code_names %>% str_detect("Biological values"))
code_names[i_rows] <- paste0(rep(c("Second visit", "Follow up"), each = 3), " general biology", str_replace(code_names[i_rows], "Biological values", ""))

t_clinic_geneve <- as_tibble(t(clinic_geneve))
colnames(t_clinic_geneve) <- clinic_geneve$C_2643_3796
t_clinic_geneve <- as_tibble(cbind(codes_extraction, t_clinic_geneve))

colnames(clinic_geneve) <- code_names

# Closest date for general biology
date_vars <- colnames(clinic_geneve)[which(find_dates(clinic_geneve))]
clinic_geneve <- update_columns(clinic_geneve, date_vars, dmy)
date_diff <- sapply(2:5, function(i) as.numeric(as.data.frame(clinic_geneve[, date_vars[1]] - clinic_geneve[, date_vars[i]])[, 1]))
date_corr <- sapply(seq(4), function(i) ifelse(abs(date_diff[, i]) > 7, NA, date_diff[, i]))
colnames(date_corr) <- paste("inclusion - general biology", seq(4))
which_min <- sapply(seq(nrow(date_corr)), function(i) which.min(abs(date_corr[i, ])))
which_min <- sapply(which_min, function(i) ifelse(length(i) == 0, 1, i))

get_min <- function(x) {
    temp <- as.data.frame(clinic_geneve[, colnames(clinic_geneve) %>% str_detect(paste0("General biology - ", x))])
    colnames(temp) <- seq(4)
    temp <- tibble(temp)
    temp[temp == "Not performed"] <- NA
    temp <- update_columns(temp, seq(4), as.numeric)
    unlist(sapply(seq(nrow(temp)), function(i) {
        res <- temp[i, which_min[i]]
        ifelse(is.na(res), ifelse(is.na(temp[i, 1]), temp[i, 2], temp[i, 1]), res)
    }))
    # View(cbind(which_min, temp, temp2))
}

vars <- c("CRP \\(", "Max CRP", "SAA", "Ferritin", "Erythrocyte")
temp <- sapply(vars, get_min)
colnames(temp) <- paste("closest", str_replace(vars, " \\\\\\(", ""))
colnames(clinic_geneve) <- code_names0
# sapply(seq(ncol(temp3)), function(i) length(which(is.na(temp3[, i]))))
clinic_geneve <- cbind(clinic_geneve, date_corr, temp)

# Output
library(openxlsx)
file_path <- file.path(golem::get_golem_wd(), "clinic_extraction.temp.xlsx")
wb <- createWorkbook()
addWorksheet(wb, "Sheet 1")
writeData(wb, "Sheet 1", clinic_geneve)
addWorksheet(wb, "Sheet 2")
writeData(wb, "Sheet 2", t_clinic_geneve)
saveWorkbook(wb, file = file_path, overwrite = TRUE)

# sapply(colnames(clinic_geneve), function(i) strsplit(i, " - ")[[1]][2:])
# common_vars <- setdiff(colnames(clinic_tot_proc), l_codes)
```

## Descriptive stats for filtered disease
```{r}
clinic0 <- read_batches()
clinic_tot0 <- Reduce(rbind, clinic0)
clinic_tot1 <- clinic_tot0 %>%
    filter(str_detect(
        C_2643_3798,
        replace_parenthesis(paste(
            c("SOJIA", "AOSD"),
            collapse = "|"
        ))
    )) %>%
    formate_immu()

data(clinic)
attributes(clinic)$codes
# extract_codes0("age_at_inclusion_tim")

clinic_tot <- clinic %>%
    filter(str_detect(
        disease,
        replace_parenthesis(paste(
            c("SOJIA", "AOSD"),
            collapse = "|"
        ))
    ))

data(clinic_qual)
# data(clinic_qual_proc)
# clinic_qual <- clinic_qual_proc
diagnose_category(clinic_qual)

get_item_name <- function(x) {
    (filter(
        clinic_code[[1]],
        str_detect(
            column_code,
            paste0("^", extract_codes0(x), "$")
        )
    )
    )$item_name
}

# persistant_systemic treatment_group
i <- "active_manifestation_2"
# will_have_a_second_v
summary_cat <- function(i) {
    df <- as.data.frame(clinic_tot[, i])[, 1] %>%
        fct_explicit_na() %>%
        as.data.frame() %>%
        set_colnames("var")
    print(diagnose_category(df))
    leg_title <- get_item_name(i)
    ggpiestats(
        df,
        var,
        label = "both",
        results.subtitle = FALSE
    ) +
        scale_fill_manual(
            values = brewer.pal(n = 9, name = "Set1"),
            na.value = "black"
        ) +
        guides(fill = guide_legend(title = leg_title)) # +
    # plot_bar(
    #     df,
    #     ggtheme = theme(
    #         strip.text.x = element_blank(),
    #         panel.border = element_blank(),
    #         panel.background = element_blank()
    #     ),
    #     theme_config = theme_perso()
    # )
}

var_cat <- c(
    "patient_ethnicity_n",
    "fathers_ethnicity",
    "mothers_ethnicity",
    "gender"
)
plot_piechart(
    clinic_tot$patient_ethnicity_n,
    colour = c("#af3e40", "#eaaab0"),
    cex = 40,
    dec = 1,
    label = FALSE
)
plot_piechart(
    clinic_tot$gender,
    colour = c("#3438a7", "#38bcbd"),
    cex = 20
)
plot_piechart(
    clinic_tot$will_have_a_second_v,
    colour = brewer.pal(9, "Paired")[7:8],
    cex = 40,
    dec = 1,
    hsize = 1.5,
    title = "",
    label = FALSE
)

df <- cut(clinic_tot$age_at_inclusion_tim, breaks = seq(0, 70, 10)) %>%
    data.frame() %>%
    set_colnames("ages")
# apyramid::age_pyramid(
#     data = df,
#     age_group = "ages",
#     split_by = "gender",
#     proportional = FALSE,
#     show_midpoint = FALSE
# ) +
#     theme_bw() +
#     scale_fill_manual(values = c("#3438a7", "#38bcbd"), na.value = "black")
data(clinic_still_raw)
summary_num <- function(i, colors = "red") {
    df <- data.frame(var = as.data.frame(clinic_tot[, i])[, 1])
    print(df$var)
    print(get_summary_stats(df)[, -1])
    print(diagnose(df)[, -1])
    print(diagnose_outlier(df)[, -1])
    plot_grid(
        gghistostats(
            data = df,
            x = var,
            results.subtitle = FALSE,
            bar.fill = "red",
            centrality.line.args = list(size = 1, color = "red")
        ) +
            theme_bw() +
            theme_perso() +
            labs(x = get_item_name(i)) +
            theme(panel.border = element_blank(), panel.grid.major = element_blank()),
        plot_violin0(pull(df, var), colour = colors) + theme(
            strip.text.x = element_blank(),
            axis.line = element_blank(),
            panel.grid.major = element_line()
        )
    )
}
# temp <- clinic_code[[1]] %>% filter(str_detect(group_code, "^IMA_NeuroManif")) ; select(clinic_tot0, temp$column_code) %>% set_colnames(temp$item_name) %>% View()
# na.omit(clinic_tot0$C_2663_3967_1) %>% str_split_fixed(" ; ", 6) %>% as.character() %>% str_subset(".+") %>% plot_bar()
# %>% as.data.frame() %>% set_colnames("x") %>% group_by(x) %>% summarise(n = n()) %>% arrange(desc(n))
# %>% as.factor() %>% fct_count() %>% arrange(desc(n))
# clinic_code[[1]] %>% filter(str_detect(group_code, "^IMA_ImpactedOrganOrSysTab")) %>% select(clinic_tot0, .$column_code) %>% set_colnames(.$item_name) %>% update_columns(colnames(.), function(i) recode_factor(i, "Yes" = 1, "No" = 0, "Unknown" = 0)) %>% update_columns(colnames(.), as.character) %>% update_columns(colnames(.), as.numeric) %>% rowSums(na.rm = TRUE)
# clinic_tot1$C_2745_4179_1 %>% fct_lump_min(min = 5, other_level = "Absence") %>% fct_count()  %>% arrange(desc(n))
# major criteria: skin_rash_other_sa, fever_38_c_104_f, leucocytes_mm3, neutrophils_mm3, eosinophils_mm3, arthralgia_myalgia
# biomarkers: crp_c_reactive_prot ferritin_mg_l (glycosylated_ferriti)
# LFT: total_bilirubin_mmo alk_phosphatases_ui alat_ui_l asat_ui_l
# cofounding: bmi_automatic, age_at_inclusion_tim
# to transform: diagnosis_day
i <- "ferritin_mg_l"
summary_num(i)
# plot_outlier(var)
# plot_violin0(clinic_tot$bmi_automatic, brewer.pal(8, "Set2")[6], size = 3)
plot_violin0(clinic_tot$age_at_inclusion_tim, brewer.pal(8, "Set2")[5], cex = 1.2, size = 3, pch_alpha = 0.75, coef = 1.5)
descriptive_stats(select(clinic_tot, age_at_inclusion_tim)) %>% View()
# Manifestations

# Parsing manifestation data
```{r}
clinic_tot1 <- clinic_tot0 %>% formate_immu()
clinic_osteo <- filter(clinic_tot0, str_detect(C_2643_3798, "osteitis")) %>% formate_immu()
vars0 <- clinic_code[[3]] %>%
    filter(str_detect(group_code, "IMA_ImpactedOrganOrSysTab"))
vars1 <- vars0 %>%
    pull(item_name) %>%
    str_replace("(\\d{1,2}. )", "") %>%
    str_replace("\\s*\\([^\\)]+\\)", "")
vars <- c("NEURO", "MUSCU", "CARDIO", "RENAL", "PULMO", "GASTRO", "ENT", "OPHTALMO", "URO", "HAEMATO")
var_names <- c("is_active", "active_description", "non_active_description", "date_non_active", rep("diagnosis", 2))

var_na <- c("null", "none", "none actually", "No sequelae", "No sequellea", "NO", "Unknown")
for (i in var_na) {
    clinic_tot1[clinic_tot1 == i] <- NA
}

# list.map(manifs, f(i) ~ {
#    list.map(c("MANIF", paste0("MANIF", c(paste0(c("_IS", "", "_NON"), "_ACTIVE"), "_NON_ACTIVE_DATE", "_DIAGNOSIS")), "OTHER_NEW_VALUE"), f(j) ~ {
#     temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(i), "Manif(Bloc|Activity|Workup)$"))) %>%
#         filter(str_detect(item_code, paste0("^IMA_", j, "$")))
#     select(clinic_tot1, temp$column_code) %>%
#         set_colnames(temp$item_name) %>%
#         clean_names() %>%
#         separate_semicolon()
#   }) %>% compact()
# }) -> tmp1

parse_manif0 <- function(x, y, z, a, b = NULL, type = 0, parse = FALSE) {
  x0 <- pull(x, column_code) %>%
            select(clinic_tot1, .) %>%
            set_rownames(ids)
    n <- ncol(x0)
    if (n > 0)
    x0 %>%
        set_colnames(rep(seq(n), n / n)) %>%
        list.parse() %>%
        list.map(f(i, it) ~ {
            temp <- list.map(
              i,
              f(j, jt) ~ {
                j <- j %>%
                str_remove_all(" \\(.+\\)") %>%
                str_replace_all("CLINICAL EXAMINATION", "Clinical examination") %>%
                str_replace_all("blood exams", "blood test") %>%
                str_replace_all("physcial examination", "Clinically") %>%
                str_replace_all("UVEITE ANTERIEURE", "Anterior uveitis") %>%
                str_replace_all("MYALGIE", "Myalgia") %>%
                str_replace_all("rthralgie", "rthralgia") %>%
                str_replace_all("rthrite", "rthritis") %>%
                str_replace_all("(Artthralgie-myalgie)|(Myalgia\\, arthralgia)|(Athralgia + myalgia)", "Arthralgia ; Myalgia") %>%
                str_replace_all("pieds gauche", "Foot left") %>%
                str_replace_all("the (lateral tibial plateau)", "\\1") %>%
                str_replace_all(" Limb", " limb") %>%
                str_replace_all("Thoracic Anterior", "Thoracic anterior") %>%
                to_title()
                if (type == 1) {
                    j <- str_remove_all(j, "[\\[\\{\\}\\]\\\"]") %>%
                      str_remove_all("x:\\d+(\\.\\d+)?,y:\\d+(\\.\\d+)?,pathId:") %>% 
                      str_replace_all("([A-Z])", " \\1") %>% 
                      str_squish() %>%
                      str_split(", ") %>%
                      pluck(1) %>% 
                      list.map(f(k) ~ if(length(k) == 1 && str_detect(k, ";")) k else str_to_sentence(k)) %>%
                      unlist() %>%
                      paste0(collapse = " ; ")
                }
              if (type == 2) {
                j <- str_to_sentence(j)
              }
              if (type == 3) {
                j <- ifelse(j == "Yes", pull(x, item_name)[jt], j)
              }
              if (type == 4) {
                j <- str_split(j, "\\$\\$") %>% pluck(1)
                if(length(j) > 1)
                  j <- j[2:1] %>% paste0(collapse = ": ")
              }
              if(type == 5 | parse) {
                pattern <- " ((\\+)|(and)|(et)) "
                if (str_detect(j, pattern))
                  j <- str_split(j, pattern) %>%
                    pluck(1) %>%
                    str_squish() %>%
                    to_title() %>%
                    paste0(collapse = " ; ")
                j <- str_remove_all(j, "\\.$")
              }
              str_split(j, " ; ") %>% set_names(z)
            }
            ) %>% purrr::discard(function(x) x %in% c("NANA", "Nana", "N a n a"))
            if (type == 3) {
              temp <- purrr::discard(temp, function(x) str_detect(x, "No"))
            }
          if(!is.null(b))
            temp <- list(temp) %>% set_names(b) %>% compact()
          list(temp) %>% set_names(a) %>% compact() %>% list(.) %>% set_names(y) %>% compact()
        }) %>%
            compact()
}

parse_manif1 <- function(x, y, z, a, type = 0, parse = TRUE) {
  if (pull(x, repeat_inds) %>% purrr::discard(is.na) %>% length(.) > 0 && pull(x, repeat_inds) %>% str_detect("\\.") %>% any()) {
    n <- pull(x, repeat_inds) %>% str_split("\\.") %>% list.map(f(i) ~ pluck(i, 1)) %>% unlist() %>% max() %>% as.numeric()
    list.map(seq(n), f(i, j) ~ filter(x, str_detect(repeat_inds, paste0(i, "\\."))) %>% parse_manif0(y, z, a, j, type = type, parse = parse)) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .)
  } else {
    parse_manif0(x, y, z, a, type = type, parse = parse)
  }
}

parse_manif <- function(x, y, z, a, type = 0, parse = TRUE) {
  id <- unique(pull(x, item_id))
  if (length(id > 1)) {
    list.map(id, f(i) ~ filter(x, item_id == i) %>% parse_manif1(y, z, a, type = type, parse = parse)) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .)
  } else {
    parse_manif1(x, y, z, a, type = type, parse = parse)
  }
}

# filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title("MUSCU")))) %>%
#     filter(str_detect(item_code, "_LOCALISATION")) %>%
#     parse_manif("MUSCU", "localisation", "manif", type = 3)  %>% pluck("8002") %>% pluck("MUSCU")

ids <- pull(clinic_tot1, C_2643_3796) %>% as.integer()
list_manif <- ids %>% setNames(ids) %>% data.frame(id = .) %>% list.parse()
list_manif <- list.map(
  vars, 
  f(x, y) ~{
list.map(
    c(paste0("MANIF", c(paste0(c("_IS", "", "_NON"), "_ACTIVE"), "_NON_ACTIVE_DATE", "_DIAGNOSIS")), "OTHER_NEW_VALUE"),
    f(i, j) ~ {
        clinic_code[[1]] %>%
            filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "Manif(Bloc|Activity|Workup)$"))) %>%
        filter(str_detect(item_code, paste0("^IMA_", i, "$"))) %>%
            parse_manif(x, var_names[j], "manif")
    }
) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .)
  }) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

# x <- "non_active_description"; list.map(tmp0, f(a) ~ list.map(a, f(b) ~ list.map(b$manif, f(d) ~ if(!is.null(d[[x]])) d[[x]] %>% compact()) %>% compact()) %>% compact()) %>% unlist() %>% unname() %>% unique()
#  x <- "diagnosis"; list.map(tmp0, f(a) ~ list.map(a, f(b) ~ list.map(b$manif, f(d) ~ list.map(d, f(e) ~ if(is.list(e) && !is.null(e[[x]])) e[[x]] %>% compact()) %>% compact()) %>% compact())%>% compact()) %>% unlist() %>% unique()
#  
list_manif <- list.map(
  vars, 
  f(x, y) ~{
        clinic_code[[1]] %>%
            filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "ManifBloc$"))) %>%
        filter(str_detect(item_code, paste0("^IMA_", x, "_MANIF$"))) %>%
            parse_manif(x, "manif", "manif", type = 4)
    }
) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

# lapply(tmp, function(x) x %>% unlist() %>% unname() %>% unique())

list_manif <- list.map(
  c("LESION_IS_ACTIVE", "ACTIVE_LESIONS", "NON_ACTIVE_LESIONS"), f(i, j) ~ {
    filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_Mucocutaneous_manifestations"))) %>%
        filter(str_detect(item_code, paste0("^IMA_MUCO_", i, "$"))) %>%
    parse_manif("MUCO", var_names[j], "manif")
  })  %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)


list_manif <- filter(clinic_code[[1]], str_detect(item_code, "^IMA_MUSCU_MANIF_ACTIVE_OSTEISIS$")) %>%
    parse_manif("MUSCU", "active_description_osteitis", "manif") %>%
  list.merge(list_manif, .)

list_manif <- list.map(vars, f(i) ~ {
   list.map(seq(2), f(j) ~ {
    temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(i), "SequellaeBloc$")))
    if(j == 1)
        temp <- filter(temp, str_detect(item_code, paste0("^IMA_", i, "_SEQUELLAE$")))
    else
        temp <- filter(temp, str_detect(item_code, paste0("^IMA_OTHER_NEW_VALUE$")))
    parse_manif(temp, i, "sequellae", "sequellae", type = 5)
  }) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .)
}) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

# list.search(list_manif, str_detect(., "Sterility"))
sympt_names <- c("symptom", "frequency")
list_manif <- list.map(vars, f(i, it) ~ {
   list.map(paste0("_FIRST_QUESTION", c("", "_FREQ")), f(j, jt) ~ {
    temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(i), "FirstQuestionBloc$")))
    if (it == 8 && jt == 1) 
      type <- 3
    else
      type <- 0
    if(it == 1)
        temp <- filter(temp, str_detect(item_code, paste0("^IMA_MANIF_DESCRIPTION$")))
    else
        temp <- filter(temp, str_detect(item_code, paste0("^IMA_", i, j, "$")))
    parse_manif(temp, i, sympt_names[jt], "symptom", type = type)
  }) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .)
}) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)


list_manif <- filter(clinic_code[[1]], str_detect(group_code, "^IMA_NeuroManifDescription$")) %>% 
  parse_manif("NEURO", "symptom", "symptom", type = 2)  %>%
  list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(group_code, "^IMA_RenalManifBloc$")) %>% 
  parse_manif0("RENAL", "manif", "manif", type = 3)  %>%
  list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(item_code, "^IMA_MANIF_DIAGNOSIS_DESCRIPTION$")) %>% 
  parse_manif("MUSCU", "diag_description", "manif")  %>%
  list.merge(list_manif, .)

list_manif <- list.map(
  c("CERVICAL_ADENITIS", "PAIN"), 
  f(i, j) ~ {
    filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_HAEMATO_MANIF_", i, "$"))) %>%
    parse_manif("HAEMATO", str_to_lower(i), "manif")
  })  %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

list_manif <- list.map(
  c("PULM_HYP", "CHRO_CAR", "AMP", "ANEURYSM"), 
  f(i, j) ~ {
    filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_CARDIO_SEQUELLAE_FOR_", i, "$"))) %>%
    parse_manif("CARDIO", str_to_lower(i), "sequellae")
  })  %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

var_names0 <- c("localisation_configuration", "localisation_number_lesion", "localisation_body_parts", "localisation_distribution", "localisation_symetry", "localisation_exposition", "localisation_other_signs", "localisation_disease_specific")
list_manif <- list.map(
 c(paste0("LESION_", c("CONF", "LOC_S_OR_M", "LOC_ON_BODY", "DISTRIBUTION_1", "DISTRIBUTION_2", "ON_SKIN", "OTHER_CLIN_SIGNS")), "DISEASE_SPEC_LESIONS"),
  f(i, j) ~ {
    filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_MUCO_", i, "$"))) %>%
  parse_manif("MUCO", var_names0[j], "manif")
  })  %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

# list.map(list_manif, f(i) ~ if(!is.null(i$NEURO)) i$NEURO) %>% compact()
# list.map(list_manif, f(i) ~ if(!is.null(i$NEURO$manif)) list.map(i$NEURO$manif, f(j) ~ j$manif) %>% compact()) %>% compact()
# list.map(list_manif, f(i) ~ if(!is.null(i$NEURO$manif)) list.map(i$NEURO$manif, f(j) ~ if(!is.null(j$manif) && str_detect(j$manif, "Cranial")) j$manif) %>% compact()) %>% compact()
# pluck(list_manif, "8002") %>% pluck("MUSCU")

list_manif <- list.map(
  vars, 
  f(x, y) ~{
        clinic_code[[1]] %>%
            filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "(Loc|Manif)"))) %>%
        filter(str_detect(item_code, paste0("^IMA_MANIF_LEFT_RIGHT_BILATERAL$"))) %>%
            parse_manif(x, "laterality", "manif")
    }
) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

list_manif <- list.map(
  vars, 
  f(x, y) ~{
        temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(x)))) %>%
        filter(str_detect(item_code, "_LOCALISATION")) %>%
          filter(!str_detect(column_code, "C_2674_4001"))
            if (y == 2) 
              type <- 1
            else if (y == 3) 
              type <- 4
            else
              type <- 0
            parse_manif(temp, x, "localisation", "manif", type = type, parse = TRUE)
    }
) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)


list_manif <- filter(clinic_code[[1]], str_detect(column_code, "^C_2720_3885")) %>%
  parse_manif("HAEMATO", "localisation", "manif", type = 1)  %>%
  list.merge(list_manif, .)

list_manif <- list.map(
  vars, 
  f(x, y) ~{
        clinic_code[[1]] %>%
            filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "Manif"))) %>%
        filter(str_detect(item_code, paste0("_TYPE|_TRANS|_DIF_INTER"))) %>%
            parse_manif(x, "type", "manif")
    }
) %>% compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
  list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(group_code, "^IMA_EntSequellaeBloc$")) %>%
filter(str_detect(item_code, paste0("^IMA_MANIF_LEFT_RIGHT_BILATERAL$"))) %>%
  parse_manif("ENT", "laterality", "sequellae")  %>%
  list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_OPHTALMO_SEQUELLAE_LEFT_RIGHT_BILATERAL_FOR"))) %>%
  parse_manif("OPHTALMO", "laterality", "sequellae") %>%
  list.merge(list_manif, .)

id_osteo <- pull(clinic_osteo, C_2643_3796) %>% as.numeric() %>% as.character()
list_manif0 <- list.filter(list_manif, id %in% id_osteo)

get_manif <- function(x, y, z = "manif", pattern = "", l = list_manif0) {
  list.map(
    l,
    f(i) ~ list.map(
      i[[x]][[z]], 
      f(j) ~ keep(j[[y]], str_detect(j[[y]], pattern))
      ) %>% compact()
    )
}

get_manif0 <- function(x, y, z = "manif", pattern = "", l = list_manif0) {
  list.map(
    l, 
    f(i) ~ list.map(
      i[[x]]$manif, 
      f(j) ~ list.map(
        j, 
        f(k) ~ if(is.list(k)) keep(k[[y]], str_detect(k[[y]], pattern)) %>% compact()
      ) %>% compact()
    ) %>% compact()
  )
}

get_occ_list <- function(x, fx = function(x) x) {
  unlist(x) %>% fx %>% sort() %>% unique() %>% sort() %>% list.map(f(i) ~ list.map(x, f(j) ~ unlist(j) %>% fx %>% str_detect(i) %>% any() %>% as.numeric())) %>% list_cbind0()
}

list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif0, f(i) ~ names(i[[x]])) %>% compact() %>% unlist() %>% unique()) %>% compact()
list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif0, f(i) ~ list.map(i[[x]]$manif, f(j) ~ list.map(j, f(k) ~ names(k)) %>% compact()) %>% compact()) %>% compact() %>% unlist() %>% unique()) %>% compact() 

(l_manifs <- list.map(vars, f(x) ~ get_manif(x, "manif") %>% get_occ_list()) %>% compact())
list.map(l_manifs, f(x) ~ apply(x, 2, function(i) sum(i, na.rm = TRUE)))

list.map(list_manif0, f(i) ~ list.map(i[["MUCO"]]$manif, f(j) ~ names(j))) %>% compact() %>% unlist() %>% unique() -> ids
var_names1 <- c("Is active ?", "Active manifestation", "Number of lesion", "Affected body parts", "Distribution", "Symetry", "Exposition", "Specific disease", "Non-active manifestation", "Configuration", "Other signs")
list.map(ids, f(i, j) ~ get_manif("MUCO", i) %>% get_occ_list(fx = function(x) str_remove_all(x, " describes.*$") %>% str_remove_all(" is.*$")) %>% plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio =5, title = var_names1[j])) -> p
plot_grid(
    plotlist = c(p[c(2, 4, 1, 3, 5:8, 11, 9:10)]),
    nrow = 4,
    ncol = 3,
    # labels = "AUTO",
    rel_heights = c(1.5, 1, 1, 0.8)
)

t_muco_manif <- get_manif("MUCO", "active_description") %>% get_occ_list() %>% apply(1, function(x) any(x == 1) %>% as.numeric()) %>% data.frame(Mucocutaneous = .)
t_local <- get_manif("MUSCU", "localisation") %>% get_occ_list(
    fx = function(x) str_replace_all(x, "(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>% str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>% str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>% str_replace_all("clavicular", "Elbow")  %>% str_replace_all("Knees", "Knee") %>% str_replace_all("(femoral)|(tibia)", "Inferior limb") %>% str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>% str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>% str_squish()) %>% select(-contains("Skull"))

x <- "MUSCU"
list.map(list_manif0, f(i) ~ list.map(i[[x]]$manif, f(j) ~ names(j))) %>% compact() %>% unlist() %>% unique() %>% purrr:::discard(function(x) str_detect(x, "\\d")) -> ids
# l_manif <- list.map(ids, f(i, j, k) ~ get_manif(x, i) %>% get_occ_list())
l_manif <- list.map(ids, f(i, j, k) ~ get_manif(x, i) %>% get_occ_list(
    fx = function(x) str_replace_all(x, "(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>% str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>% str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>% str_replace_all("clavicular", "Elbow")  %>% str_replace_all("Knees", "Knee") %>% str_replace_all("(femoral)|(tibia)", "Inferior limb") %>% str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>% str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>% str_squish()) %>% select(-contains("Skull")))
list.map(l_manif, f(i, j, k) ~ plot_bar_mcat(i, collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio =5, title = str_replace_all(k, "_", " ") %>% str_to_sentence())) %>%
plot_grid(
    plotlist = .,
    nrow = 2,
    ncol = 3
)

t_manifs <- Reduce(cbind, c(l_manif[2:4], list(t_muco_manif)))
# use_data(t_manifs, overwrite = TRUE)

get_manif0(x, "diagnosis") %>% get_occ_list() %>% plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio =5, title = "Diagnosis")

x <- "NEURO"
y <- "symptom"
list.map(list_manif0, f(i) ~ list.map(i[[x]][[y]], f(j) ~ names(j))) %>% compact() %>% unlist() %>% unique() %>%
list.map(f(i, j, k) ~ get_manif(x, i, y) %>% get_occ_list() %>% plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio =5, title = str_replace_all(k, "_", " ") %>% str_to_sentence())) %>%
plot_grid(
    plotlist = .,
    nrow = 2,
    ncol = 1
)

get_manif0(x, "diagnosis") %>% get_occ_list() %>% plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio =5, title = "Diagnosis")

list.map(list_manif0, f(i) ~ list.map(i[["MUSCU"]]$manif, f(j) ~ j$localisation)) %>% unlist() %>% str_replace_all("(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>% str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>% str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>% str_replace_all("clavicular", "Elbow")  %>% str_replace_all("Knees", "Knee") %>% str_replace_all("(femoral)|(tibia)", "Inferior limb") %>% str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>% str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>% str_squish() %>% unique() %>% sort()

get_manif("MUSCU", "localisation") %>% get_occ_list(
    fx = function(x) str_replace_all(x, "(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>% str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>% str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>% str_replace_all("clavicular", "Elbow")  %>% str_replace_all("Knees", "Knee") %>% str_replace_all("(femoral)|(tibia)", "Inferior limb") %>% str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>% str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>% str_squish()
) %>% plot_bar_mcat(collapse = TRUE, cex = 25, wrap = 35, n = 100, ratio = 2, title = "Localisation")

get_manif("MUSCU", "localisation") %>% get_occ_list() %>%  count_cat(collapse = TRUE, wrap = 1000)

# manifs <- list.map(list_manif, f(i) ~names(i)) %>% unlist() %>% unique()
list.map(c("manif", "symptom", "sequellae"), f(z) ~ {
  list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif, f(i) ~ list.map(i[[x]][[z]], f(j) ~ names(j))) %>% compact()) %>% unlist() %>% unique() %>% purrr:::discard(function(x) str_detect(x, "\\d")) %>%
  list.map(f(x) ~ list.map(manifs, f(y) ~ get_manif(y, x, z, l = list_manif)) %>% compact() %>% unlist() %>% unique() %>% sort()) %>% compact()
})

# list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif, f(i) ~ names(i[[x]])) %>% compact()) %>% compact() %>% unlist() %>% unique()
ids <- list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif, f(i) ~ list.map(i[[x]]$manif, f(j) ~ list.map(j, f(k) ~ names(k)) %>% compact()) %>% compact()) %>% compact()) %>% compact() %>%  unlist() %>% unique()
list.map(ids, f(x) ~ list.map(manifs, f(y) ~ get_manif0(y, x, l = list_manif)) %>% compact() %>% unlist() %>% unique() %>% sort()) %>% compact()
# use_data(list_manif, overwrite = TRUE)
```

```{r}
vars0 <- clinic_code[[3]] %>%
    filter(str_detect(group_code, "IMA_ImpactedOrganOrSysTab"))
vars1 <- vars0 %>%
    pull(item_name) %>%
    str_replace("(\\d{1,2}. )", "") %>%
    str_replace("\\s*\\([^\\)]+\\)", "")
manifs <- c("MUSCU", "CARDIO", "GASTRO", "HAEMATO")
# If all disease
# manifs <- c(manifs, "OPHTALMO", "OPHTALMO", "ENT")
# (PULMO) NEURO, URO
# vars <- vars1[c(1, 3:4, 7, 9, 9, 8, 11)]
vars <- vars1[c(1, 3:4, 7, 11)]
manifs <- c("MUCO_ACTIVE_LESIONS", paste0(manifs, "_MANIF"))

# plot_piechart(tmp1$MUSCU$MANIF_ACTIVE, colour = brewer_pal(, "Reds")(9)[c(3, 9, 6)], dec = 1, cex = 20, hsize = 1.6, label = FALSE, title = "Chronicity")
# plot_piechart(tmp0[[1]][[2]], colour = get_colors()[c(1, 3)], dec = 1, cex = 20, hsize = 1.6, label = FALSE, title = "Is Active?")
# plot_piechart(tmp0[[5]][[2]], colour = get_colors(), dec = 1, cex = 20, hsize = 1.6, label = FALSE, title = "Diagnostic", wrap = 20) -> p
# plot_bar_mcat(cex = 12, ratio = 2, title = "Is active ?", collapse = TRUE, colors = c(brewer.pal(8, "Set2")[5:6]))

list.map(manifs, f(i, j, k) ~{
    tmp <- immu_manif(i, df2 = clinic_tot1)
    if(!is.null(nrow(tmp)))
        plot_bar_mcat(tmp, cex = 8, ratio = 4, title = vars1[j], collapse = TRUE)
}) %>% compact() -> p
align_plots(plotlist = p[c(3, 1)], align = "vh") %>%
    plot_grid(
        plotlist = .,
        nrow = 2,
        ncol = 1,
        # labels = "AUTO",
        rel_heights = c(1.5, 1)
    )
temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_ImpactedOrganOrSysTab$")))
df_manifs0 <- select(clinic_tot1, temp$column_code) %>%
    list.map(f(i) ~ as.factor(i) %>%
        fct_recode(`0` = "No", `1` = "Yes", `NA` = "Unknown") %>%
        as.character() %>%
        as.numeric()) %>%
    list_cbind() %>%
    set_colnames(vars1)

apply(df_manifs0, 2, function(x) sum(x, na.rm = TRUE)) %>%
    as.data.frame() %>%
    set_colnames(c("N")) %>%
    kable0()

df_manifs <- list.map(manifs, f(i) ~ {
    immu_manif(i, df2 = clinic_tot1)
})
# df_manifs[[2]] <- df_manifs[[2]][, seq(3)]

# Table
ids <- pull(clinic_tot1, 2) %>% as.numeric()
still_manif <- df_manifs %>%
    list.cbind() %>%
    set_colnames(colnames(.) %>% str_remove_all(" \\(.+\\)")) %>%
    as_tibble() %>%
    mutate(ids = ids) %>%
    arrange(ids) %>%
    select(-ids) %>%
    set_rownames(ids) %>%
    cbind(df_manifs0, .)
use_data(still_manif, overwrite = TRUE)
apply(still_manif, 2, sum) %>% kable0()

p <- list.map(df_manifs, f(i, j) ~ {
    plot_bar_mcat(i, cex = 12, ratio = 3, title = vars[j])
})
align_plots(plotlist = p, align = "vh") %>%
    plot_grid(
        plotlist = .,
        nrow = 3,
        ncol = 2,
        # labels = "AUTO",
        rel_heights = c(1.7, 1, 1)
    )
# ((colSums(temp0) / nrow(temp0)) * 100) %>% round(1)
# align_plots(plotlist = c(p2[-1], p2[1])) %>% plot_grid(plotlist = ., align = "vh", nrow = 4, ncol = 2, labels = LETTERS, rel_heights = c(rep(1, 3), 1.5))
vars <- vars0 %>%
    pull(column_code) 
# vars <- filter(attributes(clinic_tot)$codes, str_detect(codes, vars)) %>% pull(name)
list.map(
    vars,
    f(i, j) ~ plot_piechart(
        clinic_osteo %>% pull(i),
        label = FALSE,
        cex = 20,
        dec = 1,
        # legend = TRUE,
        colour = get_colors()[c(1, 3)],
        threshold = 5,
        title = vars1[j],
        hsize = 1.5
    )
) %>%
    plot_grid(
        align = "vh",
        plotlist = .,
        nrow = 3,
        ncol = 4
    )

codes <- attributes(blocks_clinic_tot)$codes %>%
    filter(!str_detect(item_name, "^max_|_5$"))
codes$group_name %>%
    str_to_title() %>%
    str_replace_all("_", " ") %>%
    plot_bar_mcat(cex = 6, title = "", c("blue", "gray", "red")) +
    scale_y_continuous(expand = c(0.1, 0))

temp <- sapply(unique(codes$group_name), function(i) {
    filter(codes, group_name == i) %>%
        select(item_name) %>%
        unlist() %>%
        unname() %>%
        rename0()
})
temp <- unique(codes$group_name) %>%
    rename0(sep = "\n") %>%
    toupper() %>%
    set_names(temp, .)

names(temp)[5] <- "AIDI\nSCORE\nON 30 DAYS"
to_replace <- c("Asat", "Ggt", "Alat")
temp[[6]][temp[[6]] %in% to_replace] <- toupper(to_replace)
temp[[6]][temp[[6]] == "Neutrophils 5"] <- "Neutrophils %"

nodes <- data.frame(id = unlist(temp), size = rep(6, length(unlist(temp))))
edges <- lapply(seq_along(temp), function(i) {
    data.frame(
        from = names(temp)[i],
        to = temp[[i]],
        weight = .2
    )
}) %>% Reduce(rbind, .)

nodes <- sapply(temp, length) %>%
    data.frame(id = names(.), size = .) %>%
    list(., nodes) %>%
    Reduce(rbind, .) %>%
    rbind(., data.frame(id = " ", size = 6))

edges <- data.frame(from = " ", to = names(temp), weight = .1) %>%
    list(., edges) %>%
    Reduce(rbind, .)

# edges <- combinations(length(names(temp)), 2, names(temp)) %>%
#   set_colnames(c("from", "to")) %>%
#   data.frame(., weight = .1) %>%
#   list(., edges) %>%
#   Reduce(rbind, .)

# plot_network2(
#     x = NULL,
#     C = NULL,
#     shape = "dot",
#     dashes = FALSE,
#     color = c("white", "gray60"),
#     nodes = nodes,
#     edges = edges,
#     cex_nodes = edges$weight * 20,
#     title = paste("")
# )

lapply(seq_along(temp), function(i) {
    t(temp[[i]]) %>%
        set_colnames(temp[[i]]) %>%
        as_tibble()
}) %>%
    set_names(rename0(unique(codes$group_name), "_")) %>%
    plot_str()

tree <- FromDataFrameNetwork(edges)
tree <- as.list(tree, mode = "explicit", unname = TRUE)

# Create color for node, link and text
n <- length(temp)
p <- length(unlist(temp))
p0 <- sapply(temp, length)
colors <- brewer.pal(n = 9, name = "Set1")[c(seq(5), 8)]
cols <- lapply(seq_along(temp), function(i) rep(colors[i], p0[i])) %>% unlist()
c(rep("white", n), cols) -> linkVector
nodeVector <- c("white", colors, cols) -> textVector

# apply js
network_vector <- lapply(list(nodeVector, linkVector, textVector), function(j) {
    JS(paste0("function(d, i) { return ", paste0('["', paste(j, collapse = '", "'), '"]'), "[i]; }"))
})

diagonalNetwork(
    tree,
    fontSize = 15,
    fontFamily = "arial",
    nodeStroke = "white",
    linkColour = network_vector[[2]],
    textColour = network_vector[[3]]
)
```

## Treatments
```{r}
# Before inclusion
temp <- clinic_code[[1]] %>% filter(str_detect(group_code, "^IMA_General_treatResp"))
df <- select(clinic_tot1, temp$column_code) %>% set_colnames(temp$item_name)
df[df == "Unreported (not tested or unknown)"] <- NA

## Other biological
others <- df[!is.na(df[, 6]), 6] %>% pull(1)

## Which one
separate_semicolon(df[, 5]) -> x
sapply(
    seq(ncol(x)),
    function(i) rep(colnames(x)[i], colSums(x)[i])
) %>%
    unlist() %>%
    plot_piechart(df, label = FALSE, hsize = 1.5, title = "", dec = 1, cex = 25)

biol <- select(df, 5) %>%
    separate_semicolon() %>%
    as_tibble() %>%
    select(-3) %>%
    mutate(`Anti-JAK` = 0, `Anti-CD20` = 0)
biol[seq(2), 4] <- 1
biol[1, 5] <- 1
plot_bar_mcat(
    biol,
    title = "Which one",
    ratio = 3
)

# Response
remission_code <- c("Complete", "Partial", "No")
remission_col <- c(brewer_pal(, "Reds")(9)[c(9, 6, 3)], "gray")
vars <- c("NSAIDs", "Paracetamol", "Prednisolone", "Biologic", "Biologic which", "Biologic precise")
list.map(
    colnames(df)[1:4],
    f(i, j) ~ {
        if (j == 3) {
            cols <- remission_col[c(2, 1)]
        } else {
            cols <- rev(remission_col)[-1]
        }
        plot_piechart(
            df %>% pull(i),
            colour = c(cols, "gray"),
            label = FALSE,
            cex = 30,
            dec = 1,
            threshold = 4,
            title = vars[j],
            hsize = 1.5,
            legend = NULL
        )
    }
) %>%
    plot_grid(
        plotlist = .,
        nrow = 2,
        ncol = 2,
        align = "v"
    )

lapply(
    colnames(df)[-c(5:6)],
    function(i) count_cat(df %>% pull(i))
) %>%
    Reduce(function(i, j) left_join(i, j, by = "f"), .) %>%
    set_colnames(c("Response", vars[seq(4)])) %>%
    kable0()

# At inclusion
"IMA_SYSTHERAPY_TREATMENT_GROUP"
treatments <- immu_manif("SYSTHERAPY_TREATMENT_GROUP", df2 = clinic_tot1)
df_treat_all <- treatments[, c(3, 5)]
plot_bar_mcat(
    treatments,
    cex = 8,
    ratio = 2,
    title = "All therapies",
    c("gray", get_colors()[c(4, 8, 5, 2, 3, 1)])
)
treat_type <- treatments %>%
    colnames() %>%
    str_replace_all("\\s*\\([^\\)]+\\)", "") %>%
    str_remove_all(" inhibitors") %>%
    sort()
treat_type <- treat_type[-c(2, 7)]

immu_manif("SYSTHERAPY_TREATMENT_GROUP_OTHER_NEW_VALUE", df2 = clinic_tot0) %>%
    plot_bar_mcat(collapse = TRUE, parse = TRUE, n = 1000, wrap = 1000)
# pull(2) %>%
# str_split(", ") %>%
# pluck(1) %>%
# sort()

# immu_manif("OTHER_NEW_VALUE", df2 = clinic_tot0) %>%
#     plot_bar_mcat(collapse = TRUE, parse = TRUE, result = TRUE, n = 1000, wrap = 1000) %>%
#     slice(1) %>% pull(f) %>% str_split(", ") %>% pluck(1) %>% sort()

clinic_code[[1]] %>%
    filter(str_detect(group_code, "^IMA_SystemicTherapiesKinaseBloc$")) %>%
    immu_manif("OTHER_NEW_VALUE", df1 = ., df2 = clinic_tot1) %>%
    colnames() %>%
    str_to_title()

biologic <- c("aIL1", "aIL6", "aIFalpha", "aTNFalpha", "aCD20")
keys <- paste0("SYSTHERAPY_TREATMENT_", c("ASPI_aINF", "BIO", c(paste0(c("BIPHO", "CORTICO", "DMARDS", "KINASE", "NSAID", "OTHER"), "_TREAT"), paste0("BIO_TREAT_", biologic))))
values <- c("", treat_type[1], "", treat_type[-1], "", biologic)
greens <- brewer_pal(, "YlGn")(9)[c(4, 5, 7, 9)]
cols <- c(1, get_colors()[3], 1, get_colors()[c(1, 2, 4:5)], 1, rev(greens))
# , "ASPI_aPLAT", "Anti-platelets aggregation",
df_treat <- list.map(
    keys,
    f(i) ~ {
        res <- immu_manif(i, df2 = clinic_tot1)
        if (length(res) > 0) {
            res
        }
    }
)
p <- list.map(
    df_treat,
    f(i, j) ~ {
        if (j == 8) {
            colnames(i) <- colnames(i) %>% str_to_title()
        }
        if (j == 2) {
            cols0 <- greens
        } else if (j == 4) {
            cols0 <- brewer_pal(, "Reds")(9)[c(3, 6, 9)]
        } else {
            cols0 <- cols[j]
        }
        if (length(i) > 0) {
            plot_bar_mcat(
                i,
                cex = 8,
                ratio = 3,
                title = values[j],
                wrap = 30,
                collapse = TRUE,
                colors = c("gray", cols0),
                color_title = cols[j]
            )
        }
    }
) %>%
    compact() %>%
    list.sort(length(data$f)) %>%
    list.reverse()
plist <- c(p[2], list(NULL, NULL, NULL), p[1], list(NULL), p[4:6], p[8:10])
plot_grid(
    plotlist = plist,
    nrow = 4,
    ncol = 3,
    align = "v",
    rel_heights = c(1.7, 2, rep(1.1, 2))
)

## Others
i <- 8
immu_manif(keys[i], df2 = clinic_tot1) %>%
    plot_bar_mcat(
        cex = 12,
        ratio = 1,
        title = values[i],
        parse = TRUE,
        collapse = TRUE,
        n = 10,
        colors = c("gray", get_colors()[8])
    )

# Follow-up
remission_code0 <- c(paste0("Complete (with", c("out", ""), " flare)"), "Partial")
plot_piechart(
    clinic_tot1$C_2742_4229,
    colour = remission_col,
    label = FALSE,
    cex = 30,
    dec = 1,
    title = "",
    hsize = 1.5,
    legend = remission_code0,
    wrap = 20
)

# Second visit
plot_piechart(clinic_tot1$C_2733_4213, colour = remission_col, label = FALSE, cex = 30, dec = 1, title = "", hsize = 1.5)
temp <- clinic_code[[1]] %>%
    filter(str_detect(group_code, "^IMA_SecondVisit_General_treatResp"))
df <- select(clinic_tot1, temp$column_code) %>% set_colnames(temp$item_name)
df[df == "Unreported (not tested or unknown)"] <- NA
# diagnose_category(df)
list.map(
    colnames(df)[-c(5:6)],
    f(i, j) ~ {
        if (j == 2) {
            col <- remission_col[-c(1:2)]
            lab <- rev(remission_code)[1]
        } else {
            col <- c(rev(remission_col)[-1], "gray")
            lab <- rev(remission_code)
        }
        plot_piechart(
            df %>% pull(i),
            colour = col,
            label = FALSE,
            legend = lab,
            cex = 30,
            dec = 1,
            threshold = 4,
            title = vars[j],
            hsize = 1.5
        )
    }
) %>%
    plot_grid(
        plotlist = .,
        nrow = 2,
        ncol = 2,
        align = "v"
    )

df_manifs <- df_manifs[-c(3:4)]
df_treat <- compact(df_treat)
clinic_qual2 <- Reduce(
    cbind,
    c(
        list(df_treat_all, df_treat[[1]][, 1:2], df_treat[[2]][, 1, drop = FALSE]),
        df_manifs
    )
)
colnames(clinic_qual2) <- colnames(clinic_qual2) %>% str_remove_all(" \\(.*\\)")
rownames(clinic_qual2) <- clinic_tot1$C_2643_3796
# use_data(clinic_qual2)
```

## Treatment parsing (Emna's table)
```{r}
# Header
read.xlsx(file.path(path, "Treatment data AOSD EC.xlsx")) %>%
    head(1) %>%
    select(-starts_with("X")) %>%
    colnames()
header <- paste(c("pre", "at", "post"), "inclusion", sep = "_")

i <- c("AOSD", "SOJIA")
df <- lapply(i, function(i) {
    df0 <- read.xlsx(
        file.path(path, paste("Treatment data", i, "EC.xlsx")),
        startRow = 2,
        fillMergedCells = TRUE,
        detectDates = TRUE
    )
    colnames(df0)[seq(2)] <- c("id", "first_visit")
    df0$Date.of.beginning <- read_excel(
        file.path(path, paste("Treatment data", i, "EC.xlsx")),
        skip = 1,
        col_types = c("numeric", "date", rep("text", 6), "date", rep("text", 7))
    ) %>%
        pull(9)
    if (i == "AOSD") {
        df0$Date.of.beginning[58] <- as.Date("2021-1-1")
    }
    return(df0)
}) %>% list.rbind()
ids <- (df$id) %>% unique()
# Rename columns
colnames(df) <- colnames(df) %>%
    str_replace_all("\\.", " ") %>%
    str_remove_all(" .*")
keys <- c("Date", "N")
values <- c("beginnning_date", "nb_treatment")
for (i in seq(keys)) {
    colnames(df) <- str_replace_all(colnames(df), keys[i], values[i])
}
# colnames(df)[colnames(df) %>% duplicated() %>% which()]
keys <- c("drug", "dose")
for (i in keys) {
    colnames(df)[str_detect(colnames(df), str_to_title(i))] <- paste(i, header, sep = "_")
}
keys <- c("response", "reason", "discontinuation")
for (i in keys) {
    colnames(df)[str_detect(colnames(df), str_to_title(i))] <- paste(i, header[-2], sep = "_")
}

# Format conversion
df <- tibble(df)
df <- update_columns(df, all_of(get_name_num(df)), as.numeric)
var_cat <- c(3:5, 7, 10:14, 16)
df <- update_columns(df, var_cat, function(i) {
    as.factor(i) %>%
        str_trim() %>%
        str_to_lower() %>%
        str_remove_all(" \\(.+\\)")
})

list.map(
    colnames(df)[var_cat],
    f(i) ~ {
        pull(df, i) %>%
            str_trim() %>%
            str_to_lower() %>%
            fct_infreq() %>%
            fct_count()
    }
)

var_dates <- c(2, 9)
df <- update_columns(df, var_dates, as.character)
var_na <- c("item a corriger", "not reported", "missing")
for (i in var_na) {
    df[df == i] <- NA
}
# df <- update_columns(df, var_dates, as.Date)

var_response <- colnames(df) %>% str_which("response")
df <- update_columns(df, var_response, function(i) {
    str_replace_all(i, "n?res?pons?e", "response") %>%
        # str_replace_all("^failure$", "primary failure") %>%
        str_replace_all(".*failure", "no response") %>%
        str_replace_all("loss efficacy", "loss of efficacy")
})
list.map(colnames(df)[var_response], f(i) ~ {
    pull(df, i) %>%
        unique() %>%
        sort()
}) %>% Reduce(base::setdiff, .)

var_drug <- colnames(df) %>% str_which("^drug")
df <- update_columns(df, var_drug, function(i) {
    str_replace_all(i, "methlyprednisolone", "methylprednisolone") %>%
        str_replace_all("c[iy]closporine+$", "ciclosporine")
})
list.map(colnames(df)[var_drug], f(i) ~ pull(df, i)) %>%
    unlist() %>%
    unique() %>%
    sort()

biologic <- c("aIL1", "aIL6", "aIFalpha", "aTNFalpha", "aCD20")
keys <- paste0("SYSTHERAPY_TREATMENT_", c(c(paste0(c("BIPHO", "CORTICO", "DMARDS", "KINASE", "NSAID", "OTHER"), "_TREAT"), paste0("BIO_TREAT_", paste0(rep(biologic, each = 2), c("", "_OTHER_NEW_VALUE")))), "BIO_OTHER_NEW_VALUE"))
df_treat <- list.map(
    keys,
    f(i) ~ {
        res <- immu_manif(i, df2 = clinic_tot0)
        if (length(res) > 0) {
            res
        }
    }
)
vars <- c("Kinase", "Cortico")
df_treat <- list.map(vars, f(i) ~ {
    clinic_code[[1]] %>%
        filter(str_detect(group_code, i)) %>%
        immu_manif("OTHER_NEW_VALUE", df1 = ., df2 = clinic_tot0)
}) %>%
    setNames(toupper(vars)) %>%
    append(df_treat, .)
l_drugs <- compact(df_treat) %>%
    list.map(f(i) ~ {
        colnames(i) %>%
            str_trim() %>%
            str_to_lower() %>%
            str_replace_all("enatercept", "etanercept") %>%
            str_replace_all("methotraxate", "methotrexate") %>%
            str_replace_all("paracÃ©tamol", "paracetamol") %>%
            str_replace_all("c[iy]closporine+$", "ciclosporine") %>%
            str_replace_all("hydroxychlorquin", "hydroxychloroquin") %>%
            str_replace_all("amoxicillin.*", "amoxicilline") %>%
            sort()
    }) %>%
    list.map(. %>>% list.filter(f(i) ~ !str_detect(i, "anti|other")))

names(l_drugs) <- names(l_drugs) %>% str_remove_all("SYSTHERAPY_TREATMENT_|BIO_|_?TREAT_?")
unlist0 <- function(x) {
    unlist(x) %>%
        unname() %>%
        list()
}
l_drugs <- list.map(
    toupper(vars),
    f(i) ~ {
        l_drugs[names(l_drugs) == i] %>%
            unlist0() %>%
            pluck(1)
    }
) %>%
    c(., l_drugs[c(1, 3, 5:11)])
l_drugs[11] <- "abatacept"
get_intersection(l_drugs[7:11])
get_intersection(l_drugs[1:5])
# $`KINASE:DMARDS` [1] "methotrexate"
get_intersection(c(l_drugs[2], l_drugs[8:11]))
# $`CORTICO:aIL6` [1] "tocilizumab"
get_intersection(l_drugs[2:6])
# $`DMARDS:OTHER` [1] "ciclosporine"
l_drugs[["DMARDS"]] <- c(l_drugs[["DMARDS"]][l_drugs[["DMARDS"]] != "methotrexate"], "dmads")
l_drugs[["CORTICO"]] <- c(l_drugs[["CORTICO"]][l_drugs[["CORTICO"]] != "tocilizumab"], "corticosteroide", "methylprednisone")
l_drugs[["OTHER"]] <- c(l_drugs[["OTHER"]][l_drugs[["OTHER"]] != "ciclosporine"], "thalidomide", "tavanic")
unlist(l_drugs) %>%
    unique() %>%
    sort()
names(l_drugs)[11] <- "BIOL"
l_drugs[["BIOL"]] <- c(l_drugs[["BIOL"]], "anti-il5")
l_drugs[["NSAID"]] <- c(l_drugs[["NSAID"]], "aspirin", "nsaids")

get_intersection0(
    c(
        TOT = unlist0(l_drugs),
        DF = select(df, var_drug) %>% unlist0() %>% pluck(1) %>% unique() %>% list()
    )
) %>% pluck(1)

df <- select(df, var_drug) %>%
    list.map(f(k) ~ {
        list.map(k, f(j) ~ {
            list.map(l_drugs, f(i) ~ str_detect(i, paste0("^", j, "$")) %>% any()) %>%
                unlist() %>%
                which() %>%
                names() -> res
            ifelse(length(res) == 0, NA, res)
        }) %>%
            unlist() %>%
            unname()
    }) %>%
    Reduce(cbind, .) %>%
    set_colnames(paste0("type_", colnames(df)[var_drug])) %>%
    cbind(df, .) %>%
    select(1:3, 17, 4:8, 10, 18, 9, 11:12, 19, 13:16) %>%
    tibble()

colnames(df)[10] <- paste0("at_", colnames(df)[10])
# l_ids <- list.map(c("pre_", "at_", "post_"), f(i) ~ {c(1, colnames(df) %>% str_which(i)) %>% select(df, .) %>% list.parse() %>% list.group(id)})

Treat <- function(i) {
    list(
        id = i,
        pre_ = NULL,
        at_ = NULL,
        post_ = NULL
    )
}
l_treat <- lapply(unique(df$id), function(i) Treat(i)) %>% setNames(unique(df$id))


parse_treat <- function(i, j) {
    temp <- filter(df, id == i) %>% select(contains(c(j)))
    temp <- select(temp, 1) %>%
        pull(1) %>%
        unique() %>%
        lapply(function(i) filter(temp, temp[, 1] == i))
    temp0 <- lapply(
        temp,
        function(i) slice(i, 1) %>% select(seq(2))
    ) %>%
        setNames(list.mapv(., f(i) ~ pull(i, 1)) %>% as.list())
    lapply(temp, function(i) {
        select(i, -seq(2)) %>%
            # set_rownames(pull(., 1) %>% str_replace_na()) %>%
            list.parse()
    }) %>%
        setNames(names(temp0)) %>%
        list.merge(temp0) %>%
        c(step = j, .)
}

options("tidylog.display" = list())
for (i in as.character(unique(df$id))) {
    for (j in c("pre_", "at_", "post_")) {
        l_treat[[i]][[j]] <- parse_treat(i, j)
    }
}
options("tidylog.display" = NULL)

list.is(l_treat, "anakinra" %in% names(post_))
l_post <- list.map(l_treat, f(i) ~ pluck(i, "post_"))
# list.search(l_post, "OTHER" %in% .) %>% names() %>% str_split("\\.") %>% list.mapv(f(i) ~ pluck(i, 1))
# list.map(l_post, . %>>% list.search(. == "CORTICO") %>% names())
l_treat0 <- list.map(l_drugs, f(i) ~ {
    list.map(i, f(j) ~ {
        list.is(l_treat, j %in% names(post_)) %>% as.numeric()
    }) %>% list.cbind()
})
names(l_treat0)[c(2:4)] <- c("CORTICOID", "BIPHOSPHATE", "DMARD")
l_treat_tot <- list.map(l_treat0, f(i) ~ {
    apply(i, 1, sum) %>%
        list.mapv(f(j) ~ {
            j > 0
        }) %>%
        as.integer()
})
l_treat_biol <- l_treat_tot[7:11] %>%
    list.cbind() %>%
    apply(1, sum) %>%
    list.mapv(f(j) ~ {
        j > 0
    }) %>%
    as.integer()
var_names <- c(treat_type[c(1, 4, 2)], "Biphosphate", treat_type[c(3, 5)], "Others")
l_treat_tot0 <- c(
    Biol = list(l_treat_biol),
    l_treat_tot[-c(7:11)]
) %>%
    setNames(var_names)

# Tables
l_treat0 %>% list.map(f(i) ~ {
    apply(i, 2, sum) %>%
        keep(~ .x > 0) %>%
        sort(TRUE)
})
sapply(l_treat_tot, sum)

# Plots
plot_bar_mcat(
    l_treat0 %>% list.cbind(),
    cex = 10,
    ratio = 1,
    title = toupper("All treatments"),
    parse = TRUE,
    collapse = TRUE,
    n = 3,
    colors = c("gray", get_colors()[1])
)
ptot <- plot_bar_mcat(
    l_treat_tot0 %>% list.cbind(),
    cex = 8,
    ratio = 1.5,
    title = toupper("Type of treatment"),
    parse = FALSE,
    colors = get_colors()[c(5, 2, 4, 8, 1, 3)]
)
greens <- brewer_pal(, "YlGn")(9)[c(5, 8)]
pbiol <- plot_bar_mcat(
    l_treat_tot[7:11] %>% list.cbind(),
    cex = 8,
    ratio = 1.5,
    title = toupper("Biologic"),
    parse = FALSE,
    colors = greens
)

l_treat_tot1 <- c(l_treat_tot0, l_treat_tot[7:11] %>% setNames(biologic))
cols <- c(
    get_colors()[c(4, 1)],
    1,
    get_colors()[c(2, 5, 8)],
    greens,
    rep(1, 3)
)
p <- list.map(
    l_treat0,
    f(i, j, k) ~ {
        # if (j == 8) {
        #     colnames(i) <- colnames(i) %>% str_to_title()
        # }
        if (j %in% c(1, 4, 5)) {
            cols0 <- cols[j]
            # } else if (j == 4) {
            #     cols0 <- brewer_pal(, "Reds")(9)[c(3, 6, 9)]
        } else {
            cols0 <- "gray"
        }
        if (sum(i) > 0) {
            plot_bar_mcat(
                i,
                cex = 8,
                ratio = 1.5,
                title = k,
                wrap = 10,
                collapse = TRUE,
                colors = c(cols0, cols[j]),
                color_title = cols[j]
            )
        }
    }
) %>%
    compact() %>%
    list.sort(length(data$f)) %>%
    list.reverse()
plist <- c(list(ptot), p[seq(2)], list(pbiol), p[3:4], p[5:7])
plot_grid(
    plotlist = plist,
    nrow = 3,
    ncol = 3,
    align = "v",
    rel_heights = c(2, 1.5, 1)
)

i_tab <- which(sapply(l_treat_tot, sum) > 2)

still_treatment <- list.map(l_treat_tot[i_tab], f(i) ~ tibble(i)) %>%
    list.cbind() %>%
    set_colnames(c("JAK", "Corticosteroid", "Other", paste0("Anti-IL", c(1, 6)))) %>%
    set_rownames(ids) %>%
    cbind(., Anakinra = l_treat0[["aIL1"]][, 1])
use_data(still_treatment, overwrite = TRUE)
```

# Descripve stats for osteitis
```{r}
path_out <- file.path(get_golem_wd(), "inst", "results")
osteitis_file <- file.path(path_out, "tsv", "osteitis.xls")
write_excel <- function(x, col_names = TRUE, file = osteitis_file) {
    write_tsv(x, file = file, append = TRUE, col_names = col_names)
}
print_excel <- function(x, file = osteitis_file) {
    data.frame(c("", x)) %>% write_excel(FALSE, file = file)
}

clinic0 <- read_batches()
clinic_tot0 <- Reduce(rbind, clinic0) %>% formate_immu()
clinic_osteo <- filter(clinic_tot0, str_detect(C_2643_3798, "osteitis")) %>% formate_immu()
clinic_osteo <- mutate(clinic_osteo, adult = ifelse(clinic_osteo$C_2643_3803 > 18, "Adult", "Children"))

# Missing data
# Convert some modalities into NA
var_na <- c("Unknown", "UNKNOWN", "ND", "Not applicable", "Unreported (not tested or unknown)", "Not performed")
for (i in var_na) {
    clinic_osteo[clinic_osteo == i] <- NA
}

select(clinic_osteo, adult) %>%
    formatting_descriptive_cat()
list_tables <- list()

list_tables[[1]] <- filter(clinic_osteo, adult == "Adult") %>%
    select(c("C_2650_3916")) %>%
    set_colnames(colnames(.) %>% get_var_names(y = clinic_code[[3]]))

list_tables[[2]] <- filter(clinic_osteo, adult == "Children") %>%
    select(c("C_2657_3930", "C_2657_3931", "C_2653_3917", "C_2654_3919")) %>%
    set_colnames(colnames(.) %>% get_var_names(y = clinic_code[[3]]))

list_tables[[3]] <- select(clinic_osteo, c("C_2657_3933", "C_2733_4213", "C_2742_4229")) %>%
    set_colnames(colnames(.) %>% get_var_names(y = clinic_code[[3]]))

list_tables[[6]] <- select(clinic_osteo, c("C_2739_3934", "C_2739_3935", "C_2739_3936", "C_2658_3934", "C_2658_3935", "C_2658_3936")) %>%
    set_colnames(
        colnames(.) %>%
            get_var_names(y = clinic_code[[3]]) %>%
            str_remove_all(" \\(.*\\)") %>%
            str_remove_all(" of disease activity") %>%
            str_to_sentence() %>%
            paste0(c(rep(" (Second visit)", 3), rep("", length(.) - 3)))
    )

# General biology
temp <- select(clinic_osteo, all_of(c("C_2643_3801", "C_2643_3802", paste0("C_2728_4054_", seq(4)))), "C_2742_4210") %>%
    update_columns(., colnames(.), dmy) %>%
    mutate(date_diff1 = C_2643_3801 - C_2728_4054_1, date_diff2 = C_2643_3801 - C_2728_4054_2, date_diff3 = ifelse(date_diff1 < date_diff2 | is.na(date_diff2), date_diff1, date_diff2), date_diff4 = ifelse(date_diff3 > 7, NA, date_diff3), date_diff5 = ifelse(date_diff3 > 7, 0, 1), date_diff6 = date_diff1 - date_diff2)
select(temp, date_diff5) %>% plot_piechart(wrap = 7, hsize = 1.5, cex = 25, title = "", legend = FALSE, label = FALSE, colour = c(get_colors()[2:1], "gray"))

which(temp$date_diff2 == 0) %>%
    slice(clinic_osteo, .) %>%
    pull(2)
bind_cols(
    which(temp$date_diff5 == 0) %>% slice(clinic_osteo, .) %>% pull(2),
    which(temp$date_diff5 == 0) %>% slice(temp, .) %>% pull(date_diff3)
) %>%
    set_colnames(c("ID", "Date")) %>%
    kable0(rownames = FALSE)

clinic_osteo_biol <- which(temp$date_diff5 > 0 | is.na(temp$date_diff5)) %>% slice(clinic_osteo, .)

# temp1 <- filter(temp, (date_diff5 == 1 | is.na(date_diff5)))
# sapply(seq(nrow(cou)), function(l) ifelse(slice(temp1, l) %>% pull(date_diff5) > 0, slice(cou, l) %>% pull(1), slice(cou, l) %>% pull(2)))
# !is.na(temp1$C_2728_4054_2)
#
# sapply(seq(nrow(cou)), function(l) ifelse(slice(temp1, l) %>% pull(C_2728_4054_2) %>% is.na(), slice(cou, l) %>% pull(1), slice(cou, l) %>% pull(2)))

# clinic_code[[1]] %>% filter(str_detect(group_code,"^IMA_SecondVisit")) -> temp2; pull(temp2, column_code) %>% select(clinic_osteo, .) %>% set_colnames(pull(temp2, item_name)) %>% View()

visits <- c("^IMA_BiologicalValuesGeneralBloc", "^IMA_SecondVisit")
vars <- c("Type", "Hb", "Platelets", "Lymphocytes", "Leucocytes", "Neutrophils \\(/m", "CRP", "Erythrocyte", "SAA")
temp1 <- list.map(visits, f(i, k) ~ {
    if (k == 1) {
        clinic_osteo <- clinic_osteo_biol
    }
    list.map(vars, f(j) ~ {
        clinic_code[[1]] %>%
            filter(str_detect(group_code, i)) %>%
            filter(str_detect(item_name, paste0("^", j))) %>%
            slice(1) %>%
            pull(column_code) %>%
            select(clinic_osteo, .) %>%
            set_colnames(j)
    }) %>% Reduce(cbind, .)
})

list_tables[[6]] <- temp1[[1]][, -1] %>%
    tibble() %>%
    update_columns(., seq(ncol(.)), as.numeric) %>%
    set_colnames(colnames(.) %>% str_remove_all(" .*")) %>%
    list() %>%
    c(list_tables[6]) %>%
    list.map(f(i) ~ mutate(i, id = seq(nrow(i)))) %>%
    Reduce(full_join, .) %>%
    select(-id)
list_tables[[4]] <- temp1[[1]][, 1, FALSE] %>%
    tibble() %>%
    update_columns(., seq(ncol(.)), as.factor) %>%
    set_colnames("Flare")

list_tables[[6]] <- temp1[[2]][, 1, FALSE] %>%
    tibble() %>%
    update_columns(., seq(ncol(.)), as.numeric) %>%
    set_colnames("CRP (Second visit)") %>%
    cbind(list_tables[[6]], .)

# Manifestations
temp <- clinic_code[[1]] %>%
    filter(str_detect(item_code, "^IMA_MUCO_"))
#  select(clinic_tot1, temp$column_code) %>% set_colnames(temp$item_name) %>% View()
# select(clinic_osteo, temp$column_code) %>%
#     set_colnames(temp$item_name) %>%
#     View()
# Ex for Still: line 6. Only difference = particular body part. But macules are on the abdomen for both !

manifs0 <- c("GASTRO", "URO", "OPHTALMO", "PULMO")
manifs1 <- c("MUSCU", "CARDIO", "HAEMATO", "ENT", manifs0) # "NEURO",
manifs <- c("MUCO_ACTIVE_LESIONS", paste0(manifs1, "_MANIF"), paste0(manifs0, "_FIRST_QUESTION"))
vars <- paste(c("Mucocutaneous", "Musculoskeletal", rep(NA, 7), "Gastrointestinal"), "manifestations")
list_tables[[5]] <- list.map(manifs, f(i, j) ~ {
    immu_manif(i, df2 = clinic_osteo) %>%
        descriptive_mcat_immun(vars[j])
}) %>%
    keep(function(x) nrow(x) > 0) %>%
    list.rbind()

temp <- clinic_code[[1]] %>%
    filter(str_detect(item_code, "^IMA_MUSCU_MANIF_LOCALISATION"))
# select(clinic_tot1, temp$column_code) %>%
#     set_colnames(temp$item_name) %>%
#     View()

list_tables[[5]] <- clinic_code[[1]] %>%
    filter(str_detect(group_code, "^IMA_Muscu")) %>%
    filter(str_detect(item_code, "IMA_MANIF_DIAGNOSIS$")) %>%
    pull(column_code) %>%
    select(clinic_osteo, .) %>%
    collapse_mcat() %>%
    descriptive_mcat_immun("Musculoskeletal diagnosis") %>%
    bind_rows(list_tables[[5]])

cbind_list <- function(x, y = list_tables[[5]]) {
    keep(x, function(i) nrow(i) > 0) %>%
        list.rbind() %>%
        bind_rows(y) %>%
        arrange(Variables)
}

vars <- c(paste("Mucocutaneous", c("localisation", "distribution")), "Musculoskeletal sequelae")
list_tables[[5]] <- list.map(c("C_2664_3971_1", "C_2664_3972_1", "C_2677_4004_1"), f(i, j) ~ {
    select(clinic_osteo, all_of(i)) %>%
        separate_semicolon() %>%
        descriptive_mcat_immun(vars[j])
}) %>% cbind_list()

temp <- clinic_code[[1]] %>%
    filter(str_detect(item_code, "^IMA_MUSCU_MANIF_LOCALISATION"))
var_muscu <- pull(temp, item_code) %>%
    str_remove_all("IMA_MUSCU_MANIF_LOCALISATION_FOR_") %>%
    unique() %>%
    tolower() %>%
    str_replace_all("((other)|(bilateral)).*", "(\\1)")
select(clinic_osteo, temp$column_code) %>%
    set_colnames(temp$item_name) %>%
    tibble(.name_repair = c("unique")) -> cou

list_tables[[5]] <- list.map(
    # var_muscu,
    seq(1, 36, 3),
    f(i, j) ~ {
        temp0 <- select(cou, i:(i + 2)) %>%
            update_columns(1:3, function(x) {
                str_remove_all(x, "\"[xy]\":\\d*.\\d*,") %>%
                    str_remove_all("\\{\"pathId\":\"") %>%
                    str_remove_all("\\[|\\]|(\"\\})") %>%
                    str_replace_all(",", " ; ")
            }) %>%
            separate_semicolon(collapse = FALSE) %>%
            list.cbind() %>%
            update_columns(1:ncol(.), function(x) {
                snakecase::to_any_case(x, case = "sentence", unique_sep = NULL) %>% str_replace_all("Null", "NA")
            })
        if (j < 3) {
            temp0 <- temp0 %>% update_columns(1:ncol(.), function(x) str_remove_all(x, " .*"))
        }
        collapse_mcat(temp0) %>%
            descriptive_mcat_immun(paste("Musculoskeletal location for", var_muscu[j]), wrap = 50)
    }
) %>% cbind_list()

# list.map(as.list(manifs), f(i, j) ~{
#     immu_manif(i, df2 = clinic_tot1) %>%
#         plot_bar_mcat(cex = 8, ratio = 4, title = vars[j])
# }) -> p
# align_plots(plotlist = p, align = "vh") %>%
#     plot_grid(
#         plotlist = .,
#         nrow = 3,
#         ncol = 3,
#         # labels = "AUTO",
#         rel_heights = c(1.5, 1, 0.6)
#     )

# Write in excel
titles <- c("Adult only", "Children only", "All patients", "", "", "")
col_names <- c(rep(TRUE, 3), FALSE, TRUE, FALSE)
list.map(list_tables, f(i, j) ~ {
    if (j %in% c(1:3, 6)) {
        print_excel(titles[j])
    }
    if (j %in% c(1, 6)) {
        i <- descriptive_num_immun(i)
    } else if (j == 5) {
        i
    } else {
        i <- descriptive_cat_immun(i)
    }
    write_excel(i, col_names = col_names[j])
})

list.map(list_tables, f(i, j) ~ {
    if (j %in% c(1:3, 6)) {
        print_excel(titles[j], file = paste0(osteitis_file, "2"))
    }
    if (j %in% c(1, 6)) {
        i <- formatting_descriptive_num(i)
    } else if (j == 5) {
        i <- mutate(i, stat = paste0(Levels, " (", `%`, "%)")) %>%
            group_by(Variables) %>%
            summarise(Levels = paste(stat, collapse = "; "))
    } else {
        i <- formatting_descriptive_cat(i)
    }
    write_excel(i, file = paste0(osteitis_file, "2"), col_names = col_names[j])
})

# list.map(c(osteitis_file, paste0(osteitis_file, "2")), f(i) ~ read_tsv(i, skip = 1, col_names = FALSE))
# sheets <- c("Raw", "Formatted")
# wb <- createWorkbook()
# for (i in seq_along(sheets)) {
#     addWorksheet(wb, sheets[i])
#     writeData(wb, sheets[i], list_tables[[i]])
# }
# saveWorkbook(wb, file = paste0(osteitis_file, "x"), overwrite = TRUE)
# list.map(c(osteitis_file, paste0(osteitis_file, "2")), file.remove)
```

# Parsing treatments
```{r}
# clinic_tot1 <- clinic_osteo
parse_treat0 <- function(x, y = "Date", type = FALSE) {
    n <- select(clinic_tot1, starts_with("C_2745_4141_")) %>% ncol()
    x %>%
        set_colnames(rep(seq(n), ncol(.) / n)) %>%
        list.parse() %>%
        list.map(f(i) ~ {
            discard(i, is.na) %>%
                list.map({
                    temp <- str_remove_all(., " \\(.+\\)") %>% str_remove_all("\\(s\\)")
                    if (type > 0) {
                        temp <- str_to_sentence(temp)
                    }
                    if (type == 2) {
                        for (i in c("il", "cd", "tnf")) {
                            temp <- str_replace_all(temp, paste0("Anti[- ](", i, ") ?(\\d{1,2}|Î±)$"), paste0("Anti-", toupper(i), "\\2"))
                        }
                    } else if (type == 3) {
                        temp <- str_replace_all(temp, "Antibiot(ic|ique|herapie)", "Anti-biotic") %>%
                            str_replace_all("(Antihistamine)s?", "\\1") %>%
                            str_replace_all("Betebloquant", "Betablocker") %>%
                            str_replace_all("(Calcium).*", "\\1 antagonist") %>%
                            str_replace_all(".*[Cc][iy]closporine?$", "Ciclosporine") %>%
                            str_replace_all("ParacÃ©tamol", "Paracetamol") %>%
                            str_replace_all("Immunosup+res+(ant|eur|or).?$", "Immunosuppressant") %>%
                            str_replace_all("Vit(amin)? (\\w)( 800 iu)?", "Vitamin \\2") %>%
                            str_replace_all("Inteferon alpha", "Other") %>%
                            str_replace_all("(Anti) ", "\\1-") %>%
                            str_replace_all("(Methotrexate) po", "\\1") %>%
                            str_replace_all("(Colchicin)e", "\\1") %>%
                            str_replace_all("Enatercept", "Etanercept") %>%
                            str_replace_all("Flunarazine|Flunarizina", "Flunarizine") %>%
                            str_replace_all("((Anti-plate?let)s?( aggregation)?)|(Antiagregent plaquettaire)", "Anti-platelets aggregation")
                    } else if (type == 4) {
                        temp <- str_replace_all(temp, "Month\\(s\\)", "Month")
                    }
                    list(temp) %>% set_names(y)
                })
        })
}

parse_treat2 <- function(x, y = "Date", type = FALSE) {
    n <- select(clinic_tot1, starts_with("C_2745_4141_")) %>% ncol()
    set_colnames(x, seq(n)) %>%
        list.parse() %>%
        list.map(f(i) ~ {
            temp <- set_names(i, y) %>% discard(is.na)
        })
}
# TODO: check whithout str_to_sentence to see the uppercase abbrevations
# str_replace_all("enatercept", "etanercept") %>%
# str_replace_all("methotraxate", "methotrexate") %>%
#
# str_replace_all("hydroxychlorquin", "hydroxychloroquin") %>%
# str_replace_all("amoxicillin.*", "amoxicilline") %>%

vars <- paste0("IMA_SYSTHERAPY_TREATMENT_", c("BEGIN_DATE", paste0("GROUP", c("", "_OTHER_NEW_VALUE")), "OVER", "RESP", paste0("STOP_", c("DATE", paste0("REASON", c("", "_OTHER_NEW_VALUE", "_SIDE_EFFECTS"))))))
# "Date",
var_names0 <- c("Date of beginning", "Type", "Drug name", "Discontinuation", "Response", "Date of discontinuation", paste0("Reason for discont.", c("", " (other)", " (side effect(s))")))
ids <- pull(clinic_tot1, C_2643_3796) %>% as.integer()
list_treat <- list.map(
    vars,
    f(i, j) ~ {
        temp <- clinic_code[[1]] %>%
            filter(str_detect(item_code, paste0("^", i, "$"))) %>%
            pull(column_code) %>%
            select(clinic_tot1, .) %>%
            set_rownames(ids)
        if (j %in% c(1, 6)) {
            # temp <- update_columns(temp, 1:30, dmy)
        }
        if (j == 2) {
            type <- 0
        } else if (j == 3) {
            type <- 3
        } else {
            type <- 1
        }
        parse_treat0(temp, var_names0[j], type = type)
    }
) %>% Reduce(function(x, y) list.merge(x, y), .)

list.map(list_treat, f(i) ~ list.map(i, f(j) ~ j[names(j) == "Drug name"]) %>% compact()) %>%
    compact() %>%
    unlist() %>%
    unname() %>%
    sort() %>%
    unique()

temp <- clinic_code[[1]] %>%
    filter(str_detect(group_code, "^IMA_SystemicTherapiesAspiBloc"))
# select(clinic_tot0, temp$column_code) %>%
#     set_colnames(temp$item_name) %>%
#     View()

treats0 <- c("ASPI", "NSAID", "CORTICO", "COLCH", "BIPHO", "IVIG", "DMARDS", "BIO", "KINASE", "OTHER")
treats <- paste0("IMA_SYSTHERAPY_TREATMENT_", c(paste0(treats0, "_"), ""))
vars <- c("((PRECISION)|(TREAT))", "((aINF)|(aPLAT)|(DOSE))", paste0("DOSE_", c("INITIAL", "MAX")), "FREQUENCY", "DURATION")
var_names1 <- c("Drug name", paste(c("Administrated", "Initial", "Maximal"), "dose"), "Frequency", "Period")
list_treat <- list.map(
    treats,
    f(i, j) ~ {
        list.map(
            paste0(i, vars),
            f(k, l) ~ {
                temp <- clinic_code[[1]] %>%
                    filter(str_detect(item_code, paste0("^", k, "$"))) %>%
                    pull(column_code) %>%
                    select(clinic_tot1, .) %>%
                    set_rownames(ids)
                if ((j == 1 || j == 8) && l == 1) {
                    key <- "Subtype"
                } else {
                    key <- var_names1[l]
                }
                if (l == 1) {
                    type <- 3
                } else {
                    type <- 1
                }
                if (ncol(temp) > 0) {
                    parse_treat0(temp, key, type)
                }
            }
        )
    }
) %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_treat, .)

temp <- list.map(c("Corticosteroid", "Kinase inhibitors"), f(i) ~ {
    clinic_code[[1]] %>%
        filter(str_detect(group_name, paste0("^", i, "$"))) %>%
        filter(str_detect(item_code, "IMA_OTHER_NEW_VALUE")) %>%
        pull(column_code) %>%
        select(clinic_tot1, .) %>%
        set_rownames(ids) %>%
        parse_treat0("Drug name", type = 3) %>%
        compact()
}) %>% Reduce(function(x, y) list.merge(x, y), .)
if (length(temp) > 0) {
    list_treat <- list.merge(list_treat, temp)
}

list_treat <- list.map(c("Aspirin", "IVIG", "Colchicin"), f(k) ~ list.map(list_treat, f(i) ~ list.map(i, f(j) ~ if (j$Type == k) list(j$Type) %>% set_names("Drug name")) %>% compact()) %>% compact()) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_treat, .)

list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ if (j$Type == "Aspirin") TRUE) %>% compact()) %>% compact()
list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ if (j$Type == "Biologic" && !is.null(j$Subtype)) TRUE) %>% compact()) %>% compact()

treats0 <- c("aIFalpha", "aIL1", "aIL6", "aTNFalpha", "aCD20")
treats <- paste0("IMA_SYSTHERAPY_TREATMENT_BIO", c("", paste0("_TREAT_", treats0)))
vars <- c("", "_OTHER_NEW_VALUE")
list_treat <- list.map(
    treats,
    f(i, j) ~ {
        list.map(
            paste0(i, vars),
            f(k, l) ~ {
                temp <- clinic_code[[1]] %>%
                    filter(str_detect(item_code, paste0("^", k, "$"))) %>%
                    pull(column_code) %>%
                    select(clinic_tot1, .) %>%
                    set_rownames(ids)
                if (j == 1 && l == 1) {
                    key <- "Subtype"
                    type <- 2
                } else {
                    key <- "Drug name"
                    type <- 3
                }
                if (ncol(temp) > 0) {
                    parse_treat0(temp, key, type)
                }
            }
        )
    }
) %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_treat, .)

# NSAID dose = Dose (not administrative)
# IVG : period = month
# Other
# Verif si chaque case de date pour les traitements generaux ne correspond pas a plusieurs cases pour chaque different traitement
# Abatacept, Canakinumab, Enatercept in Group
for (x in c("Drug name", "Type", "Discontinuation", "Response", "Reason for discont.", "Reason for discont. (other)", "Subtype")) {
    cat("\n***\n")
    list.map(list_treat, f(i) ~ list.map(i, f(j) ~ j[names(j) == x]) %>% compact()) %>%
        compact() %>%
        unlist() %>%
        unname() %>%
        sort() %>%
        unique() %>%
        print()
}

# sub <- list.map(list_treat, f(i) ~ list.map(i, f(j) ~ j[names(j) == "Subtype" & j %in% c("Abatacept", "Canakinumab", "Enatercept")]) %>% compact()) %>%
#     compact() %>%
#     list.map(f(i) ~ list.map(i, f(j) ~ setNames(j, "Drug name")))
# list_treat <- list.merge(sub, list_treat)
# for (i in names(sub)) {
#     for (j in names(sub[[i]])) {
#         if (sub[[i]][[j]]$`Drug name` == "Canakinumab") {
#             type <- "Anti-IL1"
#         } else {
#             type <- "Anti-TNFÎ±"
#         }
#         list_treat[[i]][[j]]$Subtype <- type
#     }
# }

list_other <- list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) && j$Type == "Other") %>% list.map(f(k) ~ k$`Drug name`)) %>%
    compact() %>%
    unlist() %>%
    unique()

list.map(list_other, f(x) ~ list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) && j$`Drug name` == x) %>% list.map(f(k) ~ k$Type)) %>%
    compact() %>%
    unlist() %>%
    unique())

list_bio_other <- list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) && j$Subtype == "Other") %>% list.map(f(k) ~ k$`Drug name`)) %>%
    compact() %>%
    unlist() %>%
    unique()

l_bio_other <- list.map(list_bio_other, f(x) ~ list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) && j$`Drug name` == x) %>% list.map(f(k) ~ k$Subtype)) %>%
    compact() %>%
    unlist() %>%
    unique()) %>% 
  keep(function(x) length(x) > 1) %>% 
  list.map(f(i) ~ i[i != "Other"])



list.map(l_bio_other, f(x, y, z) ~ list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) & j$Subtype == "Other" & j$`Drug name` == z)) %>% compact())

list_treat <- list.map(l_bio_other, f(x, y, z) ~ list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) & j$Subtype == "Other" & j$`Drug name` == z)) %>% compact() %>% list.map(f(j) ~ list.map(j, f(k) ~ list(Subtype = x)))) %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_treat, .)

if (!is.null(list_treat[["7006"]])) {
    list_treat[["7006"]][["2"]]$Type <- "DMARDs"
}

if (!is.null(list_treat[["5006"]])) {
    list_treat[["5006"]][["3"]]$Type <- "Colchicin"
    list_treat[["5006"]][["4"]]$Type <- "Colchicin"
}

if (!is.null(list_treat[["7004"]])) {
    list_treat[["7004"]][["1"]]$Type <- "Biologic"
    list_treat[["7004"]][["1"]]$Subtype <- "Anti-IL6"
}

list_treat <- list.map(list_treat, f(i) ~ {
    list.sort(i, dmy(`Date of beginning`) %>% as.character())
})

if (!is.null(list_treat[["4024"]])) {
    list_treat[["4024"]][["3"]]$Type <- "Biologic"
    list_treat[["4024"]][["3"]]$Subtype <- "Other"
}

if (!is.null(list_treat[["17005"]])) {
    list_treat[["17005"]][["3"]]$Type <- "Other"
}
```

```{r}
reformat_dose <- function(x) {
    if (is.null(x$`Administrated dose`) || str_detect(x$`Administrated dose`, "^0$")) {
        NA
    } else if (!is.null(x$Frequency) && as.numeric(x$Frequency) != 1 && x$Type == "IVIG") {
        if (is.null(x$Period)) {
              str_glue("{x$`Administrated dose`}g/kg every {x$Frequency} days")
          } else {
              str_glue("{x$`Administrated dose`}g/kg every {x$Frequency} {tolower(x$Period)}s")
          }
    } else if (x$Type == "Aspirin") {
        x$`Administrated dose`
    } else if (x$Type %in% c("Colchicin", "NSAIDs")) {
        str_glue("{x$`Administrated dose`}mg/day")
    } else if (is.null(x$Frequency)) {
        str_glue("{x$`Administrated dose`}mg")
    } else if (as.numeric(x$Frequency) != 1) {
        str_glue("{x$`Administrated dose`}mg every {x$Frequency} {tolower(x$Period)}s")
    } else {
        str_glue("{x$`Administrated dose`}mg/{tolower(x$Period)}")
    }
}

list_treat <- list.map(list_treat, f(i) ~ list.map(i, f(j) ~ ifelse(!is.null(j$`Administrated dose`), reformat_dose(j), "Missing") %>% 
list() %>% set_names("Administrated dose"))) %>%
    list.merge(list_treat, .)

visits <- paste("Date of the", c(paste0(c("1st", "2nd"), " visit"), "follow-up"))
vars <- c("C_2643_3796", "C_2643_3802", "C_2733_4210", "C_2742_4210", "C_2643_3798", "C_2643_3799")
var_names <- c("ID", visits, "Disease", "Eligible for a 2nd visit")
list_date <- list.map(
    vars,
    f(i, j) ~ {
        temp <- clinic_code[[1]] %>%
            filter(str_detect(column_code, paste0("^", i, "$"))) %>%
            pull(column_code) %>%
            select(clinic_tot1, .) %>%
            set_rownames(ids) %>%
            parse_treat2(var_names[j], type = 1)
    }
) %>% Reduce(function(x, y) list.merge(x, y), .)

list_treat <- list.merge(list_treat, list_date)

# post <- list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ if(is.list(j)) is.null(j[["Date of discontinuation"]])))
# pre <- list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ if(is.list(j)) dmy(j[["Date of beginning"]]) < dmy(i[["Date of inclusion"]])))
# at <- list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ if(is.list(j)) dmy(j[["Date of beginning"]]) < dmy(i[["Date of the 1st visit"]])))

list_treat <- list.map(
  c("Date of the 2nd visit", "Date of the follow-up", "Eligible for a 2nd visit"), f(i) ~ {
  list.map(
    list_treat, f(j) ~ {
      if (is.null(j[[i]])) {
          list("NA") %>% set_names(i)
      }
      }) %>% compact()
}) %>% 
  Reduce(function(x, y) list.merge(x, y), .) %>% 
  list.merge(list_treat, .)
  
list_treat00 <- list.map(list_treat, f(i) ~ list.class(i, f(j) ~ if (is.list(j)) {
  if (is.null(j[["Date of discontinuation"]])) {
    if (i[["Eligible for a 2nd visit"]] != "NA" && i[["Eligible for a 2nd visit"]] == "Yes") {
      if (i[["Date of the 2nd visit"]] != "NA" && !is.null(j[["Date of beginning"]]) && dmy(j[["Date of beginning"]]) >= dmy(i[["Date of the 2nd visit"]])) return(c("Ongoing at V1", "Ongoing at V2", "Post V2"))
        else return(c("Ongoing at V1", "Ongoing at V2"))
      } else return("Ongoing at V1")
  }
  else if (dmy(j[["Date of discontinuation"]]) < dmy(i[["Date of the 1st visit"]])) return("Pre-inclusion")
  else if (i[["Date of the 2nd visit"]] != "NA") {
 if (!is.null(j[["Date of beginning"]]) && dmy(j[["Date of beginning"]]) >= dmy(i[["Date of the 2nd visit"]])) {
   # if (dmy(j[["Date of discontinuation"]]) >= dmy(i[["Date of the 2nd visit"]])) {
   #    if (!is.null(j[["Date of the 1st visit"]]) && dmy(j[["Date of discontinuation"]]) >= dmy(i[["Date of the 1st visit"]])) return(c("Ongoing at V1", "Ongoing at V2", "Post V2"))
   #  else return(c("Ongoing at V2", "Post V2"))
   #  } else 
      return("Post V2")
 } else {
    if (dmy(j[["Date of discontinuation"]]) >= dmy(i[["Date of the 2nd visit"]])) {
      if (!is.null(i[["Date of the 1st visit"]]) && dmy(j[["Date of discontinuation"]]) >= dmy(i[["Date of the 1st visit"]])) return(c("Ongoing at V1", "Ongoing at V2"))
    else return("Ongoing at V2")
    }
 }
  } else if (!is.null(i[["Date of the 1st visit"]]) && dmy(j[["Date of discontinuation"]]) >= dmy(i[["Date of the 1st visit"]])) return("Ongoing at V1")
} else {
    return("Patient")
}))

list_treat00 <- list.map(list_treat00, f(i) ~ {
    if (!is.null(i$`Pre-inclusion`)) {
        list.map(i$`Pre-inclusion`, f(j) ~ j$`Drug name`) %>%
            unlist() %>%
            unique() %>%
            length() %>%
            list() %>%
            set_names("N previous treatment") %>%
            list(Patient = .)
    } else list(Patient = list(`N previous treatment` = 0))
}) %>%
    compact() %>%
    list.merge(list_treat00, .)

list_treat0 <- list.map(list_treat00, f(i) ~ list.map(i, f(j) ~ list.map(j, f(k) ~ unlist(k)) %>% bind_rows()) %>%
    list_cbind() %>%
    mutate(ID2 = i$Patient$ID))

var_names2 <- c("Date of beginning", "Type", "Subtype", "Drug name",  paste(c("Initial", "Maximal", "Administrated"), "dose"), "Response", "Discontinuation", "Date of discontinuation", rep("Reason for discont.", 3))
l_var_names <- list.map(
    c("Pre-inclusion", paste("Ongoing at", c("V1", "V2")), "Post V2"),
    f(i) ~ rep(i, length(var_names2)) %>% paste(var_names2, sep = ".")
)
list_treat1 <- Reduce(bind_rows, list_treat0) %>%
    as_tibble() %>%
    select(., contains(c(var_names[c(1, 5)], l_var_names[[1]], "N previous treatment", var_names[2], l_var_names[[2]], var_names[c(3, 6)], l_var_names[[3]], var_names[4], l_var_names[[4]])))

if (!is.null(list_treat1[["Pre-inclusion.Reason for discont. (side effect(s))"]]))
list_treat1 <- relocate(list_treat1, "Pre-inclusion.Reason for discont. (side effect(s))", .before = "Patient.N previous treatment")
if (!is.null(list_treat1[["Ongoing at V1.Reason for discont. (side effect(s))"]]))
list_treat1 <- relocate(list_treat1, "Ongoing at V1.Reason for discont. (side effect(s))", .before = "Patient.Date of the 2nd visit")
if (!is.null(list_treat1[["Post V2.Reason for discont. (side effect(s))"]]))
list_treat1 <- relocate(list_treat1, "Post V2.Reason for discont. (side effect(s))", .after = last_col())

list_treat2 <- select(list_treat1, -ID2) %>% set_colnames(colnames(.) %>% str_remove_all("((Patient)|(Ongoing at ((V1)|(V2)))|(Pre-inclusion)|(Post V2))."))
write.xlsx(list_treat2, file = file.path(path_tsv, "still_treatments.xlsx"))
# use_data(list_treat2, overwrite = TRUE)

# (var_names0, var_names1[-1], "Dose", "Subtype")[c(1, 3, 2, 13, 9, 12, 10, 11, 5, 4, 6, 7, 8)]
list.map(list_treat00, f(i) ~ list.filter(i[["Ongoing at V1"]], f(j) ~ j$Type == "Biologic")) %>% compact()

# 0 doses !
# list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ if (is.list(j) && !is.null(j$`Administrated dose`) && str_detect(j$`Administrated dose`, "^0$")) TRUE) %>% compact()) %>% compact()

treat_types <- list.map(list_treat, f(i) ~ list.map(i, f(j) ~ j[names(j) == "Type"])) %>%
    unlist() %>%
    sort() %>%
    unique()
t_treat_types <- list.map(treat_types, f(i) ~ list.mapv(list_treat0, f(j) ~ i %in% j$`Ongoing at V1.Type`) %>% as.numeric()) %>% list.cbind()
apply(t_treat_types, 2, sum)

treat_subtypes <- list.map(list_treat, f(i) ~ list.map(i, f(j) ~ j[names(j) == "Subtype"])) %>%
    unlist() %>%
    sort() %>%
    unique()
t_treat_subtypes <- list.map(treat_subtypes, f(i) ~ list.mapv(list_treat0, f(j) ~ i %in% j$`Ongoing at V1.Subtype`) %>% as.numeric()) %>% list.cbind()
apply(t_treat_subtypes, 2, sum)

list.map(treat_types, f(i) ~ list.map(list_treat0, f(j) ~ {
    if (all(c("Ongoing at V1.Type", "Ongoing at V1.Drug name") %in% colnames(j))) {
        filter(j, `Ongoing at V1.Type` == i) %>%
            pull(`Ongoing at V1.Drug name`) %>%
            unique()
    } else {
        NULL
    }
}) %>%
    unlist() %>%
    factor() %>%
    fct_count())

l_drugs <- list.map(list_treat0, f(j) ~ if (all(c("Ongoing at V1.Drug name") %in% colnames(j))) pull(j, `Ongoing at V1.Drug name`)) %>%
    unlist() %>%
    unique() %>% na.omit()
t_drugs <- list.map(
    list_treat0, f(j) ~ {
        list.mapv(l_drugs, f(k) ~ (all(c("Ongoing at V1.Drug name") %in% colnames(j))) && (k %in% (pull(j, `Ongoing at V1.Drug name`))))
    } %>% as.numeric()
) %>%
    list.rbind() %>%
    set_colnames(l_drugs)
  
list.search(list_treat0, "Anakinra" %in% .) %>%
    list.match("Ongoing at V1") %>%
    length()
l_per_treat <- list.map(treat_types, f(i) ~ {
    l_drugs <- list.map(list_treat0, f(j) ~ if (all(c("Ongoing at V1.Type", "Ongoing at V1.Drug name") %in% colnames(j))) filter(j, `Ongoing at V1.Type` == i) %>% pull(`Ongoing at V1.Drug name`)) %>%
        unlist() %>%
        unique()
    list.map(
        list_treat0, f(j) ~ {
            list.mapv(l_drugs, f(k) ~ (all(c("Ongoing at V1.Type", "Ongoing at V1.Drug name") %in% colnames(j))) && (k %in% (filter(j, `Ongoing at V1.Type` == i) %>% pull(`Ongoing at V1.Drug name`))))
        } %>% as.numeric()
    ) %>%
        list.rbind() %>%
        set_colnames(l_drugs)
}) %>% compact()
list.map(l_per_treat, f(i) ~ apply(i, 2, sum))

l_per_bio_treat <- list.map(treat_subtypes, f(i) ~ {
    l_drugs <- list.map(list_treat0, f(j) ~ if (all(c("Ongoing at V1.Subtype", "Ongoing at V1.Drug name") %in% colnames(j))) filter(j, `Ongoing at V1.Subtype` == i) %>% pull(`Ongoing at V1.Drug name`)) %>%
        unlist() %>%
        unique()
    list.map(list_treat0, f(j) ~ {
        list.mapv(l_drugs, f(k) ~ (all(c("Ongoing at V1.Subtype", "Ongoing at V1.Drug name") %in% colnames(j))) && (k %in% (filter(j, `Ongoing at V1.Subtype` == i) %>% pull(`Ongoing at V1.Drug name`))))
    } %>% as.numeric()) %>%
        list.rbind() %>%
        set_colnames(l_drugs)
}) %>% compact()
# l_per_bio_treat[[2]]["20010", 2] <- 1
# l_per_bio_treat[[3]] <- l_per_bio_treat[[3]][, 1, drop = FALSE]
list.map(l_per_bio_treat, f(i) ~ apply(i, 2, sum))

still_treatment_post <- Reduce(cbind, c(list(t_treat_types), list(t_treat_subtypes), l_per_treat))
# use_data(still_treatment_post, overwrite = TRUE)

list.map(list_other, f(x) ~ list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) && j$`Drug name` == x) %>% list.map(f(k) ~ k$Type)) %>%
    compact() %>%
    unlist() %>%
    unique())

list.map(treat_types, f(k) ~ list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ is.list(j) && j$Type == k) %>% list.map(f(k) ~ k$`Drug name`)) %>%
    compact() %>%
    unlist() %>%
    unique()) %>% compact() -> tmp
if (length(tmp) == 10) {
    tmp[seq(5)] %>% get_intersection() # `Biologic:Corticosteroid` "Tocilizumab"
    tmp[-seq(5)] %>% get_intersection() # `DMARDs:Other` "Ciclosporine"
    tmp[c(seq(3), 9:10)] %>% get_intersection() # `Biologic:Other` "Cellcept"
    tmp[-c(seq(3), 9:10)] %>% get_intersection()
    tmp[c(3:5, 9:10)] %>% get_intersection()
    tmp[-c(3:5, 9:10)] %>% get_intersection()
}
if (length(tmp) < 8) {
    tmp[-seq(2)] %>% get_intersection()
    tmp[-c(3:4)] %>% get_intersection()
    tmp[-c(6:7)] %>% get_intersection()
}
# DMARDs:Other` "Methotrexate" "Ciclosporine"

list.map(list_treat, f(i) ~ list.map(i, f(j) ~ if (is.list(j) && !is.null(j$Subtype) && !(j$Subtype %in% c("Anti-CD20", "Anti-IL1", "Anti-IL17", "Anti-IL5", "Anti-IL6", "Anti-TNFÎ±"))) j$Subtype %>% set_names(j$`Date of beginning`)) %>% compact()) %>%
    compact() %>%
    unlist()

list.map(list_treat, f(i) ~ list.filter(i, f(j) ~ if (is.list(j) && j$Type == "Other" && j$`Drug name` %in% c("Anti-platelets aggregation", "Methotrexate", "Ciclosporine")) TRUE) %>%
    compact()) %>% compact()
list.map(list_treat, f(i) ~ list.map(i, f(j) ~ if (is.list(j) && j$Type == "Other" && j$`Drug name` %in% c("Anti-platelets aggregation", "Methotrexate", "Ciclosporine")) j$`Drug name` %>% set_names(j$`Date of beginning`)) %>% compact()) %>%
    compact() %>%
    unlist()

titles <- c("Treatment response", "Reason for discontinuation")
list.map(c("Response", "Reason for discont."), f(k, l) ~ list.map(treat_types, f(i) ~ list.map(list_treat0, f(j) ~ {
    if (all(c("Ongoing at V1.Type", paste0("Ongoing at V1.", k)) %in% colnames(j))) {
        filter(j, `Ongoing at V1.Type` == i) %>%
            pull(paste0("Ongoing at V1.", k)) %>%
            unique()
    } else {
        character(0)
    }
}) %>%
    list.map(f(i) ~ if (length(i) == 0) NA else i) %>%
    unlist() %>%
    tibble() %>%
    descriptive_mcat_immun(var = paste0(titles[l], " (", tolower(i), ")"), n = 38, wrap = 1000)) %>% list.rbind()) %>% list.rbind()

list.map(list_treat, f(i) ~ list.map(i, f(j) ~ if (is.list(j) && !is.null(j$`Type`) && is.null(j$`Drug name`)) TRUE) %>% compact()) %>%
    compact() %>%
    unlist() %>%
    names()

greens <- brewer_pal(, "YlGn")(9)[c(4, 5, 7, 9)]
cols <- c(1, get_colors()[c(4, 8, 7, 5, 9, 1)], greens[4], rev(greens))
tmp <- colnames(l_per_treat$Biphosphonate)
if (!is.null(tmp)) {
  l_per_treat$Biphosphonate <- l_per_treat$Biphosphonate[, which(!is.na(tmp))]
}
c(list(`Type of treatment` = t_treat_types), l_per_treat %>% purrr:::discard(str_detect(names(.), "Biologic|Other")), l_per_bio_treat[2], list(Biologic = t_treat_subtypes)) %>%
list.map(
    f(i, j, k) ~ {
        if (j == length(.)) {
            cols0 <- greens
        } else if (j == 7) {
            cols0 <- brewer_pal(, "Reds")(9)[c(3, 5, 7, 9)]
        } else if (j == 8) {
            cols0 <- greens[4]
        } else {
            cols0 <- cols[j]
        }
        if (j %in% c(3:5)) {
            colors <- cols0
        } else if (j == 1) {
            colors <- rev(get_colors()[c(1, 3, 4, 2, 5, 7:9)])
        } else {
            colors <- c("gray", cols0)
        }
        as.data.frame(i) %>%
            mutate(temp = 0) %>%
            plot_bar_mcat(
                title = k,
                cex = 8,
                ratio = 2,
                collapse = TRUE,
                wrap = 30,
                colors = colors,
                color_title = cols[j]
            )
    }
) -> p
  # c(.[c(1, 7, 9, 2, 8)], list(NULL), .[c(3:5)]) %>%

plot_bar_mcat(
    l_per_treat$Other,
    title = "Others",
    cex = 8,
    ratio = 3,
    collapse = TRUE,
    wrap = 30,
    colors =  c("gray", brewer_pal(, "Blues")(9)[c(3, 5, 7, 9)]),
    color_title = get_colors()[2]
) -> p2

plot_bar_mcat(
    t_drugs,
    title = "All drugs",
    cex = 8,
    ratio = 3,
    collapse = TRUE,
    wrap = 30,
    colors =  c(colorRampPalette(c("white", "black"))(11)[c(3, 5, 7, 9, 11)], rev(get_colors()[c(4, 1, 3, 5, 3, 7)]))
)
    plot_grid(
        plotlist = c(p[1], list(p2),  p[c(7, 9, 2, 8, 3:5)]),
        nrow = 3,
        ncol = 3,
        align = "v",
        rel_heights = c(1.5, 1.2, 0.8)
    )

```

```{r}
temp <- read.xlsx(file.path(path, "AOSD_SOJIA_Reponse_traitements.xlsx"), startRow = 2, cols = 3:8) %>% set_rownames(pull(., 1)) %>% set_colnames(c("id", "Corticosteroid", paste0("Anti-IL", c(1, 6)), "DMARDs", "Kinase Inhibitor"))
temp0 <- read.xlsx(file.path(path, "AOSD_SOJIA_Reponse_traitements.xlsx"), startRow = 2, cols = seq(2))
all_ids <- unlist(temp0) %>% unique() %>% na.omit()
emna_treat <- sapply(seq(2), function(i) as.numeric(all_ids %in% temp0[, i])) %>% data.frame() %>% set_colnames(paste0("with", c("out", ""), " treatment history")) %>% mutate(id = all_ids) %>% full_join(temp) %>% arrange(id) %>% set_rownames(pull(., id)) %>% select(-id) %>% mutate(Naive = `without treatment history` + `with treatment history`)
emna_treat[is.na(emna_treat)] <- 0
use_data(emna_treat, overwrite = TRUE)

df <- read.xlsx(file.path(path, "AOSD_SOJIA_Reponse_traitements.xlsx"), sheet = 3, startRow = 2, cols = seq(3)) %>% set_rownames(pull(., 1)) %>% set_colnames(c("id", "Corticosteroid","Anti-IL1"))
df2 <- read.xlsx(file.path(path, "AOSD_SOJIA_Reponse_traitements.xlsx"), sheet = 3, startRow = 2, cols = 7:8)
all_ids <- unlist(df2) %>% unique() %>% na.omit()
treat_v2 <- sapply(seq(2), function(i) as.numeric(all_ids %in% df2[, i])) %>% data.frame() %>% set_colnames(paste0("with", c("out", ""), " treatment history")) %>% mutate(id = all_ids) %>% full_join(df) %>% arrange(id) %>% set_rownames(pull(., id)) %>% select(-id) %>% mutate(Naive = `without treatment history` + `with treatment history`)
treat_v2[is.na(treat_v2)] <- 0
use_data(treat_v2, overwrite = TRUE)
```

# Session information
```{r end, echo = FALSE}
sessionInfo()
```
