---
title: "Manifestations"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Manifestations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(MultiOmics4ImmunAID)
```

# Load data
```{r, eval = FALSE}
clinic <- read_batches() %>%
    Reduce(rbind, .) %>%
    formate_immunaid()
clinic_code <- read_batches(, "codes")

var_na <- c(
    "null",
    "none",
    "none actually",
    "No sequelae",
    "No sequellea",
    "NO",
    "Unknown"
)
for (i in var_na) {
    clinic[clinic == i] <- NA
}
```

# Functions
```{r}
parse_manif0 <- function(x, y, z, a, b = NULL, type = 0, parse = FALSE) {
    x0 <- pull(x, column_code) %>%
        select(clinic, .) %>%
        set_rownames(ids)
    n <- ncol(x0)
    if (n > 0) {
          x0 %>%
              set_colnames(rep(seq(n), n / n)) %>%
              list.parse() %>%
              list.map(f(i, it) ~ {
                  temp <- list.map(
                      i,
                      f(j, jt) ~ {
                          j <- j %>%
                              str_remove_all(" \\(.+\\)") %>%
                              str_replace_all("CLINICAL EXAMINATION", "Clinical examination") %>%
                              str_replace_all("blood exams", "blood test") %>%
                              str_replace_all("physcial examination", "Clinically") %>%
                              str_replace_all("UVEITE ANTERIEURE", "Anterior uveitis") %>%
                              str_replace_all("MYALGI[AE]", "Myalgia") %>%
                              str_replace_all("rthralgie", "rthralgia") %>%
                              str_replace_all("rthrite", "rthritis") %>%
                              str_replace_all("(Artthralgie-myalgie)|(myalgia, arthralgia)|(Myalgia\\, arthralgia)|(Athralgia + myalgia)", "Arthralgia ; Myalgia") %>%
                              str_replace_all("pieds gauche", "Foot left") %>%
                              str_replace_all("the (lateral tibial plateau)", "\\1") %>%
                              str_replace_all(" Limb", " limb") %>%
                              str_replace_all("Thoracic Anterior", "Thoracic anterior") %>%
    str_replace_all("No [Ss]equell?[ae]{1,2}", "None") %>% 
                              str_remove_all("=.*") %>%
    # str_replace_all("(\\w)/(\\w)", "\\1; \\2") %>%
    str_replace_all(".*rayon main gauche", "Interphalangeal toe left") %>%
    str_replace_all("^I ", "Interphalangeal ") %>%
    str_replace_all("[Nn]o [Ss]equell?[ae]{1,2}", "None") %>%
                              str_replace_all("Arthralgia des bras", "Arthralgia") %>%
    str_replace_all("I p p 1er rayon main gauche", "Interphalangeal toe left") %>%
    str_replace_all("^I ", "Interphalangeal") %>%
    str_remove_all("((is)|(describes)) [at].*") %>%
                               str_remove_all(" – severe unremitting") %>%
                                str_replace_all(" weakness, e(ar pain)", " paralysis; E\\1") %>%
                              str_squish() %>%
                              to_title()
                          if (type == 1) {
                              j <- str_remove_all(j, "[\\[\\{\\}\\]\\\"]") %>%
                                  str_remove_all("x:\\d+(\\.\\d+)?,y:\\d+(\\.\\d+)?,pathId:") %>%
                                  str_replace_all("([A-Z])", " \\1") %>%
                                  str_squish() %>%
                                  str_split(", ") %>%
                                  pluck(1) %>%
                                  list.map(f(k) ~ if (is.na(k) | (length(k) == 1 && str_detect(k, ";"))) k else str_to_sentence(k)) %>%
                                  unlist() %>%
                                  paste0(collapse = " ; ")
                          }
                          if (type == 2) {
                              j <- str_to_sentence(j) %>% 
                                  str_replace_all(" gauche séquellaire.*", "; Cognitive impairment") %>%
    str_replace_all(" occurs together.*", "; Skin lesions") %>%
    str_replace_all(".*[Hh][ée]mipar[ée]si[es] ?.*", "Hemiparesis") %>%
    str_replace_all("Irritable", "Irritability") %>% 
    str_replace_all(".*[Mm]enin?git[ei]s?.*", "Menigitis") %>% 
    str_replace_all("Severe chest", "Chest pain") %>% 
    str_replace_all(".*bardet-biedl syndrome.*", "Bardet-Biedl syndrom; Polydactylia") %>%
    str_replace_all("(.*)?((Céphalées)|([Hh]eadache)|(Holo crânienne permanantes))( .*)?", "Headache")
                          }
                          if (type == 3) {
                              j <- ifelse(j == "Yes", pull(x, item_name)[jt], j)
                          }
                          if (type == 4) {
                              j <- str_split(j, "\\$\\$") %>% pluck(1)
                              if (length(j) > 1) {
                                    j <- j[2:1] %>% paste0(collapse = ": ")
                                }
                          }
                          if (type == 5 | parse) {
                              pattern <- " ((\\+)|(and)|(et)) "
                              if (!is.na(j) && str_detect(j, pattern)) {
                                    j <- str_split(j, pattern) %>%
                                        pluck(1) %>%
                                        str_squish() %>%
                                        to_title() %>%
                                        paste0(collapse = " ; ")
                                }
                              j <- str_remove_all(j, "\\.$")
                          }
                          str_split(j, " ?; ?") %>% 
                              list.map(~str_squish(.)) %>%
                              to_title() %>%
                              list(.) %>%
                              set_names(z)
                      }
                  ) %>% discard(function(x) all(is.na(x) | x == "NA"))
                  if (type == 3) {
                      temp <- purrr::discard(temp, function(x) str_detect(x, "No"))
                  }
                  if (!is.null(b)) {
                        temp <- list(temp) %>%
                            set_names(b) %>%
                            compact()
                    }
                  list(temp) %>%
                      set_names(a) %>%
                      compact() %>%
                      list(.) %>%
                      set_names(y) %>%
                      compact()
              }) %>%
              compact()
      }
}

parse_manif1 <- function(x, y, z, a, type = 0, parse = TRUE) {
    if (pull(x, repeat_inds) %>% purrr::discard(is.na) %>% length(.) > 0 && pull(x, repeat_inds) %>%
        str_detect("\\.") %>%
        any()) {
        n <- pull(x, repeat_inds) %>%
            str_split("\\.") %>%
            list.map(f(i) ~ pluck(i, 1)) %>%
            unlist() %>%
            max() %>%
            as.numeric()
        list.map(seq(n), f(i, j) ~ filter(x, str_detect(repeat_inds, paste0(i, "\\."))) %>% parse_manif0(y, z, a, j, type = type, parse = parse)) %>%
            compact() %>%
            Reduce(function(x, y) list.merge(x, y), .)
    } else {
        parse_manif0(x, y, z, a, type = type, parse = parse)
    }
}

parse_manif <- function(x, y, z, a, type = 0, parse = TRUE) {
    id <- unique(pull(x, item_id))
    if (length(id > 1)) {
        list.map(id, f(i) ~ filter(x, item_id == i) %>% parse_manif1(y, z, a, type = type, parse = parse)) %>%
            compact() %>%
            Reduce(function(x, y) list.merge(x, y), .)
    } else {
        parse_manif1(x, y, z, a, type = type, parse = parse)
    }
}
```

# Parsing
```{r}
vars <- c(
    "NEURO",
    "MUSCU",
    "CARDIO",
    "RENAL",
    "PULMO",
    "GASTRO",
    "ENT",
    "OPHTALMO",
    "URO",
    "HAEMATO"
)
var_names <- c(
    "is_active",
    "active_description",
    "non_active_description",
    "date_non_active",
    rep("diagnosis", 2)
)

# list.map(manifs, f(i) ~ {
#    list.map(c("MANIF", paste0("MANIF", c(paste0(c("_IS", "", "_NON"), "_ACTIVE"), "_NON_ACTIVE_DATE", "_DIAGNOSIS")), "OTHER_NEW_VALUE"), f(j) ~ {
#     temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(i), "Manif(Bloc|Activity|Workup)$"))) %>%
#         filter(str_detect(item_code, paste0("^IMA_", j, "$")))
#     select(clinic, temp$column_code) %>%
#         set_colnames(temp$item_name) %>%
#         clean_names() %>%
#         separate_semicolon()
#   }) %>% compact()
# }) -> tmp1

# filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title("MUSCU")))) %>%
#     filter(str_detect(item_code, "_LOCALISATION")) %>%
#     parse_manif("MUSCU", "localisation", "manif", type = 3)  %>% pluck("8002") %>% pluck("MUSCU")

ids <- pull(clinic, C_2643_3796) %>% as.integer()
list_manif <- ids %>%
    setNames(ids) %>%
    data.frame(id = .) %>%
    list.parse()
list_manif <- list.map(
    vars,
    f(x, y) ~ {
        list.map(
            c(paste0("MANIF", c(paste0(c("_IS", "", "_NON"), "_ACTIVE"), "_NON_ACTIVE_DATE", "_DIAGNOSIS")), "OTHER_NEW_VALUE"),
            f(i, j) ~ {
                clinic_code[[1]] %>%
                    filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "Manif(Bloc|Activity|Workup)$"))) %>%
                    filter(str_detect(item_code, paste0("^IMA_", i, "$"))) %>%
                    parse_manif(x, var_names[j], "manif")
            }
        ) %>%
            compact() %>%
            Reduce(function(x, y) list.merge(x, y), .)
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

# x <- "non_active_description"; list.map(tmp0, f(a) ~ list.map(a, f(b) ~ list.map(b$manif, f(d) ~ if(!is.null(d[[x]])) d[[x]] %>% compact()) %>% compact()) %>% compact()) %>% unlist() %>% unname() %>% unique()
#  x <- "diagnosis"; list.map(tmp0, f(a) ~ list.map(a, f(b) ~ list.map(b$manif, f(d) ~ list.map(d, f(e) ~ if(is.list(e) && !is.null(e[[x]])) e[[x]] %>% compact()) %>% compact()) %>% compact())%>% compact()) %>% unlist() %>% unique()

list_manif <- list.map(
    vars,
    f(x, y) ~ {
        clinic_code[[1]] %>%
            filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "ManifBloc$"))) %>%
            filter(str_detect(item_code, paste0("^IMA_", x, "_MANIF$"))) %>%
            parse_manif(x, "manif", "manif", type = 4)
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

# lapply(tmp, function(x) x %>% unlist() %>% unname() %>% unique())

list_manif <- list.map(
    c("LESION_IS_ACTIVE", "ACTIVE_LESIONS", "NON_ACTIVE_LESIONS"), f(i, j) ~ {
        filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_Mucocutaneous_manifestations"))) %>%
            filter(str_detect(item_code, paste0("^IMA_MUCO_", i, "$"))) %>%
            parse_manif("MUCO", var_names[j], "manif")
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)


list_manif <- filter(clinic_code[[1]], str_detect(item_code, "^IMA_MUSCU_MANIF_ACTIVE_OSTEISIS$")) %>%
    parse_manif("MUSCU", "active_description_osteitis", "manif") %>%
    list.merge(list_manif, .)

list_manif <- list.map(vars, f(i) ~ {
    list.map(seq(2), f(j) ~ {
        temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(i), "SequellaeBloc$")))
        if (j == 1) {
              temp <- filter(temp, str_detect(item_code, paste0("^IMA_", i, "_SEQUELLAE$")))
          } else {
              temp <- filter(temp, str_detect(item_code, paste0("^IMA_OTHER_NEW_VALUE$")))
          }
        parse_manif(temp, i, "sequellae", "sequellae", type = 5)
    }) %>%
        compact() %>%
        Reduce(function(x, y) list.merge(x, y), .)
}) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

# list.search(list_manif, str_detect(., "Sterility"))
sympt_names <- c("symptom", "frequency")
list_manif <- list.map(vars, f(i, it) ~ {
    list.map(paste0("_FIRST_QUESTION", c("", "_FREQ")), f(j, jt) ~ {
        temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(i), "FirstQuestionBloc$")))
        if (it == 8 && jt == 1) {
              type <- 3
          } else {
              type <- 0
          }
        if (it == 1) {
              temp <- filter(temp, str_detect(item_code, paste0("^IMA_MANIF_DESCRIPTION$")))
          } else {
              temp <- filter(temp, str_detect(item_code, paste0("^IMA_", i, j, "$")))
          }
        parse_manif(temp, i, sympt_names[jt], "symptom", type = type)
    }) %>%
        compact() %>%
        Reduce(function(x, y) list.merge(x, y), .)
}) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)


list_manif <- filter(clinic_code[[1]], str_detect(group_code, "^IMA_NeuroManifDescription$")) %>%
    parse_manif("NEURO", "symptom", "symptom", type = 2) %>%
    list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(group_code, "^IMA_RenalManifBloc$")) %>%
    parse_manif0("RENAL", "manif", "manif", type = 3) %>%
    list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(item_code, "^IMA_MANIF_DIAGNOSIS_DESCRIPTION$")) %>%
    parse_manif("MUSCU", "diag_description", "manif") %>%
    list.merge(list_manif, .)

list_manif <- list.map(
    c("CERVICAL_ADENITIS", "PAIN"),
    f(i, j) ~ {
        filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_HAEMATO_MANIF_", i, "$"))) %>%
            parse_manif("HAEMATO", str_to_lower(i), "manif")
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

list_manif <- list.map(
    c("PULM_HYP", "CHRO_CAR", "AMP", "ANEURYSM"),
    f(i, j) ~ {
        filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_CARDIO_SEQUELLAE_FOR_", i, "$"))) %>%
            parse_manif("CARDIO", str_to_lower(i), "sequellae")
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

var_names0 <- c("localisation_configuration", "localisation_number_lesion", "localisation_body_parts", "localisation_distribution", "localisation_symetry", "localisation_exposition", "localisation_other_signs", "localisation_disease_specific")
list_manif <- list.map(
    c(paste0("LESION_", c("CONF", "LOC_S_OR_M", "LOC_ON_BODY", "DISTRIBUTION_1", "DISTRIBUTION_2", "ON_SKIN", "OTHER_CLIN_SIGNS")), "DISEASE_SPEC_LESIONS"),
    f(i, j) ~ {
        filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_MUCO_", i, "$"))) %>%
            parse_manif("MUCO", var_names0[j], "manif")
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

# list.map(list_manif, f(i) ~ if(!is.null(i$NEURO)) i$NEURO) %>% compact()
# list.map(list_manif, f(i) ~ if(!is.null(i$NEURO$manif)) list.map(i$NEURO$manif, f(j) ~ j$manif) %>% compact()) %>% compact()
# list.map(list_manif, f(i) ~ if(!is.null(i$NEURO$manif)) list.map(i$NEURO$manif, f(j) ~ if(!is.null(j$manif) && str_detect(j$manif, "Cranial")) j$manif) %>% compact()) %>% compact()
# pluck(list_manif, "8002") %>% pluck("MUSCU")

list_manif <- list.map(
    vars,
    f(x, y) ~ {
        clinic_code[[1]] %>%
            filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "(Loc|Manif)"))) %>%
            filter(str_detect(item_code, paste0("^IMA_MANIF_LEFT_RIGHT_BILATERAL$"))) %>%
            parse_manif(x, "laterality", "manif")
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

list_manif <- list.map(
    vars,
    f(x, y) ~ {
        temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_", str_to_title(x)))) %>%
            filter(str_detect(item_code, "_LOCALISATION")) %>%
            filter(!str_detect(column_code, "C_2674_4001"))
        if (y == 2) {
              type <- 1
          } else if (y == 3) {
              type <- 4
          } else {
              type <- 0
          }
        parse_manif(temp, x, "localisation", "manif", type = type, parse = TRUE)
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)


list_manif <- filter(clinic_code[[1]], str_detect(column_code, "^C_2720_3885")) %>%
    parse_manif("HAEMATO", "localisation", "manif", type = 1) %>%
    list.merge(list_manif, .)

list_manif <- list.map(
    vars,
    f(x, y) ~ {
        clinic_code[[1]] %>%
            filter(str_detect(group_code, paste0("^IMA_", str_to_title(x), "Manif"))) %>%
            filter(str_detect(item_code, paste0("_TYPE|_TRANS|_DIF_INTER"))) %>%
            parse_manif(x, "type", "manif")
    }
) %>%
    compact() %>%
    Reduce(function(x, y) list.merge(x, y), .) %>%
    list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(group_code, "^IMA_EntSequellaeBloc$")) %>%
    filter(str_detect(item_code, paste0("^IMA_MANIF_LEFT_RIGHT_BILATERAL$"))) %>%
    parse_manif("ENT", "laterality", "sequellae") %>%
    list.merge(list_manif, .)

list_manif <- filter(clinic_code[[1]], str_detect(item_code, paste0("^IMA_OPHTALMO_SEQUELLAE_LEFT_RIGHT_BILATERAL_FOR"))) %>%
    parse_manif("OPHTALMO", "laterality", "sequellae") %>%
    list.merge(list_manif, .)
# use_data(list_manif, overwrite = TRUE)
```


```{r}
# id_osteo <- pull(clinic_osteo, C_2643_3796) %>%
#     as.numeric() %>%
#     as.character()
# list_manif0 <- list.filter(list_manif, id %in% id_osteo)
list_manif0 <- list_manif

get_manif <- function(x, y, z = "manif", pattern = ".*", l = list_manif0) {
    list.map(
        l,
        f(i) ~ list.map(
            i[[x]][[z]],
            f(j) ~ keep(j[[y]], str_detect(j[[y]], pattern))
        ) %>% compact()
    )
}

get_manif0 <- function(x, y, z = "manif", pattern = ".*", l = list_manif0) {
    list.map(
        l,
        f(i) ~ list.map(
            i[[x]]$manif,
            f(j) ~ list.map(
                j,
                f(k) ~ if (is.list(k)) keep(k[[y]], str_detect(k[[y]], pattern)) %>% compact()
            ) %>% compact()
        ) %>% compact()
    )
}

get_occ_list <- function(x, fx = function(x) x) {
    unlist(x) %>%
        fx() %>%
        sort() %>%
        unique() %>%
        sort() %>%
        list.map(f(i) ~ list.map(x, f(j) ~ unlist(j) %>%
            fx() %>%
            str_detect(i) %>%
            any() %>%
            as.numeric())) %>%
        list_cbind0()
}
```

# Plot
```{r}
list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif0, f(i) ~ names(i[[x]])) %>%
    compact() %>%
    unlist() %>%
    unique()) %>% compact()
list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif0, f(i) ~ list.map(i[[x]]$manif, f(j) ~ list.map(j, f(k) ~ names(k)) %>% compact()) %>% compact()) %>%
    compact() %>%
    unlist() %>%
    unique()) %>% compact()

(l_manifs <- list.map(vars, f(x) ~ get_manif(x, "manif") %>% get_occ_list()) %>% compact())
list.map(l_manifs, f(x) ~ apply(x, 2, function(i) sum(i, na.rm = TRUE)))

list.map(list_manif0, f(i) ~ list.map(i[["MUCO"]]$manif, f(j) ~ names(j))) %>%
    compact() %>%
    unlist() %>%
    unique() -> ids
var_names1 <- c("Active manifestation", "Affected body parts", "Specific disease", "Configuration", "Other signs", "Non-active manifestation")
l_muco <- list.map(ids, f(i, j) ~ get_manif("MUCO", i) %>%
    get_occ_list(fx = function(x) str_remove_all(x, " describes.*$") %>% str_remove_all(" is.*$")))
colnames(l_muco$localisation_body_parts) <- str_replace_all(colnames(l_muco$localisation_body_parts), "(.*) =.*", "\\1")
# list.map(l_muco, f(i, j) ~ plot_bar_mcat(i, collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio = 5, title = var_names1[j])) -> p
# plot_grid(
#     plotlist = c(p[c(2, 4, 1, 3, 5:8, 11, 9:10)]),
#     nrow = 4,
#     ncol = 3,
#     # labels = "AUTO",
#     rel_heights = c(1.5, 1, 1, 0.8)
# )
names(l_muco) %in% c("active_description", "localisation_body_parts", "localisation_disease_specific", "localisation_configuration", "localisation_other_signs", "non_active_description") %>% l_muco[.] %>%
    list.map(
        f(i, j) ~ {
            plot_bar_mcat(
                i,
                collapse = TRUE,
                cex = 8,
                wrap = 30,
                n = 100,
                ratio = 5,
                title = var_names1[j]
            )
        }
    ) -> p
plot_grid(
    plotlist = list.sort(p, nrow(.$data)) %>% rev(),
    align = "hv",
    nrow = 3,
    ncol = 2,
    rel_heights = c(1.5, 1, 0.55)
)
  
titles <- c("Active manifestation", "Number of lesion", "Distribution", "Symetry", "Exposition")
names(l_muco) %in% c("is_active", "localisation_number_lesion", "localisation_distribution", "localisation_symetry", "localisation_exposition") %>% l_muco[.] %>% lapply(. %>% mutate(., `NA` = rowSums(.) %>% `==`(0) %>% as.numeric())) %>%
    list.map(
        f(i, j) ~ {
            plot_piechart(
                i,
                cex = 30,
                dec = 1,
                hsize = 1.5,
                colour = get_colors()[c(3, 3, 1)],
                title = titles[j],
                label = FALSE,
                top = -1,
                wrap = 30
            )
        }
    ) %>% 
    plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 3,
        ncol = 2
    )
            

t_muco <- Reduce(cbind, l_muco)
colnames(t_muco)[c(1:2)] <- c("Non active", "Active")
apply(t_muco, 2, sum) %>% `>`(2) %>% apply(t_muco, 2, sum)[.]
use_data(t_muco, overwrite = TRUE)

t_muco_manif <- get_manif("MUCO", "active_description") %>%
    get_occ_list() %>%
    apply(1, function(x) any(x == 1) %>% as.numeric()) %>%
    data.frame(Mucocutaneous = .)
t_local <- get_manif("MUSCU", "localisation") %>%
    get_occ_list(
        fx = function(x) {
            str_replace_all(x, "(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>%
                str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>%
                str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>%
                str_replace_all("clavicular", "Elbow") %>%
                str_replace_all("Knees", "Knee") %>%
                str_replace_all("(femoral)|(tibia)", "Inferior limb") %>%
                str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>%
                str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>%
                str_squish()
        }
    ) %>%
    select(-contains("Skull"))

x <- "CARDIO"
list.map(list_manif0, f(i) ~ list.map(i[[x]]$manif, f(j) ~ names(j))) %>%
    compact() %>%
    unlist() %>%
    unique() %>%
    purrr:::discard(function(x) str_detect(x, "\\d")) -> ids
# l_manif <- list.map(ids, f(i, j, k) ~ get_manif(x, i) %>% get_occ_list())
l_manif <- list.map(ids, f(i, j, k) ~ get_manif(x, i) %>%
    get_occ_list(
        fx = function(x) {
            str_replace_all(x, "(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>%
                str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>%
                str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>%
                str_replace_all("clavicular", "Elbow") %>%
                str_replace_all("Knees", "Knee") %>%
                str_replace_all("(femoral)|(tibia)", "Inferior limb") %>%
                str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>%
                str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>%
                str_squish()
        }
    ) %>%
    select(-contains("Skull")))

y <- "manif"
l_manif <- list.map(list_manif0, f(i) ~ list.map(i[[x]][[y]], f(j) ~ names(j))) %>%
    compact() %>%
    unlist() %>%
    unique() %>%
    list.map(f(i, j, k) ~ get_manif(x, i, y) %>%
        get_occ_list())

titles <- c("Localisation", "Manifestation") %>% rev()
names(l_manif) %in% c("localisation", "manif") %>% l_manif[.] %>%
    list.map(
        f(i, j) ~ {
            plot_bar_mcat(
                i,
                collapse = TRUE,
                cex = 8,
                wrap = 20,
                ratio = 5,
                title = titles[j]
            )
        }
    ) -> p


get_manif0(x, "diagnosis") %>%
    get_occ_list(fx = function(x) str_replace_all(x, "(Clinical )?[Ee]xamination", "Clinically")) %>%
    plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio = 5, title = "Diagnosis") -> p2

get_manif0(x, "laterality") %>%
    get_occ_list() %>% 
    plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio = 5, title = "Laterality") -> p3

get_manif(x, "sequellae", "sequellae") %>% get_occ_list() %>% plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 30, ratio = 5, title = "Sequellae") -> p3

# get_manif(x, "sequellae", "sequellae")  %>% compact() %>% unlist() %>% unname() %>% sort()

get_manif0(x, "diagnosis") %>%
    get_occ_list() %>%
    select(-c("Examination", "Clinical examination")) %>%
    plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio = 5, title = "Diagnosis")

list(p[[1]], p[[2]], p2, p3) %>% list.sort(nrow(.$data)) %>% rev() %>%
    plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 2,
        ncol = 2,
        rel_heights = c(1.5, 1)
    )

titles <- c("Is active?", "Chronicity", "N. of manifestation")
names(l_manif) %in% c("is_active", "active_description", "type", "non_active_description") %>% l_manif[.] %>% lapply(. %>% mutate(., `NA` = rowSums(.) %>% `==`(0) %>% as.numeric())) %>%
    list.map(
        f(i, j, k) ~ {
            if (k == "type"){
                colour = get_colors()[c(1, 3, 3)]
            } else if (k == "active_description") {
                colour = brewer_pal(, "Reds")(9)[c(9, 3, 6, 3)]
            } else {
                colour = get_colors()[c(3, 3, 1)]
            }
            plot_piechart(
                i,
                cex = 25,
                dec = 1,
                hsize = 1.5,
                colour = colour,
                title = titles[j],
                label = FALSE,
                top = -1.5,
                wrap_title = 15,
                wrap = 30
            )
        }
    ) %>%  
    plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 1,
        ncol = 2
    )

list.map(
    l_manif,
     f(i, j, k) ~ {
         set_colnames(i, colnames(i) %>% str_remove(" active")) %>%
             plot_bar_mcat(
                 collapse = TRUE,
                   wrap = 20,
                 ratio = 5,
                 title = str_replace_all(k, "_", " ") %>% str_to_sentence()
             )
         }
     ) -> p
plot_grid(
    plotlist = list.sort(c(p$localisation, p), nrow(.$data)) %>% rev(),
    align = "hv",
    nrow = 3,
    ncol = 3,
    rel_heights = c(1.5, 0.55, 0.55)
)

t_muscu <- l_manif$active_description_osteitis %>% apply(1, function(x) any(x == 1) %>% as.numeric()) %>% data.frame(`Active osteitis` = .) %>% list() %>% c(l_manif[2:4]) %>% Reduce(cbind, .)
use_data(t_muscu, overwrite = TRUE)

x <- "NEURO"
y <- "symptom"
list.map(list_manif0, f(i) ~ list.map(i[[x]][[y]], f(j) ~ names(j))) %>%
    compact() %>%
    unlist() %>%
    unique() %>%
    list.map(f(i, j, k) ~ get_manif(x, i, y) %>%
        get_occ_list() %>%
        plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio = 5, title = str_replace_all(k, "_", " ") %>% str_to_sentence())) %>%
    plot_grid(
        plotlist = .,
        nrow = 2,
        ncol = 1
    )

get_manif0(x, "diagnosis") %>%
    get_occ_list() %>%
    plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 100, ratio = 2, title = "Diagnosis")

list.map(list_manif0, f(i) ~ list.map(i[["MUSCU"]]$manif, f(j) ~ j$localisation)) %>%
    unlist() %>%
    str_replace_all("(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>%
    str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>%
    str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>%
    str_replace_all("clavicular", "Elbow") %>%
    str_replace_all("Knees", "Knee") %>%
    str_replace_all("(femoral)|(tibia)", "Inferior limb") %>%
    str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>%
    str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>%
    str_squish() %>%
    unique() %>%
    sort()

get_manif("MUSCU", "localisation") %>%
    get_occ_list(
        fx = function(x) {
            str_replace_all(x, "(.*interphalangeal.*)|(Metacarpophalangeal.*)|(Hands)|(Wrist)|(I p p 1er rayon main gauche)", "Hand") %>%
                str_replace_all("(Metatarsophalangeal.*)|(Ankle)", "Foot") %>%
                str_replace_all("(Pubis)|(Hip)|(Sacroiliac)", "Pelvis") %>%
                str_replace_all("clavicular", "Elbow") %>%
                str_replace_all("Knees", "Knee") %>%
                str_replace_all("(femoral)|(tibia)", "Inferior limb") %>%
                str_replace_all("(Lumbar column)|(Cervical column)|(Thoracic column)", "Spine") %>%
                str_remove_all("(right)|(left)|(Lateral)|(l plateau)|(joint)|(Acromio)|(Sterno)") %>%
                str_squish()
        }
    ) %>%
    plot_bar_mcat(collapse = TRUE, cex = 8, wrap = 20, n = 2, ratio = 2, title = "Localisation") -> p3

plot_grid(
    plotlist = list(p[[3]], NULL, p3, p2),
    nrow = 2,
    ncol = 2
)

get_manif("MUSCU", "active_description_osteitis") %>% get_occ_list() %>% set_colnames(colnames(.) %>% str_remove(" active")) %>% plot_bar_mcat(collapse = TRUE, cex = 10, wrap = 20, n = 2, ratio = 2, title = "Is active ?", colors = brewer.pal(9, "Set2")[5:6])

get_manif("MUSCU", "localisation") %>%
    get_occ_list() %>%
    count_cat(collapse = TRUE, wrap = 1000)

get_manif("MUSCU", "sequellae", "sequellae") %>% get_occ_list() %>% plot_bar_mcat(title = "Sequellae", collapse = TRUE, cex = 10, wrap = 20, ratio = 2)

get_manif("MUSCU", "active_description") %>% get_occ_list() %>% plot_piechart(colour = brewer_pal(, "Reds")(9)[c(9, 3, 6)], dec = 1, cex = 20, hsize = 1.6, label = FALSE, title = "Chronicity")

# manifs <- list.map(list_manif, f(i) ~names(i)) %>% unlist() %>% unique()
list.map(c("manif", "symptom", "sequellae"), f(z) ~ {
    list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif, f(i) ~ list.map(i[[x]][[z]], f(j) ~ names(j))) %>% compact()) %>%
        unlist() %>%
        unique() %>%
        purrr:::discard(function(x) str_detect(x, "\\d")) %>%
        list.map(f(x) ~ list.map(vars, f(y) ~ get_manif(y, x, z, l = list_manif)) %>%
            compact() %>%
            unlist() %>%
            unique() %>%
            sort()) %>%
        compact()
})

# list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif, f(i) ~ names(i[[x]])) %>% compact()) %>% compact() %>% unlist() %>% unique()
ids <- list.map(c(vars, "MUCO"), f(x) ~ list.map(list_manif, f(i) ~ list.map(i[[x]]$manif, f(j) ~ list.map(j, f(k) ~ names(k)) %>% compact()) %>% compact()) %>% compact()) %>%
    compact() %>%
    unlist() %>%
    unique()
list.map(ids, f(x) ~ list.map(vars, f(y) ~ get_manif0(y, x, l = list_manif)) %>%
    compact() %>%
    unlist() %>%
    unique() %>%
    sort()) %>% compact()
# use_data(list_manif, overwrite = TRUE)
```

```{r}
vars0 <- clinic_code[[3]] %>%
    filter(str_detect(group_code, "IMA_ImpactedOrganOrSysTab"))
vars1 <- vars0 %>%
    pull(item_name) %>%
    str_replace("(\\d{1,2}. )", "") %>%
    str_replace("\\s*\\([^\\)]+\\)", "")
manifs <- c("MUSCU", "CARDIO", "GASTRO", "HAEMATO")
# If all disease
# manifs <- c(manifs, "OPHTALMO", "OPHTALMO", "ENT")
# (PULMO) NEURO, URO
# vars <- vars1[c(1, 3:4, 7, 9, 9, 8, 11)]
vars <- vars1[c(1, 3:4, 7, 11)]
manifs <- c("MUCO_ACTIVE_LESIONS", paste0(manifs, "_MANIF"))

filter(clinic, str_detect(C_2643_3796, c("20011", "06027", "06009", "24003", "26103") %>%  paste0("^", ., "$", collapse = "|") )) %>% mutate(C_2643_3797 = str_remove_all(C_2643_3797, "\\d{2} - ")) %>% select(metadata$column_code) %>% set_colnames(str_remove_all(metadata$item_name, "\\(.+\\)")) %>% select(2:6, 1)  %>% mutate(Manifestation = c("Neurological", "Musculoskeletal", rep("Gastro-intestinal", 3))) %>% relocate(Manifestation) %>% kable0()

# plot_piechart(tmp1$MUSCU$MANIF_ACTIVE, colour = brewer_pal(, "Reds")(9)[c(3, 9, 6)], dec = 1, cex = 20, hsize = 1.6, label = FALSE, title = "Chronicity")
# plot_piechart(tmp0[[1]][[2]], colour = get_colors()[c(1, 3)], dec = 1, cex = 20, hsize = 1.6, label = FALSE, title = "Is Active?")
# plot_piechart(tmp0[[5]][[2]], colour = get_colors(), dec = 1, cex = 20, hsize = 1.6, label = FALSE, title = "Diagnostic", wrap = 20) -> p
# plot_bar_mcat(cex = 12, ratio = 2, title = "Is active ?", collapse = TRUE, colors = c(brewer.pal(8, "Set2")[5:6]))

list.map(manifs, f(i, j, k) ~ {
    tmp <- immu_manif(i, df2 = clinic)
    if (!is.null(nrow(tmp))) {
          plot_bar_mcat(tmp, cex = 8, ratio = 4, title = vars1[j], collapse = TRUE)
      }
}) %>% compact() -> p
align_plots(plotlist = p[c(3, 1)]) %>%
    plot_grid(
        plotlist = .,
        nrow = 2,
        ncol = 1,
        # labels = "AUTO",
        rel_heights = c(1.5, 1)
    )
temp <- filter(clinic_code[[1]], str_detect(group_code, paste0("^IMA_ImpactedOrganOrSysTab$")))
df_manifs0 <- select(clinic, temp$column_code) %>%
    list.map(f(i) ~ as.factor(i) %>%
        fct_recode(`0` = "No", `1` = "Yes", `NA` = "Unknown") %>%
        as.character() %>%
        as.numeric()) %>%
    list_cbind() %>%
    set_colnames(vars1) %>%
    set_rownames(pull(clinic, "C_2643_3796"))

apply(df_manifs0, 2, function(x) sum(x, na.rm = TRUE)) %>%
    as.data.frame() %>%
    set_colnames(c("N")) %>%
    kable0()

df_manifs <- list.map(manifs, f(i) ~ {
    immu_manif(i, df2 = clinic)
})
# df_manifs[[2]] <- df_manifs[[2]][, seq(3)]

list.map(
    df_manifs0, 
    f(i, j, k) ~ {
        plot_piechart(
            i,
            colour = get_colors()[c(1, 3)],
            cex = 22,
            dec = 1,
            hsize = 1.5,
            title = k,
            label = FALSE,
            top = -1
        )
    }) %>% 
    plot_grid(
        plotlist = .,
        align = "hv",
        nrow = 3,
        ncol = 4
    )

# Table
ids <- pull(clinic, 2) %>% as.numeric()
still_manif <- df_manifs %>%
    list.cbind() %>%
    set_colnames(colnames(.) %>% str_remove_all(" \\(.+\\)")) %>%
    as_tibble() %>%
    mutate(ids = ids) %>%
    arrange(ids) %>%
    select(-ids) %>%
    set_rownames(ids) %>%
    cbind(df_manifs0, .)
use_data(still_manif, overwrite = TRUE)
apply(still_manif, 2, sum) %>% kable0()

p <- list.map(df_manifs, f(i, j) ~ {
    plot_bar_mcat(i, cex = 12, ratio = 3, title = vars[j])
})
align_plots(plotlist = p, align = "vh") %>%
    plot_grid(
        plotlist = .,
        nrow = 3,
        ncol = 2,
        # labels = "AUTO",
        rel_heights = c(1.7, 1, 1)
    )
# ((colSums(temp0) / nrow(temp0)) * 100) %>% round(1)
# align_plots(plotlist = c(p2[-1], p2[1])) %>% plot_grid(plotlist = ., align = "vh", nrow = 4, ncol = 2, labels = LETTERS, rel_heights = c(rep(1, 3), 1.5))
vars <- vars0 %>%
    pull(column_code)
# vars <- filter(attributes(clinic_tot)$codes, str_detect(codes, vars)) %>% pull(name)
list.map(
    vars,
    f(i, j) ~ plot_piechart(
        clinic_osteo %>% pull(i),
        label = FALSE,
        cex = 20,
        dec = 1,
        # legend = TRUE,
        colour = get_colors()[c(1, 3)],
        threshold = 5,
        title = vars1[j],
        hsize = 1.5
    )
) %>%
    plot_grid(
        align = "vh",
        plotlist = .,
        nrow = 3,
        ncol = 4
    )
```
