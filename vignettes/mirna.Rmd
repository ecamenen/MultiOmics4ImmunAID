---
title: "miRNA"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{mirna}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include = FALSE}
suppressPackageStartupMessages(library(MultiOmics4ImmunAID))
path <- set_environment()
options("tidylog.display" = list())
# options("tidylog.display" = NULL)

# Get the file parameters
name <- "CPM_miRNACounts"
date <- "20221019"
path_data <- file.path(path, "miRNA")
files_all <- list.files(path_data)
pattern <- str_detect(files_all, name)
```

# Metadata
```{r, echo = FALSE}
# Metadata
metadata <- file.path(path_data, files_all[!pattern]) %>% read_excel()

# Samples
# Sample in common
# Visit A
l_metadata <- list.parse(metadata)
l_metadata_A <- list.filter(l_metadata, Visit == "A") %>% list.group(Cell_type)
l_metadata_A_names <- l_metadata_A %>%
    list.map(. %>>% list.mapv(Patient_Id)) %>%
    list.map(f(., i) ~ as.numeric(.) %>% sort())
# Venn(l_metadata_A_names) %>%
#     process_region_data() %>%
#     pull(item)
# plot_venn1(l_metadata_A_names, cex = 1.25, color = get_colors()[c(3, 5, 1, 2)])
# Visit B
l_metadata_B <- list.filter(l_metadata, Visit == "B") %>% list.group(Cell_type)
l_metadata_B_names <- l_metadata_B %>%
    list.map(. %>>% list.mapv(Patient_Id)) %>%
    list.map(f(., i) ~ as.numeric(.) %>% sort())
# plot_venn1(l_metadata_B_names, cex = 1.25, color = get_colors()[c(3, 5, 1, 2)])
# Both visit
# list(l_metadata_A_names, l_metadata_B_names) %>%
#     list.map(unlist(.) %>% unique(.)) %>%
#     set_names(paste(c("1rst", "2nd"), "visit")) %>%
#     plot_venn1(n = 6, color = brewer.pal(9, "Paired")[7:8], vjust = 0) +
#     scale_x_continuous(expand = c(1, 0)) +
#     scale_y_continuous(expand = c(1, 0))

# Samples per visit
fct_count(metadata$Visit) %>%
    set_colnames(c("Visit", "N")) %>%
    kable0()
plot_piechart(
    metadata$Visit,
    colour = brewer.pal(9, "Paired")[7:8],
    cex = 40,
    title = "",
    hsize = 1.6,
    label = FALSE,
    dec = 1
)
# Number of cell types
fct_count(metadata$Cell_type) %>%
    set_colnames(c("Cell type", "N")) %>%
    kable0()
plot_piechart(
    metadata$Cell_type,
    colour = brewer.pal(9, "Set1")[c(seq(3), 5)],
    cex = 40,
    title = "",
    hsize = 1.6,
    label = FALSE,
    dec = 1
)

# Dates
dates <- dmy(metadata$Date_of_experiment) %>% tibble(date = .)
dates <- mutate(
    dates,
    year = year(date),
    month = month(date, label = TRUE, abbr = FALSE),
    day = day(date)
)
days <- as.factor(dates$date) %>%
    fct_count() %>%
    mutate(f = as.Date(f)) %>%
    arrange(f)
ggplot(days, aes(f, n)) +
    geom_line(color = "red") +
    geom_point(color = "red") +
    theme_minimal() +
    scale_x_date(date_breaks = "1 month", date_labels = "%Y (%b)") +
    ylab("Nb. samples") +
    xlab("")

# Samples per years
as.factor(dates$year) %>%
    fct_count() %>%
    set_colnames(c("Year", "N")) %>%
    kable0()
# Sample per months
# lapply(unique(dates$year), function(i) {
#     dates[dates$year == i, ] %>%
#         pull(month) %>%
#         as.factor() %>%
#         fct_drop() %>%
#         fct_count()
# })
format(dates$date, "%Y-%m") %>%
    fct_count() %>%
    mutate(f = ym(f)) %>%
    mutate(year = year(f), month = format(f, "%B")) %>%
    select(month, n) %>%
    set_colnames(str_to_title(colnames(.))) %>%
    kable0("r") %>%
    pack_rows("2021", 1, 1) %>%
    pack_rows("2022 (N = 595)", 2, 6)
# format(dates$date, "%Y-%m") %>%
#     fct_count() %>%
#     mutate(f = ym(f)) %>%
#     ggplot(aes(f, n)) +
#     geom_line(color = "red") +
#     geom_point(color = "red") +
#     theme_minimal() +
#     scale_x_date(date_breaks = "1 month", date_labels = "%Y (%b)") +
#     ylab("Nb. samples") +
#     xlab("")
```

# Demographic effects
```{r, echo = FALSE}
# Subset in common with miRNA data
ids <- metadata$Patient_Id %>%
    unique() %>%
    as.numeric() %>%
    sort()
length(ids)
data(clinic)
clinic_intersect <- filter(
    clinic_transf,
    str_detect(
        immun_aid_identifier,
        paste0("^", ids, "$", collapse = "|")
    )
)

# Descriptive stats
vars <- c("BMI", "age_at_inclusion_time")
keys <- c(6, 5)
list.map(as.list(vars), f(j, i) ~ {
    plot_violin0(
        pull(clinic_intersect, vars[i]),
        brewer.pal(8, "Set2")[keys[i]],
        size = 3,
        title = ""
    )
}) %>%
    plot_grid(
        plotlist = .,
        align = "vh",
        ncol = 2
    )
clinic_intersect %>%
    select(all_of(vars)) %>%
    descriptive_stats() %>%
    kable0()

# Age
df_years <- mutate(
    clinic_intersect,
    years = cut(
        age_at_inclusion_time,
        breaks = seq(0, 90, 10),
        right = FALSE
    )
) %>% drop_na(gender)
df_year_gender <- as.list(levels(clinic_intersect$gender)) %>%
    list.map(f(i) ~ {
        fct_count(subset(df_years, gender == i)$years) %>%
            mutate(perc = (n / sum(n) * 100) %>% round(1), Gender = i)
    })
df_year_gender[[1]]$n <- -df_year_gender[[1]]$n
df_year_gender <- list.stack(df_year_gender)
df_year_gender <- df_years$years %>%
    fct_count() %>%
    right_join(df_year_gender, by = "f")
# Age pyramid
ggplot(df_year_gender, aes(x = n.y, y = f, fill = Gender)) +
    geom_col(width = 0.95, alpha = 0.75) +
    geom_text(
        aes(label = ifelse(Gender == "Male", n.x, "")),
        hjust = -1,
        color = "gray",
        size = 5
    ) +
    theme_minimal(base_family = "Verdana", base_size = 18) +
    scale_fill_manual(values = c("#3438a7", "#38bcbd")) +
    scale_x_continuous(
        name = "Count",
        labels = abs,
        expand = c(0.1, 0)
    ) +
    scale_y_discrete(
        name = "Age (decades)",
        labels = function(x) {
              str_remove_all(x, "\\[|\\)") %>% str_replace_all(",", "-")
          }
    )

# Gender, ethnicity
plot_piechart(
    clinic_intersect$patient_ethnicity,
    colour = c("#af3e40", "#eaaab0", "gray80"),
    title = "",
    cex = 40,
    dec = 1,
    label = FALSE,
    hsize = 1.6
)
plot_piechart(
    drop_na(clinic_intersect, gender) %>% pull(gender),
    colour = c("#3438a7", "#38bcbd"),
    cex = 40,
    title = "",
    hsize = 1.6,
    label = FALSE,
    dec = 1
)

# Disease, clinical_center

plot_bar_mcat(clinic_intersect$disease, cex = 3, wrap = 50)
plot_bar_mcat(clinic_intersect$clinical_center, cex = 3, wrap = 50)
```
