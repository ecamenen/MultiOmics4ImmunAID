---
title: "descriptive_stats"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{descriptive_stats}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
    collapse = TRUE,
    comment = "#>"
)
```

```{r setup}
library(MultiOmics4ImmunAID)
library(magrittr)
library(janitor)
library(tidyverse)
library(readxl)
library(skimr)
library(DataExplorer)
library(dlookr)
library(reshape2)
library(naniar)
library(VIM)
library(lubridate)
library(corrplot)
path <- file.path(golem::get_golem_wd(), "inst", "extdata")
```

```{r utils}
clean_data <- function(x, clean_name = TRUE, row_number = 1) {
    if (clean_name) {
          x <- clean_names(x)
      }
    x %>%
        remove_empty(c("rows", "cols"), quiet = FALSE) %>%
        remove_constant(na.rm = TRUE, quiet = FALSE)
}
```

# Proteomics

## ELISA

```{r elisa}
# prot_path <- file.path(path, "ELISA/Batch1")
batch <- 1
date <- "20211116"
prefix <- paste(date, "Data", "", sep = "_")
blocks <- c("Calprotectin", "S100A12")
files_raw <- list()

# Read files
for (i in seq_along(blocks)) {
    files_raw[[i]] <- read_excel(
        file.path(
            path,
            "ELISA/Batch1",
            paste0(prefix, blocks[i], "_batch_", batch, ".xlsx")
        ),
        skip = 5
    )
}
# Clean colnames, remove empty rows, cols and constants
files <- lapply(files_raw, clean_data)
# Common IDs ?
setdiff(files[[1]][, 1], files[[2]][, 1]) # character(0) = Nope !
# Bind tables
elisa <- cbind(files[[1]], files[[2]][, 4, drop = FALSE]) %>% tibble()
colnames(elisa)[4:5] <- blocks

# Set constants into the attributes
for (i in 4:5) {
    var <- colnames(files_raw[[1]])[i]
    attributes(elisa)[var] <- unique(files_raw[[1]][, var])
}

# Convert into types
str(elisa)
elisa$patient_id <- as.character(elisa$patient_id)
elisa$visit <- factor(elisa$visit)

# View factor
diagnose_category(
    elisa[, -c(1:2)],
    top = 500
)
# %>% filter(is.na(levels))
# %>% filter(ratio <= 0.01)

# elisa %>% count(visit)  %>% mutate(freq = n / sum(n))
# elisa %>% count(patient_id, sort = TRUE)  %>% mutate(freq = n / sum(n))

diagnose_numeric(elisa) # %>% filter(minus > 0 | zero > 0)
# View duplicates
elisa %>% get_dupes("patient_id")

# Descriptive stats general
plot_str(elisa)
introduce(elisa)
plot_intro(elisa)
diagnose(elisa) %>%
    filter(missing_count > 0) %>%
    arrange(desc(missing_count))

# Descriptive stats per variables
# qplot(Calprotectin, data = elisa)
plot_bar(elisa)
plot_histogram(elisa)
# plot_boxplot(elisa)
skim(elisa)

elisa_melt <- melt(elisa)
ggplot(elisa_melt, aes(x = variable, y = value, color = variable)) +
    geom_violin(trim = FALSE, draw_quantiles = c(0.25, 0.5, 0.75)) +
    scale_y_log10() +
    theme_bw() +
    guides(color = "none") +
    xlab("") +
    ylab("")

# str_squish

# Correlation
plot_correlation(elisa)
plot_correlation(elisa, type = "c") # continuous data
get_correlation <- function(x, threshold = 0.5, half = TRUE) {
  y <- correlate(x) %>%
      filter(abs(coef_corr) > threshold)
  if(half)
    y %>% filter(as.integer(var1) > as.integer(var2))
  else
    y
}
get_correlation(elisa)
plot_correlate(elisa)

# Normality
plot_qq(elisa)
# Do not follow the normality with Shapiro-Wilk
(not_normal <- normality(elisa) %>% filter(p_value <= 0.01) %>% arrange(abs(p_value)))
plot_normality(not_normal)

# Missing data
# set_missing
plot_missing(elisa)
find_na(elisa)
# impute_na(elisa)

# Outliers
find_outliers(elisa) # wich variables
diagnose_outlier(elisa) %>% filter(outliers_ratio > 0)
plot_outlier(elisa)
elisa_w_out <- elisa
for (i in find_outliers(elisa)) {
    var <- colnames(elisa)[i]
    elisa_w_out[var] <- imputate_outlier(elisa, var, method = "mean")
}

# PCA
pca_df <- na.omit(elisa[, 4:5])
plot_prcomp(pca_df, nrow = 2, ncol = 2)

# eda_report(elisa)
```

# Clinic

```{r clinic}
# Extract items
date <- "20220512"
clin_path <- file.path(path, "clinical", "20220501")
files_raw <- list.files(clin_path)
files_code <- files_raw[grepl("codes", files_raw)]
files_export <- files_raw[grepl("export", files_raw)]
files <- str_split(files_export, "_")
(blocks <- unique(sapply(files, function(i) i[2])))
```

## Clinical

```{r clinical}
clin_export <- files_export[grepl("Clinical", files_export)]
clin_code <- files_code[grepl("Clinical", files_code)]
k <- 3

read_batches <- function(files, export = "export") {
    batches <- list()
    for (i in seq_along(files)) {
        batches[[i]] <- read_tsv(file.path(
            clin_path,
            paste0(
                "ImmunAID_",
                blocks[k],
                "_",
                date,
                "_batch",
                i,
                "_eCRF_",
                export,
                ".csv"
            )
        ))
    }
    return(batches)
}
clinic <- read_batches(clin_export)
sapply(clinic, dim)

clinic_tot <- Reduce(rbind, clinic)

clinic_code <- read_batches(clin_code, "codes")

# Common subject ID between batches
vars <- lapply(clinic, function(i) as.numeric(as.data.frame(i[, 2])[, 1]))
# vars <- lapply(clinic_code, function(i) as.data.frame(i[, 1])[, 1])
names(vars) <- seq(3)
venn::venn(vars, ilabels = TRUE, zcolor = "style")

get_intersection <- function(x) {
    res <- gplots::venn(x)
    intersections <- attributes(res)$intersections
    intersections[grepl(":", names(intersections))]
}
get_intersection(vars)

# Common subject ID with ELISA
vars_clin <- sort(as.numeric(unlist(vars)))
vars_elisa <- sort(as.numeric(as.data.frame(elisa[, 2])[, 1]))
vars_tot <- list(Clinic = vars_clin, ELISA = vars_elisa)
vars_tot2 <- c(vars, list(ELISA = vars_elisa))
venn::venn(vars_tot, ilabels = TRUE, zcolor = "style") # all included in clinic data
venn::venn(vars_tot2, ilabels = TRUE, zcolor = "style") # all from clinic batch 1
get_intersection(vars_tot)

# Missing data
# set_missing
clinic_tot <- clean_data(clinic_tot, FALSE)
find_na(clinic_tot)

best_na_percent <- function(x, threshold = 50) {
    (df_na <- diagnose(x) %>% filter(missing_percent > threshold) %>% arrange(desc(missing_percent)))
    var_na <- data.frame(df_na %>% select(variables))[, 1]
    x %>% select(-one_of(var_na))
}
clinic_tot_proc <- best_na_percent(clinic_tot, 3)
plot_missing(
    clinic_tot_proc,
    geom_label_args = list(
        label.size = NA,
        label.padding = unit(0, "lines"),
        size = 3
    )
)

gg_miss_var(clinic_tot)
vis_miss(clinic_tot_proc)
clinic_code_proc <- clean_data(clinic_code[[1]])
# vis_miss(clinic_code_proc)
# vis_miss(best_na_percent(clinic_tot_proc, 0))
res <- summary(aggr(clinic_tot, sortVar = TRUE))$combinations
# impute_na(elisa)

# Categorical variables
# group_name
# The top bottom by frequency
diagnose_category(clinic_code_proc[, "group_name", drop = FALSE], top = 100) %>% arrange(freq)
# Select the clinic data with 0 NA
var_na <- colnames(clinic_tot_proc)
# Look at the metadata in codes
(stats <- clinic_code_proc %>%
    filter(clinic_code_proc$column_code %in% var_na) %>%
    select(!(starts_with("repeat"))))

(stats %>% filter(str_detect(column_code, paste0(c(var_na), collapse = "|"))))$item_name

diagnose_category(as.data.frame(stats$group_name))
# Which is the frequence of this category
clinic_code_proc[, "group_name", drop = FALSE] %>%
    diagnose_category(top = 100) %>%
    filter(str_detect(levels, paste0(unique(stats$group_name), collapse = "|")))
# What are the most frequent modalities for each variable
plot_bar(clinic_tot_proc)
# Create country variable
clinic_tot_proc %>%
    mutate(country = case_when(
        str_detect(C_2643_3797, "Paris|Bordeaux|Nantes|Lyon|Lille|Strasbourg") ~ "France",
        str_detect(C_2643_3797, "Madrid|Barcelona") ~ "Spain",
        str_detect(C_2643_3797, "Leuven") ~ "Belgium",
        str_detect(C_2643_3797, "Rotterdam") ~ "Netherlands",
        str_detect(C_2643_3797, "Athens") ~ "Greece",
        str_detect(C_2643_3797, "Roma") ~ "Italy",
        str_detect(C_2643_3797, "Geneva") ~ "Switzerland",
        str_detect(C_2643_3797, "Ankara") ~ "Turkey",
        str_detect(C_2643_3797, "Münster|Berlin") ~ "Germany",
        str_detect(C_2643_3797, "Leeds") ~ "United Kingdom (UK)",
        str_detect(C_2643_3797, "Lubljana") ~ "Slovenia",
        TRUE ~ C_2643_3797
    )) %>%
    select(country) %>%
    plot_bar()

# By French centers
clinic_tot_proc %>%
    filter(str_detect(C_2643_3797, "Paris|Bordeaux|Nantes|Lyon|Lille|Strasbourg")) %>%
    select(C_2643_3797) %>%
    plot_bar()

# By French cities
clinic_tot_proc %>%
    mutate(town = case_when(
        str_detect(C_2643_3797, "Paris") ~ "Paris",
        str_detect(C_2643_3797, "Bordeaux") ~ "Bordeaux",
        str_detect(C_2643_3797, "Nantes") ~ "Nantes",
        str_detect(C_2643_3797, "Lyon") ~ "Lyon",
        str_detect(C_2643_3797, "Lille") ~ "Lille",
        str_detect(C_2643_3797, "Strasbourg") ~ "Strasbourg",
        TRUE ~ "Others"
    )) %>%
    select(town) %>%
    plot_bar()

# %>% diagnose_category()

# Date
var_dates <- c("C_2643_3800", "C_2643_3801", "C_2643_3802")
clinic_tot_proc <- update_columns(clinic_tot_proc, var_dates[1], my)
clinic_tot_proc <- update_columns(clinic_tot_proc, var_dates[-1], dmy)
for (i in var_dates) {
      qplot(as.data.frame(clinic_tot_proc[, i])[, 1])
  }

clin_proc_year <- update_columns(clinic_tot_proc, var_dates, function(i) year(round_date(i, "year")))
plot_histogram(clin_proc_year)

# ggplot(clin_proc_year, aes())
clin_melt <- melt(clinic_tot_proc)
ggplot(clin_melt, aes(x = variable, y = value, color = variable)) +
    geom_violin(trim = FALSE, draw_quantiles = c(0.25, 0.5, 0.75)) +
    geom_dotplot(binaxis = "y", stackdir = "center", alpha = .1, color = "gray", drop = TRUE, width = .5) + 
    facet_wrap(~variable, scale = "free") +
    theme_bw() +
    guides(color = "none", fill = "none") +
    xlab("") +
    ylab("")+ theme(axis.text.x = element_blank(), axis.ticks.x = element_blank())

ggplot(clin_melt, aes(x = variable, y = value, fill = variable, color = variable)) +
geom_violindot(trim = FALSE, draw_quantiles = c(0.25, 0.5, 0.75), binwidth = 2) +
facet_wrap(~variable, scale = "free") +
theme_bw() +
guides(color = "none", fill = "none", x = "none") +
xlab("") +
ylab("")

for (i in var_dates) {
    y <- as.data.frame(as.character(as.data.frame(clin_proc_year[, i])[, 1]))
    diagnose_category(y, top = 100) %>% arrange(freq)
}

# Age in decades
decade <- as.data.frame(as.character(as.data.frame(clin_proc_year[, "C_2643_3800"] - clin_proc_year[, "C_2643_3800"] %% 10)[, 1]))
diagnose_category(decade, top = 100) %>%
    arrange(levels) %>%
    select(-variables)
qplot(decade[, 1])
qplot(as.character(2020 - as.numeric(decade[, 1])))

# Correlation
get_correlation(clinic_tot_proc)
M <- get_correlation(clinic_tot_proc, 0, FALSE) %>% dcast(var1 ~ var2)
p.mat <-
  sapply(colnames(clinic_tot_proc), function(x)
    sapply(colnames(clinic_tot_proc), function(y) {
      if (is.numeric(x) &
          is.numeric(y)) {
        cor.test(x, y, data = clinic_tot_proc)$p.value
      } else{
        NA
      })
col <- colorRampPalette(c("#BB4444", "#EE9988", "#FFFFFF", "#77AADD", "#4477AA"))
corrplot(M, method="color", col=col(200),  
         type="upper", order="hclust", 
         addCoef.col = "black", # Ajout du coefficient de corrélation
         tl.col="black", tl.srt=45, #Rotation des etiquettes de textes
         # Combiner avec le niveau de significativité
         p.mat = p.mat, sig.level = 0.01, insig = "blank", 
         # Cacher les coefficients de corrélation sur la diagonale
         diag=FALSE 
         )
```

## PedsQL
```{r pedsql}
# Extract items
peds_files <- files[grepl("PedsQL", files)]
batch <- unique(sapply(peds_files, function(i) { i[5] }))
max(gsub("batch(\\d)", "\\1", batch))
peds_files <- peds_files[grepl("batch1", peds_files)]
ql <- unique(sapply(peds_files, function(i) { i[2] }))
(ql <- sort(as.numeric(gsub("PedsQL(\\d+)", "\\1", ql))))
years <- unique(sapply(peds_files, function(i) { i[3] }))
(years <- sort(as.numeric(gsub("(\\d+)years", "\\1", years))))
```

## Session information
```{r end, echo = FALSE}
sessionInfo()
```
