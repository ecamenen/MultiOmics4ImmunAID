---
title: "QC"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{QC}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library("tidyverse")
```

```{r}
library(plotly)
c("qc", "fastp", "kallisto")
seq(4)
type <- "fastp"
cwd <- file.path(golem::get_golem_wd(), "inst", "extdata", type)
files <- list.files(file.path(cwd, "4"), pattern = "mqc_")
batch <- 4

get_qc <- function(x, batch = 4, type = "line", plot = TRUE) {
  qc <<- read_tsv(file.path(cwd, batch, files[x])) %>%
  mutate(Sample = str_remove_all(Sample, "(_001$)|(\\d{2}PB1)|(\\-1_S\\d*)|( \\- nextera_transposase_sequence)")) %>%
  column_to_rownames("Sample")

  if (type == "line") {
    p <- as.matrix(qc) %>% melt() %>%
        ggplot(aes(x = Var2, y = value, color = Var1, group = Var1)) + # color = I("gray50")
        geom_line() +
        labs(x = "", y = "", color = "Sequence") +
        theme_minimal() + theme(legend.position = "none")
  } else {
    sum_col <- rowSums(qc)
    p <- as.data.frame(lapply(qc, function(qc) qc / sum_col)) %>%
    cbind(Sample = rownames(qc), .) %>%
    gather(Categories, Percent, -Sample) %>%
        mutate(Percent = Percent * 100) %>%
        ggplot(aes(x = Sample, y = Percent, fill = Categories)) +
            geom_bar(position = "stack", stat = "identity") +
            labs(x = NULL, y = "# Reads", fill = NULL) +
            theme_minimal() +
            coord_flip() + 
            theme(legend.position = "bottom") +
            scale_fill_manual(values = get_colors())
  }
  if (plot)
    ggplotly(p)
  else
    return(p)
}

p <- list()
stats <- list()

# Adaptater
get_qc(1, batch)
stats[[1]] <- apply(qc, 1, max)
print_stats0(stats[[1]], dec = 2)
p[[4]] <- plot_violin0(stats[[1]], colour = get_colors()[1], title = "Adaptaters %", pch_colour = "gray20", pch_alpha = 0.5)

# N
get_qc(3, batch)
stats[[2]] <- apply(qc, 1, sum)
print_stats0(stats[[2]], dec = 2)
p[[3]] <- plot_violin0(stats[[2]], colour = get_colors()[2], title = "Unknown bases %", pch_colour = "gray20", pch_alpha = 0.5)

# Phred
get_qc(4, batch)
stats[[3]] <- apply(qc, 1, median)
print_stats0(stats[[3]], dec = 2)
p[[1]] <- plot_violin0(stats[[3]], colour = get_colors()[3], title = "Phred median", pch_colour = "gray20", pch_alpha = 0.5)

# GC
get_qc(4, batch)
r1 <- qc
get_qc(6, batch)
rownames(qc) <- str_replace_all(rownames(qc), "1$", "2")
qc <- rbind(r1, qc)
as.matrix(qc) %>% melt() %>%
        ggplot(aes(x = Var2, y = value, color = Var1, group = Var1)) + # color = I("gray50")
        geom_line() +
        labs(x = "", y = "", color = "Sequence") +
        theme_minimal() + theme(legend.position = "none") + 
    labs(x = "Position in read (bp)", y = "% GC") +
    ylim(0, 100) +
    theme(
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "gray85"),
        axis.text = element_text(
            size = 15,
            color = "gray40"
        ),
        axis.title = element_text(
            size = 15,
            color = "gray40"
        )
) +
  scale_color_manual(values = rep("gray", nrow(qc))) +
  geom_line(data = data.frame(Var2 = seq_along(qc), Var1 = apply(qc, 2, median)), aes(x = Var2, y = Var1), color = I("red"), size = 1, inherit.aes = FALSE)
stats[[4]] <- apply(qc, 1, median)
print_stats0(stats[[4]], dec = 2)
p[[2]] <- plot_violin0(stats[[4]], colour = get_colors()[4], title = "GC %", pch_colour = "gray20", pch_alpha = 0.5)
x = "var" ; data.frame(var = stats[[4]]) %>% select(!!sym(x)) %>% arrange(desc(!!sym(x))) %>% tail(10)

# get_qc(6, batch)
# apply(qc, 1, function(x) colnames(qc)[which.max(x)] %>% as.double) %>% median()

# qc0 <- read_tsv(file.path(cwd, batch, "multiqc_fastqc.txt")) %>% column_to_rownames(colnames(.)[1])
qc0 <- read_tsv(file.path(cwd, batch, "multiqc_general_stats.txt")) %>%
  mutate(Sample = str_remove_all(Sample, "(filtered_)|(_001$)|(\\d{2}PB1)|(\\-1_S\\d*)")) %>%
  column_to_rownames("Sample") %>%
set_colnames(colnames(.) %>% str_remove_all("((FastQC)|(fastp)|(Kallisto))_mqc\\-generalstats\\-((fast((qc)|p))|kallisto)\\-") %>% str_replace_all("_", " ") %>% str_replace_all("(pct)|(percent)", "%")%>% str_replace_all("gc", "GC") %>% str_remove_all("after filtering ") %>% to_title())
if (type == "fastp") {
  qc0 <- rename(
    qc0,
    `Passed` = `Filtering result passed filter reads`,
    `% > Q30` = `Q30 rate`,
    `Mb Q30 bases` = `Q30 bases`
  ) %>%
    mutate(
     `% > Q30` = `% > Q30` * 100,
      `Mb Q30 bases` = `Mb Q30 bases` * 1e-6,
      `Gc content` = `GC content` * 100,
      Passed = Passed * 1e-6
    )
  p[[7]] <- pull(qc0, `% duplication`) %>% plot_violin0(colour = get_colors()[5], title = "Duplicates %", pch_colour = "gray20", pch_alpha = 0.5)
} else if (type == "qc") {
  qc0 <- mutate(
    qc0,
    `Total sequences` = `Total sequences` * 1e-6
    )
  p[[5]] <- pull(qc0, `% duplicates`) %>% plot_violin0(colour = get_colors()[5], title = "Duplicates %", pch_colour = "gray20", pch_alpha = 0.5)
}
# label_number(suffix = "M", scale = 1e-6, accuracy = 1, big.mark = ",")(pull(qc0, `Q30 bases`))
qc0 %>% select(get_name_num(.)) %>% formatting_descriptive_num()
# p[[4]] <- pull(qc0, `% gc`) %>% plot_violin0(colour = get_colors()[4], title = "GC %", pch_colour = "gray20", pch_alpha = 0.5)

x = "% duplication"
select(qc0, !!sym(x)) %>% arrange(desc(!!sym(x))) %>% filter(!!sym(x) > 60)

# kallisto
get_qc(1, batch, type = "bar")
qc0 <- filter(qc0, `% aligned` > 0)
p[[6]] <- pull(qc0, `% aligned`) %>% plot_violin0(colour = get_colors()[8], title = "Alignment %", pch_colour = "gray20", pch_alpha = 0.5)

plot_grid(
    plotlist = p,
    nrow = 1,
    ncol = 6,
    align = "vh"
)
```

